<%- include('../partials/header') %>

<div class="bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900 text-white min-h-screen">
    <!-- Header -->
    <div class="relative py-16 px-4">
        <div class="max-w-4xl mx-auto text-center">
            <div class="mb-8">
                <i class="ra ra-heart text-6xl text-red-400 mb-4 block"></i>
                <h1 class="text-5xl font-bold mb-4 font-display">
                    Soutenez brumisater
                </h1>
                <p class="text-xl text-purple-200 max-w-2xl mx-auto leading-relaxed">
                    Aidez-nous à développer de nouveaux outils pour la communauté JDR française et accédez à des fonctionnalités Premium exclusives !
                </p>
            </div>
        </div>
    </div>

    <!-- Contenu principal -->
    <div class="max-w-6xl mx-auto px-4 pb-16" x-data="supportPage()">
        
        <!-- Avantages Premium -->
        <div class="mb-16">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold mb-4">Devenez Premium dès 1€</h2>
                <p class="text-purple-200 text-lg">
                    Un petit don suffit pour nous soutenir et débloquer des avantages exclusifs
                </p>
            </div>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Gratuit -->
                <div class="bg-gray-900/50 backdrop-blur-sm rounded-lg p-6 border border-purple-500/20">
                    <div class="text-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-300 mb-2">Gratuit</h3>
                        <div class="text-3xl font-bold text-gray-400 mb-1">0€</div>
                        <p class="text-sm text-gray-400">Toujours</p>
                    </div>
                    
                    <ul class="space-y-3 mb-6">
                        <li class="flex items-center text-sm">
                            <i class="ra ra-check text-green-400 mr-3"></i>
                            5 fiches de personnage
                        </li>
                        <li class="flex items-center text-sm">
                            <i class="ra ra-check text-green-400 mr-3"></i>
                            Génération PDF basique
                        </li>
                        <li class="flex items-center text-sm">
                            <i class="ra ra-check text-green-400 mr-3"></i>
                            3 systèmes JDR disponibles
                        </li>
                        <li class="flex items-center text-sm">
                            <i class="ra ra-check text-green-400 mr-3"></i>
                            Accès anonyme limité
                        </li>
                    </ul>
                </div>

                <!-- Premium -->
                <div class="bg-gradient-to-br from-yellow-400 to-orange-500 text-gray-900 rounded-lg p-6 border-4 border-yellow-300 relative">
                    <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
                        <span class="bg-yellow-300 text-gray-900 px-4 py-1 rounded-full text-xs font-bold">
                            POPULAIRE
                        </span>
                    </div>
                    
                    <div class="text-center mb-6">
                        <h3 class="text-xl font-semibold mb-2">Premium</h3>
                        <div class="text-3xl font-bold mb-1">1€+</div>
                        <p class="text-sm opacity-75">Don unique</p>
                    </div>
                    
                    <ul class="space-y-3 mb-6">
                        <li class="flex items-center text-sm">
                            <i class="ra ra-check mr-3"></i>
                            <strong>Fiches illimitées</strong>
                        </li>
                        <li class="flex items-center text-sm">
                            <i class="ra ra-check mr-3"></i>
                            <strong>Pieds de page personnalisés</strong>
                        </li>
                        <li class="flex items-center text-sm">
                            <i class="ra ra-check mr-3"></i>
                            <strong>Tous les systèmes JDR</strong>
                        </li>
                        <li class="flex items-center text-sm">
                            <i class="ra ra-check mr-3"></i>
                            <strong>Oracles exclusifs</strong>
                        </li>
                        <li class="flex items-center text-sm">
                            <i class="ra ra-check mr-3"></i>
                            <strong>Demandes de fonctionnalités</strong>
                        </li>
                        <li class="flex items-center text-sm">
                            <i class="ra ra-check mr-3"></i>
                            Support prioritaire
                        </li>
                    </ul>
                    
                    <button 
                        @click="openDonationModal()"
                        :disabled="!stripeDisponible"
                        class="w-full bg-gray-900 hover:bg-gray-800 disabled:bg-gray-600 disabled:cursor-not-allowed text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                        <span x-show="stripeDisponible">Faire un don</span>
                        <span x-show="!stripeDisponible">Bientôt disponible</span>
                    </button>
                </div>

                <!-- Donateur VIP -->
                <div class="bg-gray-900/50 backdrop-blur-sm rounded-lg p-6 border border-purple-500/20">
                    <div class="text-center mb-6">
                        <h3 class="text-xl font-semibold text-purple-300 mb-2">Donateur VIP</h3>
                        <div class="text-3xl font-bold text-purple-400 mb-1">10€+</div>
                        <p class="text-sm text-gray-400">Don unique</p>
                    </div>
                    
                    <ul class="space-y-3 mb-6">
                        <li class="flex items-center text-sm">
                            <i class="ra ra-check text-purple-400 mr-3"></i>
                            Tout Premium +
                        </li>
                        <li class="flex items-center text-sm">
                            <i class="ra ra-crown text-purple-400 mr-3"></i>
                            Badge VIP sur le profil
                        </li>
                        <li class="flex items-center text-sm">
                            <i class="ra ra-crown text-purple-400 mr-3"></i>
                            Accès bêta anticipé
                        </li>
                        <li class="flex items-center text-sm">
                            <i class="ra ra-crown text-purple-400 mr-3"></i>
                            Influence sur la roadmap
                        </li>
                        <li class="flex items-center text-sm">
                            <i class="ra ra-crown text-purple-400 mr-3"></i>
                            Mention dans les crédits
                        </li>
                    </ul>
                    
                    <button 
                        @click="openDonationModal(10)"
                        :disabled="!stripeDisponible"
                        class="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                        <span x-show="stripeDisponible">Devenir VIP</span>
                        <span x-show="!stripeDisponible">Bientôt disponible</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Pourquoi nous soutenir -->
        <div class="mb-16">
            <div class="bg-gray-900/50 backdrop-blur-sm rounded-lg p-8 border border-purple-500/20">
                <h2 class="text-2xl font-bold mb-6 text-center">Pourquoi soutenir brumisater ?</h2>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="ra ra-gear mr-3 text-purple-400"></i>
                            Développement continu
                        </h3>
                        <ul class="space-y-2 text-purple-200">
                            <li class="flex items-start">
                                <i class="ra ra-plus text-purple-400 mr-2 mt-1 text-xs"></i>
                                Nouveaux systèmes JDR régulièrement
                            </li>
                            <li class="flex items-start">
                                <i class="ra ra-plus text-purple-400 mr-2 mt-1 text-xs"></i>
                                Amélioration des templates PDF
                            </li>
                            <li class="flex items-start">
                                <i class="ra ra-plus text-purple-400 mr-2 mt-1 text-xs"></i>
                                Nouvelles fonctionnalités demandées
                            </li>
                        </ul>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="ra ra-server mr-3 text-purple-400"></i>
                            Infrastructure & maintenance
                        </h3>
                        <ul class="space-y-2 text-purple-200">
                            <li class="flex items-start">
                                <i class="ra ra-plus text-purple-400 mr-2 mt-1 text-xs"></i>
                                Hébergement serveur fiable
                            </li>
                            <li class="flex items-start">
                                <i class="ra ra-plus text-purple-400 mr-2 mt-1 text-xs"></i>
                                Sauvegardes automatiques
                            </li>
                            <li class="flex items-start">
                                <i class="ra ra-plus text-purple-400 mr-2 mt-1 text-xs"></i>
                                Support technique
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section remerciements -->
        <div class="text-center">
            <h2 class="text-2xl font-bold mb-4">Merci pour votre soutien !</h2>
            <p class="text-purple-200 mb-8 max-w-2xl mx-auto">
                Chaque don, même petit, nous aide à maintenir ce service gratuit pour la communauté 
                et à développer de nouveaux outils pour vos parties de JDR.
            </p>
            
            <div class="flex flex-wrap justify-center gap-4">
                <button 
                    @click="openDonationModal(1)"
                    :disabled="!stripeDisponible"
                    class="bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    <i class="ra ra-coin mr-2"></i>
                    1€ - Café
                </button>
                <button 
                    @click="openDonationModal(5)"
                    :disabled="!stripeDisponible"
                    class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    <i class="ra ra-pizza mr-2"></i>
                    5€ - Pizza
                </button>
                <button 
                    @click="openDonationModal(10)"
                    :disabled="!stripeDisponible"
                    class="bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    <i class="ra ra-crown mr-2"></i>
                    10€ - VIP
                </button>
                <button 
                    @click="openDonationModal()"
                    :disabled="!stripeDisponible"
                    class="bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    <i class="ra ra-heart mr-2"></i>
                    Montant libre
                </button>
            </div>
            
            <!-- Message si Stripe non disponible -->
            <div x-show="!stripeDisponible" class="mt-4 text-center">
                <p class="text-purple-300 text-sm">
                    💡 Le système de dons est en cours de configuration. Vous pouvez nous contacter directement pour soutenir le projet.
                </p>
            </div>
        </div>

        <!-- Modal de don -->
        <div x-show="showDonationModal" 
             x-cloak 
             class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"
             @click.self="closeDonationModal()">
            <div class="bg-gray-900 rounded-lg max-w-md w-full p-6 border border-purple-500/30">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">Faire un don</h3>
                    <button @click="closeDonationModal()" class="text-gray-400 hover:text-white" aria-label="Fermer la fenêtre de don">
                        <i class="ra ra-cancel"></i>
                    </button>
                </div>
                
                <!-- Formulaire de don -->
                <form @submit.prevent="processDonation()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-purple-300 mb-2">
                            Montant (€)
                        </label>
                        <input 
                            x-model="donationAmount"
                            type="number" 
                            min="1" 
                            step="0.01"
                            required
                            class="w-full px-4 py-3 bg-gray-800 border border-purple-500/30 rounded-lg text-white focus:border-purple-400 focus:outline-none">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-purple-300 mb-2">
                            Votre email (pour recevoir le Premium)
                        </label>
                        <input 
                            x-model="donationEmail"
                            type="email" 
                            required
                            class="w-full px-4 py-3 bg-gray-800 border border-purple-500/30 rounded-lg text-white focus:border-purple-400 focus:outline-none">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-purple-300 mb-2">
                            Message (optionnel)
                        </label>
                        <textarea 
                            x-model="donationMessage"
                            rows="3"
                            class="w-full px-4 py-3 bg-gray-800 border border-purple-500/30 rounded-lg text-white focus:border-purple-400 focus:outline-none resize-none"></textarea>
                    </div>
                    
                    <button 
                        type="submit"
                        :disabled="processing"
                        class="w-full bg-yellow-500 hover:bg-yellow-600 disabled:bg-gray-700 text-gray-900 font-bold py-3 px-4 rounded-lg transition-colors">
                        <span x-show="!processing">
                            <i class="ra ra-credit-card mr-2"></i>
                            Payer avec Stripe
                        </span>
                        <span x-show="processing" class="flex items-center justify-center">
                            <i class="ra ra-spinning-swords animate-spin mr-2"></i>
                            Redirection...
                        </span>
                    </button>
                </form>
                
                <p class="text-xs text-gray-400 mt-4 text-center">
                    Paiement sécurisé par Stripe. Vos données ne sont pas stockées sur nos serveurs.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
function supportPage() {
    return {
        showDonationModal: false,
        donationAmount: 5,
        donationEmail: '',
        donationMessage: '',
        processing: false,
        stripeDisponible: true, // Sera vérifié à l'init
        
        async init() {
            // Vérifier si Stripe est disponible
            await this.verifierStripeDisponible();
        },
        
        async verifierStripeDisponible() {
            try {
                const response = await fetch('/api/donations/status', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                this.stripeDisponible = response.ok;
            } catch (error) {
                this.stripeDisponible = false;
            }
        },
        
        openDonationModal(amount = null) {
            if (!this.stripeDisponible) {
                Alpine.store('app').ajouterMessage(
                    'Le système de dons est temporairement indisponible',
                    'info'
                );
                return;
            }
            
            if (amount) {
                this.donationAmount = amount;
            }
            
            // Pré-remplir l'email si l'utilisateur est connecté
            const utilisateur = Alpine.store('app')?.utilisateur;
            if (utilisateur?.email) {
                this.donationEmail = utilisateur.email;
            }
            
            this.showDonationModal = true;
        },
        
        closeDonationModal() {
            this.showDonationModal = false;
            this.processing = false;
        },
        
        async processDonation() {
            if (this.processing) return;
            
            this.processing = true;
            
            try {
                const response = await Alpine.store('app').requeteApi('/donations/create-payment-intent', {
                    method: 'POST',
                    body: JSON.stringify({
                        amount: Math.round(this.donationAmount * 100), // Centimes
                        email: this.donationEmail,
                        message: this.donationMessage
                    })
                });
                
                if (response.succes && response.donnees.url) {
                    // Redirection vers Stripe Checkout
                    window.location.href = response.donnees.url;
                } else {
                    throw new Error(response.message || 'Erreur lors de la création du paiement');
                }
                
            } catch (error) {
                console.error('Erreur paiement:', error);
                Alpine.store('app').ajouterMessage(
                    'Erreur lors de la création du paiement : ' + error.message,
                    'erreur'
                );
                this.processing = false;
            }
        }
    };
}
</script>

<%- include('../partials/footer') %>