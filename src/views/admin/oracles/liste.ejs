<%- contentFor('body') %>

<!-- Page d'administration des oracles -->
<div class="min-h-screen bg-gray-50">
    <!-- Navigation admin -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-xl font-bold text-red-800 hover:text-red-700">
                        <i class="ra ra-dice-five mr-2"></i>
                        brumisater
                    </a>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                    <a href="/admin" class="text-gray-600 hover:text-red-600">Admin</a>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                    <span class="text-gray-800">Oracles</span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">Admin: <%= utilisateur.nom %></span>
                    <a href="/deconnexion" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Contenu principal -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- En-tête de page -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">
                    <i class="ra ra-crystal-ball mr-3 text-purple-600"></i>
                    Administration des Oracles
                </h1>
                <p class="text-gray-600 mt-2">
                    Gérez les oracles, leurs éléments et leurs statistiques d'utilisation.
                </p>
            </div>
            
            <div class="flex space-x-3">
                <button onclick="ouvrirModalCreation()" 
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    Nouvel Oracle
                </button>
                
                <button onclick="ouvrirModalImport()" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-upload mr-2"></i>
                    Import CSV/JSON
                </button>
                
                <a href="/admin/oracles/imports" 
                   class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-history mr-2"></i>
                    Historique
                </a>
            </div>
        </div>

        <!-- Statistiques rapides -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="ra ra-crystal-ball text-2xl text-purple-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Total Oracles</p>
                        <p class="text-2xl font-semibold text-gray-900"><%= pagination.total %></p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-list text-2xl text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Éléments Totaux</p>
                        <p class="text-2xl font-semibold text-gray-900">
                            <%= oracles.reduce((sum, oracle) => sum + (oracle.total_items || 0), 0) %>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-dice text-2xl text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Tirages Total</p>
                        <p class="text-2xl font-semibold text-gray-900">
                            <%= oracles.reduce((sum, oracle) => sum + (oracle.total_draws || 0), 0) %>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-crown text-2xl text-yellow-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Oracles Premium</p>
                        <p class="text-2xl font-semibold text-gray-900">
                            <%= oracles.filter(oracle => oracle.premium_required).length %>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtres et recherche -->
        <div class="bg-white rounded-lg shadow mb-6 p-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                <div class="flex-1 max-w-lg">
                    <div class="relative">
                        <input type="text" placeholder="Rechercher un oracle..." 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <select class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500">
                        <option value="">Tous les statuts</option>
                        <option value="active">Actifs</option>
                        <option value="inactive">Inactifs</option>
                    </select>
                    
                    <select class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500">
                        <option value="">Tous les types</option>
                        <option value="free">Gratuits</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Table des oracles -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Oracle
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Éléments
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Statistiques
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Statut
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <% oracles.forEach(oracle => { %>
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <div class="h-10 w-10 rounded-full bg-purple-100 flex items-center justify-center">
                                                <i class="ra ra-crystal-ball text-purple-600"></i>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">
                                                <%= oracle.name %>
                                                <% if (oracle.premium_required) { %>
                                                    <i class="fas fa-crown text-yellow-500 ml-2"></i>
                                                <% } %>
                                            </div>
                                            <% if (oracle.description) { %>
                                                <div class="text-sm text-gray-500 truncate max-w-xs">
                                                    <%= oracle.description %>
                                                </div>
                                            <% } %>
                                        </div>
                                    </div>
                                </td>
                                
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">
                                        <div><%= oracle.total_items || 0 %> total</div>
                                        <div class="text-gray-500"><%= oracle.active_items || 0 %> actifs</div>
                                    </div>
                                </td>
                                
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">
                                        <div><%= oracle.total_draws || 0 %> tirages</div>
                                        <div class="text-gray-500">
                                            <%= oracle.total_weight || 0 %> poids total
                                        </div>
                                    </div>
                                </td>
                                
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                                        <%= oracle.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                                        <%= oracle.is_active ? 'Actif' : 'Inactif' %>
                                    </span>
                                </td>
                                
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex space-x-2">
                                        <a href="/oracles/<%= oracle.id %>" 
                                           class="text-blue-600 hover:text-blue-900"
                                           title="Voir l'oracle">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        
                                        <a href="/admin/oracles/<%= oracle.id %>/edit" 
                                           class="text-indigo-600 hover:text-indigo-900"
                                           title="Éditer">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        
                                        <button onclick="basculerStatut('<%= oracle.id %>', <%= !oracle.is_active %>)"
                                                class="<%= oracle.is_active ? 'text-yellow-600 hover:text-yellow-900' : 'text-green-600 hover:text-green-900' %>"
                                                title="<%= oracle.is_active ? 'Désactiver' : 'Activer' %>">
                                            <i class="fas fa-<%= oracle.is_active ? 'pause' : 'play' %>"></i>
                                        </button>
                                        
                                        <button onclick="clonerOracle('<%= oracle.id %>', '<%= oracle.name %>')"
                                                class="text-purple-600 hover:text-purple-900"
                                                title="Cloner">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        
                                        <button onclick="exporterOracle('<%= oracle.id %>', 'json')"
                                                class="text-green-600 hover:text-green-900"
                                                title="Exporter JSON">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        
                                        <button onclick="exporterOracle('<%= oracle.id %>', 'csv')"
                                                class="text-blue-600 hover:text-blue-900"
                                                title="Exporter CSV">
                                            <i class="fas fa-file-csv"></i>
                                        </button>
                                        
                                        <button onclick="confirmerSuppression('<%= oracle.id %>', '<%= oracle.name %>')"
                                                class="text-red-600 hover:text-red-900"
                                                title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <% if (pagination && pagination.pages > 1) { %>
            <div class="flex justify-center mt-8">
                <nav class="flex space-x-2">
                    <% if (pagination.hasPrev) { %>
                        <a href="/admin/oracles?page=<%= pagination.page - 1 %>" 
                           class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    <% } %>
                    
                    <% for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.pages, pagination.page + 2); i++) { %>
                        <a href="/admin/oracles?page=<%= i %>" 
                           class="px-4 py-2 rounded-lg <%= i === pagination.page ? 'bg-purple-600 text-white' : 'bg-white border border-gray-300 hover:bg-gray-50' %>">
                            <%= i %>
                        </a>
                    <% } %>
                    
                    <% if (pagination.hasNext) { %>
                        <a href="/admin/oracles?page=<%= pagination.page + 1 %>" 
                           class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    <% } %>
                </nav>
            </div>
        <% } %>
    </main>
</div>

<!-- Modal import -->
<div id="modal-import" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="fermerModalImport()">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-gray-900 mb-4">
                <i class="fas fa-upload mr-2"></i>
                Importer un Oracle
            </h3>
            
            <form id="form-import" onsubmit="importerFichier(event)" enctype="multipart/form-data">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fichier *</label>
                        <input type="file" name="file" accept=".json,.csv" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p class="text-sm text-gray-500 mt-1">Formats supportés: JSON, CSV</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mode d'import</label>
                        <select name="importMode" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="CREATE">Créer un nouvel oracle</option>
                            <option value="REPLACE" disabled>Remplacer un oracle existant (bientôt)</option>
                            <option value="MERGE" disabled>Fusionner avec un oracle (bientôt)</option>
                        </select>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <h4 class="font-medium text-blue-900 mb-2">Format JSON attendu:</h4>
                        <pre class="text-xs text-blue-800 bg-blue-100 p-2 rounded overflow-x-auto">
{
  "oracle": {
    "name": "Nom de l'oracle",
    "description": "Description",
    "premium_required": false
  },
  "items": [
    {
      "value": "Élément 1",
      "weight": 10,
      "metadata": {"type": "exemple"}
    }
  ]
}</pre>
                    </div>
                </div>
                
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="fermerModalImport()" 
                            class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300">
                        Annuler
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
                        Importer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal création d'oracle -->
<div id="modal-creation" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="fermerModalCreation()">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-gray-900 mb-4">
                <i class="fas fa-plus mr-2"></i>
                Créer un Nouvel Oracle
            </h3>
            
            <form id="form-creation" onsubmit="creerOracle(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nom *</label>
                        <input type="text" name="name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="description" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" name="premium_required" class="rounded">
                            <span class="ml-2 text-sm text-gray-700">Accès Premium requis</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" name="is_active" checked class="rounded">
                            <span class="ml-2 text-sm text-gray-700">Oracle actif</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="fermerModalCreation()" 
                            class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300">
                        Annuler
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">
                        Créer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal clonage -->
<div id="modal-clone" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="fermerModalClone()">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-gray-900 mb-4">
                <i class="fas fa-copy mr-2"></i>
                Cloner un Oracle
            </h3>
            
            <form id="form-clone" onsubmit="confirmerClonage(event)">
                <input type="hidden" id="clone-oracle-id">
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nouveau nom *</label>
                        <input type="text" id="clone-new-name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            Le clonage copiera l'oracle et tous ses éléments avec leurs pondérations.
                        </p>
                    </div>
                </div>
                
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="fermerModalClone()" 
                            class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300">
                        Annuler
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700">
                        Cloner
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Gestion des modals
function ouvrirModalCreation() {
    document.getElementById('modal-creation').classList.remove('hidden');
    document.querySelector('#form-creation input[name="name"]').focus();
}

function fermerModalCreation() {
    document.getElementById('modal-creation').classList.add('hidden');
    document.getElementById('form-creation').reset();
}

function clonerOracle(id, name) {
    document.getElementById('clone-oracle-id').value = id;
    document.getElementById('clone-new-name').value = `${name} (Copie)`;
    document.getElementById('modal-clone').classList.remove('hidden');
    document.getElementById('clone-new-name').focus();
    document.getElementById('clone-new-name').select();
}

function fermerModalClone() {
    document.getElementById('modal-clone').classList.add('hidden');
}

// Création d'oracle
async function creerOracle(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
        name: formData.get('name'),
        description: formData.get('description'),
        premium_required: formData.get('premium_required') === 'on',
        is_active: formData.get('is_active') === 'on'
    };
    
    try {
        const response = await fetch('/api/admin/oracles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.succes) {
            fermerModalCreation();
            location.reload();
        } else {
            alert('Erreur: ' + result.message);
        }
    } catch (error) {
        alert('Erreur lors de la création: ' + error.message);
    }
}

// Clonage d'oracle
async function confirmerClonage(event) {
    event.preventDefault();
    
    const id = document.getElementById('clone-oracle-id').value;
    const newName = document.getElementById('clone-new-name').value;
    
    try {
        const response = await fetch(`/api/admin/oracles/${id}/clone`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ newName })
        });
        
        const result = await response.json();
        
        if (result.succes) {
            fermerModalClone();
            location.reload();
        } else {
            alert('Erreur: ' + result.message);
        }
    } catch (error) {
        alert('Erreur lors du clonage: ' + error.message);
    }
}

// Basculer le statut d'un oracle
async function basculerStatut(id, nouvelEtat) {
    const action = nouvelEtat ? 'activer' : 'désactiver';
    
    if (!confirm(`Voulez-vous vraiment ${action} cet oracle ?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/oracles/${id}/toggle`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.succes) {
            location.reload();
        } else {
            alert('Erreur: ' + result.message);
        }
    } catch (error) {
        alert('Erreur lors du changement de statut: ' + error.message);
    }
}

// Confirmation de suppression
function confirmerSuppression(id, name) {
    if (confirm(`Êtes-vous sûr de vouloir supprimer définitivement l'oracle "${name}" ?\n\nCette action supprimera aussi tous les éléments, l'historique et les statistiques associés.\n\nCette action est IRRÉVERSIBLE.`)) {
        supprimerOracle(id);
    }
}

// Suppression d'oracle
async function supprimerOracle(id) {
    try {
        const response = await fetch(`/api/admin/oracles/${id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.succes) {
            location.reload();
        } else {
            alert('Erreur: ' + result.message);
        }
    } catch (error) {
        alert('Erreur lors de la suppression: ' + error.message);
    }
}

// Gestion modal import
function ouvrirModalImport() {
    document.getElementById('modal-import').classList.remove('hidden');
    document.querySelector('#form-import input[type="file"]').focus();
}

function fermerModalImport() {
    document.getElementById('modal-import').classList.add('hidden');
    document.getElementById('form-import').reset();
}

// Import de fichier
async function importerFichier(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    if (!formData.get('file')) {
        alert('Veuillez sélectionner un fichier');
        return;
    }
    
    try {
        const response = await fetch('/api/admin/oracles/import', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.succes) {
            fermerModalImport();
            alert(`Import réussi ! Oracle "${result.data.oracle.name}" créé avec ${result.data.stats.imported} éléments.`);
            location.reload();
        } else {
            alert('Erreur: ' + result.message);
        }
    } catch (error) {
        alert('Erreur lors de l\'import: ' + error.message);
    }
}

// Export d'oracle
async function exporterOracle(id, format) {
    try {
        const response = await fetch(`/api/admin/oracles/${id}/export/${format}`, {
            method: 'GET'
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = response.headers.get('Content-Disposition')?.match(/filename="(.+)"/)?.[1] || `oracle.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } else {
            const result = await response.json();
            alert('Erreur: ' + result.message);
        }
    } catch (error) {
        alert('Erreur lors de l\'export: ' + error.message);
    }
}

// Fermer modals avec Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        fermerModalCreation();
        fermerModalClone();
        fermerModalImport();
    }
});
</script>

<%- contentFor('title') %>
<%= titre %>