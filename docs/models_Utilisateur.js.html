<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: models/Utilisateur.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: models/Utilisateur.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const BaseModel = require('./BaseModel');
const crypto = require('crypto');

/**
 * Modèle Utilisateur
 */
class Utilisateur extends BaseModel {
    constructor() {
        super('utilisateurs', 'id');
        
        // Champs autorisés pour mass assignment
        this.fillable = [
            'nom', 'email', 'mot_de_passe', 'role', 'avatar', 
            'preferences', 'derniere_connexion', 'statut'
        ];
        
        // Champs protégés
        this.guarded = ['id', 'date_creation', 'date_modification'];
        
        // Champs cachés lors de la sérialisation
        this.hidden = ['mot_de_passe'];
        
        // Conversions automatiques
        this.casts = {
            preferences: 'json',
            derniere_connexion: 'date'
        };
        
        // Gestion automatique des timestamps
        this.timestamps = true;
    }

    /**
     * Validation métier
     */
    async validate(data, operation = 'create') {
        const erreurs = [];

        // Pour les mises à jour, ne valider que les champs présents
        if (operation === 'create') {
            // Email requis pour création
            if (!data.email) {
                erreurs.push('Email requis');
            }
            
            // Nom requis pour création
            if (!data.nom || data.nom.trim().length &lt; 2) {
                erreurs.push('Nom requis (minimum 2 caractères)');
            }
            
            // Mot de passe requis pour création
            if (!data.mot_de_passe || data.mot_de_passe.length &lt; 6) {
                erreurs.push('Mot de passe requis (minimum 6 caractères)');
            }
        }

        // Validation format email si présent
        if (data.email &amp;&amp; !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
            erreurs.push('Format email invalide');
        }

        // Validation nom si présent
        if (data.nom !== undefined &amp;&amp; data.nom.trim().length &lt; 2) {
            erreurs.push('Nom requis (minimum 2 caractères)');
        }

        // Validation mot de passe si présent
        if (data.mot_de_passe !== undefined &amp;&amp; data.mot_de_passe.length &lt; 6) {
            erreurs.push('Mot de passe trop court (minimum 6 caractères)');
        }

        // Rôle valide si présent
        const rolesValides = ['UTILISATEUR', 'PREMIUM', 'ADMIN'];
        if (data.role &amp;&amp; !rolesValides.includes(data.role)) {
            erreurs.push('Rôle invalide');
        }

        // Email unique si présent
        if (data.email) {
            const existing = await this.findOne('email = ?', [data.email.toLowerCase().trim()]);
            if (existing &amp;&amp; (operation === 'create' || existing.id !== data.id)) {
                erreurs.push('Email déjà utilisé');
            }
        }

        if (erreurs.length > 0) {
            throw new Error(`Erreurs de validation: ${erreurs.join(', ')}`);
        }

        return true;
    }

    /**
     * Hash le mot de passe avant création
     */
    async beforeCreate(data) {
        console.log('=== DEBUG beforeCreate ===');
        console.log('Données reçues:', Object.keys(data));
        console.log('Mot de passe présent:', !!data.mot_de_passe);
        console.log('Mot de passe brut:', data.mot_de_passe);
        
        if (data.mot_de_passe) {
            console.log('Hashage du mot de passe...');
            data.mot_de_passe = await this.hashMotDePasse(data.mot_de_passe);
            console.log('Mot de passe hashé:', data.mot_de_passe.substring(0, 50) + '...');
        }
        
        // Rôle par défaut
        if (!data.role) {
            data.role = 'UTILISATEUR';
        }
        
        // Statut par défaut (utilise la colonne 'actif')
        if (data.actif === undefined) {
            data.actif = true;
        }

        console.log('Données finales:', Object.keys(data));
        return data;
    }

    /**
     * Hash le mot de passe avant mise à jour
     */
    async beforeUpdate(data) {
        if (data.mot_de_passe) {
            data.mot_de_passe = await this.hashMotDePasse(data.mot_de_passe);
        }
        return data;
    }

    /**
     * Hash un mot de passe
     */
    async hashMotDePasse(motDePasse) {
        return new Promise((resolve, reject) => {
            const salt = crypto.randomBytes(16).toString('hex');
            crypto.pbkdf2(motDePasse, salt, 100000, 64, 'sha512', (err, derivedKey) => {
                if (err) reject(err);
                resolve(salt + ':' + derivedKey.toString('hex'));
            });
        });
    }

    /**
     * Vérifie un mot de passe
     */
    async verifierMotDePasse(motDePasse, hash) {
        return new Promise((resolve, reject) => {
            const [salt, key] = hash.split(':');
            crypto.pbkdf2(motDePasse, salt, 100000, 64, 'sha512', (err, derivedKey) => {
                if (err) reject(err);
                resolve(key === derivedKey.toString('hex'));
            });
        });
    }

    /**
     * Trouve un utilisateur par email
     */
    async findByEmail(email) {
        return await this.findOne('email = ?', [email.toLowerCase().trim()]);
    }

    /**
     * Trouve un utilisateur par email (alias français)
     */
    async obtenirParEmail(email) {
        const { sql, params } = this.convertPlaceholders(
            `SELECT * FROM ${this.tableName} WHERE email = ? LIMIT 1`,
            [email.toLowerCase().trim()]
        );
        const db = require('../database/db');
        const result = await db.get(sql, params);
        // Ne pas utiliser serialize() pour garder le mot_de_passe pour l'authentification
        return result || null;
    }

    /**
     * Trouve un utilisateur par ID
     */
    async obtenirParId(id) {
        return await this.findById(id);
    }

    /**
     * Trouve un utilisateur par token de récupération
     */
    async obtenirParToken(token) {
        const { sql, params } = this.convertPlaceholders(
            `SELECT * FROM ${this.tableName} WHERE token_recuperation = ? AND token_expiration > ? LIMIT 1`,
            [token, new Date().toISOString()]
        );
        const db = require('../database/db');
        const result = await db.get(sql, params);
        return result ? this.serialize(result) : null;
    }

    /**
     * Authentifie un utilisateur
     */
    async authentifier(email, motDePasse) {
        const utilisateur = await this.findByEmail(email);
        
        if (!utilisateur) {
            return null;
        }

        if (!utilisateur.actif) {
            throw new Error('Compte désactivé');
        }

        const motDePasseValide = await this.verifierMotDePasse(motDePasse, utilisateur.mot_de_passe);
        
        if (!motDePasseValide) {
            return null;
        }

        // Mettre à jour dernière connexion
        await this.update(utilisateur.id, {
            derniere_connexion: new Date().toISOString()
        });

        return this.serialize(utilisateur);
    }

    /**
     * Compte les utilisateurs par rôle
     */
    async compterParRole() {
        const { sql, params } = this.convertPlaceholders(
            `SELECT role, COUNT(*) as count FROM ${this.tableName} WHERE actif = ? GROUP BY role`,
            [true]
        );
        const db = require('../database/db');
        return await db.all(sql, params);
    }

    /**
     * Liste des utilisateurs actifs récents
     */
    async listerRecents(limite = 10) {
        return await this.findAll(
            'statut = ?', 
            ['ACTIF'], 
            'derniere_connexion DESC', 
            limite
        );
    }

    /**
     * Recherche d'utilisateurs
     */
    async rechercher(query) {
        return await this.search(query, ['nom', 'email']);
    }

    /**
     * Bannir un utilisateur
     */
    async bannir(id, raison = null) {
        return await this.update(id, {
            statut: 'BANNI',
            raison_bannissement: raison
        });
    }

    /**
     * Débannir un utilisateur
     */
    async debannir(id) {
        return await this.update(id, {
            statut: 'ACTIF',
            raison_bannissement: null
        });
    }

    /**
     * Élever le rôle d'un utilisateur
     */
    async elevationRole(id, nouveauRole) {
        const rolesHierarchie = {
            'UTILISATEUR': 1,
            'PREMIUM': 2,
            'ADMIN': 3
        };

        const utilisateur = await this.findById(id);
        if (!utilisateur) {
            throw new Error('Utilisateur non trouvé');
        }

        const roleActuel = rolesHierarchie[utilisateur.role] || 0;
        const roleNouveau = rolesHierarchie[nouveauRole] || 0;

        if (roleNouveau &lt;= roleActuel) {
            throw new Error('Impossible de rétrograder ou maintenir le même rôle');
        }

        return await this.update(id, { role: nouveauRole });
    }

    /**
     * Met à jour les préférences utilisateur
     */
    async mettreAJourPreferences(id, preferences) {
        const utilisateur = await this.findById(id);
        if (!utilisateur) {
            throw new Error('Utilisateur non trouvé');
        }

        const nouvellesPreferences = {
            ...(utilisateur.preferences || {}),
            ...preferences
        };

        return await this.update(id, { preferences: nouvellesPreferences });
    }
}

module.exports = Utilisateur;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Actualite.html">Actualite</a></li><li><a href="AdminController.html">AdminController</a></li><li><a href="AnonymousTokenService.html">AnonymousTokenService</a></li><li><a href="AuthentificationController.html">AuthentificationController</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="BasePdfKitService.html">BasePdfKitService</a></li><li><a href="BaseService.html">BaseService</a></li><li><a href="CharacterSheetDocument.html">CharacterSheetDocument</a></li><li><a href="ClassPlanDocument.html">ClassPlanDocument</a></li><li><a href="DocumentFactory.html">DocumentFactory</a></li><li><a href="DonationController.html">DonationController</a></li><li><a href="GenericDocument.html">GenericDocument</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="MarkdownService.html">MarkdownService</a></li><li><a href="MonsterheartsTheme.html">MonsterheartsTheme</a></li><li><a href="Newsletter.html">Newsletter</a></li><li><a href="NewsletterService.html">NewsletterService</a></li><li><a href="Oracle.html">Oracle</a></li><li><a href="OracleController.html">OracleController</a></li><li><a href="OracleItem.html">OracleItem</a></li><li><a href="OracleService.html">OracleService</a></li><li><a href="Pdf.html">Pdf</a></li><li><a href="PdfController.html">PdfController</a></li><li><a href="PdfKitService.html">PdfKitService</a></li><li><a href="PdfService.html">PdfService</a></li><li><a href="Personnage.html">Personnage</a></li><li><a href="PersonnageController.html">PersonnageController</a></li><li><a href="PersonnageService.html">PersonnageService</a></li><li><a href="SystemRightsService.html">SystemRightsService</a></li><li><a href="SystemTheme.html">SystemTheme</a></li><li><a href="Temoignage.html">Temoignage</a></li><li><a href="TemoignageService.html">TemoignageService</a></li><li><a href="TemplateService.html">TemplateService</a></li><li><a href="Utilisateur.html">Utilisateur</a></li><li><a href="UtilisateurService.html">UtilisateurService</a></li></ul><h3>Global</h3><ul><li><a href="global.html#compareVersions">compareVersions</a></li><li><a href="global.html#createMigrationsTable">createMigrationsTable</a></li><li><a href="global.html#createTables">createTables</a></li><li><a href="global.html#executeMigration">executeMigration</a></li><li><a href="global.html#getCurrentVersion">getCurrentVersion</a></li><li><a href="global.html#getExecutedMigrations">getExecutedMigrations</a></li><li><a href="global.html#getMigrationStatus">getMigrationStatus</a></li><li><a href="global.html#getVersionsToMigrate">getVersionsToMigrate</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#isDatabaseInitialized">isDatabaseInitialized</a></li><li><a href="global.html#markMigrationExecuted">markMigrationExecuted</a></li><li><a href="global.html#migrateDatabase">migrateDatabase</a></li><li><a href="global.html#migrateToLatest">migrateToLatest</a></li><li><a href="global.html#migrateToVersion">migrateToVersion</a></li><li><a href="global.html#migrations">migrations</a></li><li><a href="global.html#resetDatabase">resetDatabase</a></li><li><a href="global.html#rollbackMigration">rollbackMigration</a></li><li><a href="global.html#updateAppVersion">updateAppVersion</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue Jul 22 2025 09:21:38 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
