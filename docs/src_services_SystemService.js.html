<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/services/SystemService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/services/SystemService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const BaseService = require('./BaseService');
const { systemesJeu } = require('../config/systemesJeu');

/**
 * Service pour la gestion des systèmes de jeu
 * US001 - Sélection du système de jeu
 * US016 - Gestion des systèmes de jeu (Admin)
 */
class SystemService extends BaseService {
    constructor() {
        super('SystemService');
    }

    /**
     * US001 - Liste les systèmes de jeu disponibles pour la sélection
     */
    async listerSystemesDisponibles(filtres = {}) {
        try {
            const systemes = Object.entries(systemesJeu)
                .map(([cle, config]) => ({
                    id: cle,
                    nom: config.nom,
                    description: config.description || '',
                    version: config.version || '1.0.0',
                    actif: config.actif !== false,
                    couleurs: config.couleurs || {},
                    apercu: {
                        attributs: this.extraireApercu(config.attributs),
                        competences: this.extraireApercu(config.competences),
                        infos_specifiques: config.infos_base?.apercu || null
                    },
                    complexite: config.complexite || 'moyenne',
                    tags: config.tags || [],
                    icone: config.icone || null
                }))
                .filter(systeme => {
                    // Filtres optionnels
                    if (filtres.actif !== undefined &amp;&amp; systeme.actif !== filtres.actif) {
                        return false;
                    }
                    if (filtres.complexite &amp;&amp; systeme.complexite !== filtres.complexite) {
                        return false;
                    }
                    if (filtres.tag &amp;&amp; !systeme.tags.includes(filtres.tag)) {
                        return false;
                    }
                    return true;
                })
                .sort((a, b) => {
                    // Trier par ordre alphabétique, mais avec les systèmes actifs en premier
                    if (a.actif !== b.actif) {
                        return b.actif - a.actif;
                    }
                    return a.nom.localeCompare(b.nom);
                });

            this.logger.info('Systèmes listés:', { 
                total: systemes.length, 
                actifs: systemes.filter(s => s.actif).length 
            });

            return systemes;

        } catch (erreur) {
            this.logger.error('Erreur lors de la liste des systèmes:', erreur);
            throw erreur;
        }
    }

    /**
     * Obtient les détails complets d'un système de jeu
     */
    async obtenirDetailsSysteme(systemeId) {
        try {
            const config = systemesJeu[systemeId];
            if (!config) {
                throw new Error('Système de jeu non trouvé');
            }

            const details = {
                id: systemeId,
                nom: config.nom,
                description: config.description || '',
                version: config.version || '1.0.0',
                actif: config.actif !== false,
                
                // Configuration détaillée
                attributs: config.attributs || {},
                competences: config.competences || {},
                infos_base: config.infos_base || {},
                
                // Personnalisation
                couleurs: config.couleurs || {},
                icone: config.icone || null,
                styles_css: config.styles_css || null,
                
                // Métadonnées
                auteur: config.auteur || 'Système officiel',
                licence: config.licence || 'Utilisation libre',
                url_officiel: config.url_officiel || null,
                
                // Informations techniques
                templates_disponibles: config.templates || [],
                supports_pdf: config.supports_pdf !== false,
                supports_exports: config.supports_exports || ['pdf', 'json'],
                
                // Classification
                complexite: config.complexite || 'moyenne',
                tags: config.tags || [],
                public_cible: config.public_cible || 'tout-public',
                
                // Statistiques d'usage
                statistiques: await this.obtenirStatistiquesSysteme(systemeId)
            };

            return details;

        } catch (erreur) {
            this.logger.error(`Erreur lors de la récupération du système ${systemeId}:`, erreur);
            throw erreur;
        }
    }

    /**
     * US016 - Crée un nouveau système de jeu (Admin uniquement)
     */
    async creerSysteme(donnees, utilisateurRole = 'UTILISATEUR') {
        try {
            // Vérifier les permissions admin
            if (utilisateurRole !== 'ADMIN') {
                throw new Error('Fonctionnalité réservée aux administrateurs');
            }

            // Valider les données
            this.validerDonneesSysteme(donnees);

            // Vérifier que l'ID n'existe pas déjà
            if (systemesJeu[donnees.id]) {
                throw new Error('Un système avec cet ID existe déjà');
            }

            // Préparer la configuration complète
            const configSysteme = this.preparerConfigurationSysteme(donnees);

            // Sauvegarder (simulation - dans un vrai système, on sauvegarderait en base/fichier)
            await this.sauvegarderSysteme(donnees.id, configSysteme);

            this.logger.info('Nouveau système créé:', { 
                id: donnees.id, 
                nom: donnees.nom 
            });

            return {
                id: donnees.id,
                ...configSysteme,
                date_creation: new Date(),
                cree_par: 'admin'
            };

        } catch (erreur) {
            this.logger.error('Erreur lors de la création du système:', erreur);
            throw erreur;
        }
    }

    /**
     * US016 - Met à jour un système existant (Admin uniquement)
     */
    async mettreAJourSysteme(systemeId, donnees, utilisateurRole = 'UTILISATEUR') {
        try {
            // Vérifier les permissions admin
            if (utilisateurRole !== 'ADMIN') {
                throw new Error('Fonctionnalité réservée aux administrateurs');
            }

            // Vérifier que le système existe
            if (!systemesJeu[systemeId]) {
                throw new Error('Système de jeu non trouvé');
            }

            // Valider les données partielles
            this.validerDonneesSysteme(donnees, true);

            // Fusionner avec la configuration existante
            const configExistante = systemesJeu[systemeId];
            const configMiseAJour = {
                ...configExistante,
                ...donnees,
                date_modification: new Date(),
                modifie_par: 'admin'
            };

            // Sauvegarder
            await this.sauvegarderSysteme(systemeId, configMiseAJour);

            this.logger.info('Système mis à jour:', { 
                id: systemeId, 
                champs: Object.keys(donnees) 
            });

            return configMiseAJour;

        } catch (erreur) {
            this.logger.error(`Erreur lors de la mise à jour du système ${systemeId}:`, erreur);
            throw erreur;
        }
    }

    /**
     * US016 - Active/désactive un système (Admin uniquement)
     */
    async changerStatutSysteme(systemeId, actif, utilisateurRole = 'UTILISATEUR') {
        try {
            // Vérifier les permissions admin
            if (utilisateurRole !== 'ADMIN') {
                throw new Error('Fonctionnalité réservée aux administrateurs');
            }

            const donnees = { 
                actif,
                date_modification: new Date(),
                modifie_par: 'admin'
            };

            const systemeMAJ = await this.mettreAJourSysteme(systemeId, donnees, utilisateurRole);

            this.logger.info(`Système ${actif ? 'activé' : 'désactivé'}:`, { id: systemeId });

            return systemeMAJ;

        } catch (erreur) {
            this.logger.error(`Erreur lors du changement de statut ${systemeId}:`, erreur);
            throw erreur;
        }
    }

    /**
     * US016 - Supprime un système (Admin uniquement)
     */
    async supprimerSysteme(systemeId, utilisateurRole = 'UTILISATEUR') {
        try {
            // Vérifier les permissions admin
            if (utilisateurRole !== 'ADMIN') {
                throw new Error('Fonctionnalité réservée aux administrateurs');
            }

            // Vérifier que le système existe
            if (!systemesJeu[systemeId]) {
                throw new Error('Système de jeu non trouvé');
            }

            // Vérifier s'il y a des personnages utilisant ce système
            const nbPersonnages = await this.compterPersonnagesParSysteme(systemeId);
            if (nbPersonnages > 0) {
                throw new Error(`Impossible de supprimer : ${nbPersonnages} personnages utilisent ce système`);
            }

            // Supprimer (simulation)
            await this.supprimerSystemeEnBase(systemeId);

            this.logger.info('Système supprimé:', { id: systemeId });

            return true;

        } catch (erreur) {
            this.logger.error(`Erreur lors de la suppression du système ${systemeId}:`, erreur);
            throw erreur;
        }
    }

    /**
     * Obtient les statistiques d'utilisation des systèmes
     */
    async obtenirStatistiquesGlobales() {
        try {
            const statistiques = {};
            
            for (const [systemeId, config] of Object.entries(systemesJeu)) {
                statistiques[systemeId] = {
                    nom: config.nom,
                    actif: config.actif !== false,
                    nb_personnages: await this.compterPersonnagesParSysteme(systemeId),
                    nb_pdfs_generes: await this.compterPdfsParSysteme(systemeId),
                    derniere_utilisation: await this.obtenirDerniereUtilisation(systemeId)
                };
            }

            return {
                systemes: statistiques,
                resume: {
                    total_systemes: Object.keys(systemesJeu).length,
                    systemes_actifs: Object.values(systemesJeu).filter(s => s.actif !== false).length,
                    total_personnages: Object.values(statistiques).reduce((sum, s) => sum + s.nb_personnages, 0),
                    total_pdfs: Object.values(statistiques).reduce((sum, s) => sum + s.nb_pdfs_generes, 0)
                }
            };

        } catch (erreur) {
            this.logger.error('Erreur lors du calcul des statistiques:', erreur);
            throw erreur;
        }
    }

    /**
     * Valide la configuration d'un système
     */
    async validerConfigurationSysteme(systemeId) {
        try {
            const config = systemesJeu[systemeId];
            if (!config) {
                throw new Error('Système non trouvé');
            }

            const erreurs = [];
            const avertissements = [];

            // Validation de base
            if (!config.nom) {
                erreurs.push('Nom manquant');
            }

            if (!config.version) {
                avertissements.push('Version non spécifiée');
            }

            // Validation des attributs
            if (config.attributs) {
                for (const [nom, attrConfig] of Object.entries(config.attributs)) {
                    if (typeof attrConfig.min !== 'number' || typeof attrConfig.max !== 'number') {
                        erreurs.push(`Attribut ${nom} : min/max invalides`);
                    }
                    if (attrConfig.min >= attrConfig.max) {
                        erreurs.push(`Attribut ${nom} : min doit être &lt; max`);
                    }
                }
            }

            // Validation des templates
            if (config.templates) {
                const templatesInvalides = [];
                for (const template of config.templates) {
                    const existe = await this.verifierExistenceTemplate(systemeId, template);
                    if (!existe) {
                        templatesInvalides.push(template);
                    }
                }
                if (templatesInvalides.length > 0) {
                    avertissements.push(`Templates introuvables : ${templatesInvalides.join(', ')}`);
                }
            }

            return {
                valide: erreurs.length === 0,
                erreurs,
                avertissements,
                systeme_id: systemeId,
                date_validation: new Date()
            };

        } catch (erreur) {
            this.logger.error(`Erreur lors de la validation ${systemeId}:`, erreur);
            throw erreur;
        }
    }

    /**
     * Extrait un aperçu pour la liste des systèmes
     */
    extraireApercu(configuration) {
        if (!configuration || typeof configuration !== 'object') {
            return null;
        }

        // Retourner les 3 premiers éléments comme aperçu
        const cles = Object.keys(configuration).slice(0, 3);
        return cles.length > 0 ? cles : null;
    }

    /**
     * Valide les données d'un système
     */
    validerDonneesSysteme(donnees, miseAJour = false) {
        const erreurs = [];

        // Validation de l'ID (seulement pour création)
        if (!miseAJour) {
            if (!donnees.id || typeof donnees.id !== 'string') {
                erreurs.push('ID requis (string)');
            } else if (!/^[a-z0-9_-]+$/.test(donnees.id)) {
                erreurs.push('ID doit contenir uniquement des lettres minuscules, chiffres, tirets et underscores');
            }
        }

        // Validation du nom
        if (donnees.nom !== undefined) {
            if (!donnees.nom || typeof donnees.nom !== 'string') {
                erreurs.push('Nom requis (string)');
            } else if (donnees.nom.length &lt; 2 || donnees.nom.length > 100) {
                erreurs.push('Nom doit faire entre 2 et 100 caractères');
            }
        }

        // Validation de la version
        if (donnees.version !== undefined) {
            if (typeof donnees.version !== 'string' || !/^\d+\.\d+\.\d+$/.test(donnees.version)) {
                erreurs.push('Version doit suivre le format x.y.z');
            }
        }

        // Validation des attributs
        if (donnees.attributs !== undefined) {
            if (typeof donnees.attributs !== 'object') {
                erreurs.push('Attributs doit être un objet');
            } else {
                for (const [nom, config] of Object.entries(donnees.attributs)) {
                    if (!config.min || !config.max || typeof config.min !== 'number' || typeof config.max !== 'number') {
                        erreurs.push(`Attribut ${nom} : min et max requis (numbers)`);
                    }
                }
            }
        }

        if (erreurs.length > 0) {
            const erreur = new Error(erreurs.join(', '));
            erreur.name = 'ValidationError';
            erreur.details = erreurs;
            throw erreur;
        }
    }

    /**
     * Prépare la configuration complète d'un système
     */
    preparerConfigurationSysteme(donnees) {
        return {
            nom: donnees.nom,
            description: donnees.description || '',
            version: donnees.version || '1.0.0',
            actif: donnees.actif !== false,
            
            attributs: donnees.attributs || {},
            competences: donnees.competences || {},
            infos_base: donnees.infos_base || {},
            
            couleurs: donnees.couleurs || {},
            icone: donnees.icone || null,
            
            complexite: donnees.complexite || 'moyenne',
            tags: donnees.tags || [],
            public_cible: donnees.public_cible || 'tout-public',
            
            auteur: donnees.auteur || 'Système personnalisé',
            licence: donnees.licence || 'Utilisation libre',
            
            templates: donnees.templates || [],
            supports_pdf: donnees.supports_pdf !== false,
            supports_exports: donnees.supports_exports || ['pdf', 'json']
        };
    }

    // Méthodes simulées pour la base de données
    async obtenirStatistiquesSysteme(systemeId) {
        // TODO: Implémenter selon le modèle de base de données
        return {
            nb_personnages: 0,
            nb_pdfs_generes: 0,
            derniere_utilisation: null
        };
    }

    async compterPersonnagesParSysteme(systemeId) {
        // TODO: Implémenter
        return 0;
    }

    async compterPdfsParSysteme(systemeId) {
        // TODO: Implémenter
        return 0;
    }

    async obtenirDerniereUtilisation(systemeId) {
        // TODO: Implémenter
        return null;
    }

    async sauvegarderSysteme(systemeId, config) {
        // TODO: Implémenter la sauvegarde persistante
        // Pour l'instant, simulation en mémoire
        systemesJeu[systemeId] = config;
        return true;
    }

    async supprimerSystemeEnBase(systemeId) {
        // TODO: Implémenter la suppression persistante
        delete systemesJeu[systemeId];
        return true;
    }

    async verifierExistenceTemplate(systemeId, templateId) {
        // TODO: Implémenter la vérification d'existence des templates
        return true;
    }
}

module.exports = SystemService;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Actualite.html">Actualite</a></li><li><a href="AdminController.html">AdminController</a></li><li><a href="AdminOracleService.html">AdminOracleService</a></li><li><a href="AnonymousTokenService.html">AnonymousTokenService</a></li><li><a href="AuthentificationController.html">AuthentificationController</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="BasePdfKitService.html">BasePdfKitService</a></li><li><a href="BaseService.html">BaseService</a></li><li><a href="CacheService.html">CacheService</a></li><li><a href="CharacterSheetDocument.html">CharacterSheetDocument</a></li><li><a href="ClassPlanDocument.html">ClassPlanDocument</a></li><li><a href="DangerDocument.html">DangerDocument</a></li><li><a href="DemandeChangementEmail.html">DemandeChangementEmail</a></li><li><a href="Document.html">Document</a></li><li><a href="DocumentFactory.html">DocumentFactory</a></li><li><a href="DocumentModerationHistorique.html">DocumentModerationHistorique</a></li><li><a href="DocumentModerationService.html">DocumentModerationService</a></li><li><a href="DocumentSystemeJeu.html">DocumentSystemeJeu</a></li><li><a href="DocumentVote.html">DocumentVote</a></li><li><a href="DonationController.html">DonationController</a></li><li><a href="EmailService.html">EmailService</a></li><li><a href="EmailTemplate.html">EmailTemplate</a></li><li><a href="EngrenagesTheme.html">EngrenagesTheme</a></li><li><a href="GenericDocument.html">GenericDocument</a></li><li><a href="GroupDocument.html">GroupDocument</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="LoggingService.html">LoggingService</a></li><li><a href="MarkdownService.html">MarkdownService</a></li><li><a href="Metro2033Theme.html">Metro2033Theme</a></li><li><a href="MistEngineTheme.html">MistEngineTheme</a></li><li><a href="ModerationController.html">ModerationController</a></li><li><a href="MonsterheartsTheme.html">MonsterheartsTheme</a></li><li><a href="NavigationService.html">NavigationService</a></li><li><a href="Newsletter.html">Newsletter</a></li><li><a href="NewsletterService.html">NewsletterService</a></li><li><a href="Oracle.html">Oracle</a></li><li><a href="OracleController.html">OracleController</a></li><li><a href="OracleItem.html">OracleItem</a></li><li><a href="OracleService.html">OracleService</a></li><li><a href="OrganizationDocument.html">OrganizationDocument</a></li><li><a href="Pdf.html">Pdf</a></li><li><a href="PdfController.html">PdfController</a></li><li><a href="PdfKitService.html">PdfKitService</a></li><li><a href="PdfService.html">PdfService</a></li><li><a href="PerformanceMiddleware.html">PerformanceMiddleware</a></li><li><a href="PerformanceMonitoringService.html">PerformanceMonitoringService</a></li><li><a href="Personnage.html">Personnage</a></li><li><a href="PersonnageController.html">PersonnageController</a></li><li><a href="PersonnageService.html">PersonnageService</a></li><li><a href="ProductionApp.html">ProductionApp</a></li><li><a href="QueueService.html">QueueService</a></li><li><a href="RgpdConsentement.html">RgpdConsentement</a></li><li><a href="RgpdService.html">RgpdService</a></li><li><a href="SecurityService.html">SecurityService</a></li><li><a href="ShareService.html">ShareService</a></li><li><a href="SystemCardViewModel.html">SystemCardViewModel</a></li><li><a href="SystemMaintenanceService.html">SystemMaintenanceService</a></li><li><a href="SystemRightsService.html">SystemRightsService</a></li><li><a href="SystemService.html">SystemService</a></li><li><a href="SystemTheme.html">SystemTheme</a></li><li><a href="SystemThemeService.html">SystemThemeService</a></li><li><a href="SystemeJeu.html">SystemeJeu</a></li><li><a href="Temoignage.html">Temoignage</a></li><li><a href="TemoignageService.html">TemoignageService</a></li><li><a href="TemplateService.html">TemplateService</a></li><li><a href="ThemeService.html">ThemeService</a></li><li><a href="TownDocument.html">TownDocument</a></li><li><a href="Utilisateur.html">Utilisateur</a></li><li><a href="UtilisateurService.html">UtilisateurService</a></li><li><a href="VoteController.html">VoteController</a></li><li><a href="VoteService.html">VoteService</a></li><li><a href="ZombiologyTheme.html">ZombiologyTheme</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AuthComponent">AuthComponent</a></li><li><a href="global.html#InscriptionComponent">InscriptionComponent</a></li><li><a href="global.html#Joi">Joi</a></li><li><a href="global.html#MotDePasseOublieComponent">MotDePasseOublieComponent</a></li><li><a href="global.html#ReinitialiserMotDePasseComponent">ReinitialiserMotDePasseComponent</a></li><li><a href="global.html#actionFlottante">actionFlottante</a></li><li><a href="global.html#ajouterTemoignage">ajouterTemoignage</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#auth">auth</a></li><li><a href="global.html#chargerDonneesAccueil">chargerDonneesAccueil</a></li><li><a href="global.html#chargerInfosDons">chargerInfosDons</a></li><li><a href="global.html#choixModeCreation">choixModeCreation</a></li><li><a href="global.html#choixTypeDocument">choixTypeDocument</a></li><li><a href="global.html#compareVersions">compareVersions</a></li><li><a href="global.html#createError">createError</a></li><li><a href="global.html#createMigrationsTable">createMigrationsTable</a></li><li><a href="global.html#createTables">createTables</a></li><li><a href="global.html#creationPersonnage">creationPersonnage</a></li><li><a href="global.html#database">database</a></li><li><a href="global.html#elevationRole">elevationRole</a></li><li><a href="global.html#executeMigration">executeMigration</a></li><li><a href="global.html#fichePersonnage">fichePersonnage</a></li><li><a href="global.html#formaterDate">formaterDate</a></li><li><a href="global.html#formaterNombre">formaterNombre</a></li><li><a href="global.html#formaterTailleFichier">formaterTailleFichier</a></li><li><a href="global.html#genererEtoiles">genererEtoiles</a></li><li><a href="global.html#getCurrentVersion">getCurrentVersion</a></li><li><a href="global.html#getErrorMessage">getErrorMessage</a></li><li><a href="global.html#getExecutedMigrations">getExecutedMigrations</a></li><li><a href="global.html#getMigrationStatus">getMigrationStatus</a></li><li><a href="global.html#getVersionsToMigrate">getVersionsToMigrate</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#handleNotFound">handleNotFound</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#inscrireNewsletter">inscrireNewsletter</a></li><li><a href="global.html#isDatabaseInitialized">isDatabaseInitialized</a></li><li><a href="global.html#listePersonnages">listePersonnages</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#markMigrationExecuted">markMigrationExecuted</a></li><li><a href="global.html#menuUtilisateur">menuUtilisateur</a></li><li><a href="global.html#mesDocuments">mesDocuments</a></li><li><a href="global.html#migrateDatabase">migrateDatabase</a></li><li><a href="global.html#migrateToLatest">migrateToLatest</a></li><li><a href="global.html#migrateToVersion">migrateToVersion</a></li><li><a href="global.html#migrations">migrations</a></li><li><a href="global.html#navigationFormulaire">navigationFormulaire</a></li><li><a href="global.html#naviguerVersSysteme">naviguerVersSysteme</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#ouvrirLienDon">ouvrirLienDon</a></li><li><a href="global.html#partageDocument">partageDocument</a></li><li><a href="global.html#partagerPdf">partagerPdf</a></li><li><a href="global.html#path">path</a></li><li><a href="global.html#previewHtml">previewHtml</a></li><li><a href="global.html#requireAdmin">requireAdmin</a></li><li><a href="global.html#requireAuth">requireAuth</a></li><li><a href="global.html#requirePremium">requirePremium</a></li><li><a href="global.html#resetDatabase">resetDatabase</a></li><li><a href="global.html#rollbackMigration">rollbackMigration</a></li><li><a href="global.html#schemas">schemas</a></li><li><a href="global.html#scrollVersSection">scrollVersSection</a></li><li><a href="global.html#selectionSysteme">selectionSysteme</a></li><li><a href="global.html#updateAppVersion">updateAppVersion</a></li><li><a href="global.html#validateFiles">validateFiles</a></li><li><a href="global.html#validateRequest">validateRequest</a></li><li><a href="global.html#verifierAuth">verifierAuth</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Aug 08 2025 18:20:12 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
