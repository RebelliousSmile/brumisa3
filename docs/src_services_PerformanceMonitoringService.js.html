<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/services/PerformanceMonitoringService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/services/PerformanceMonitoringService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const BaseService = require('./BaseService');

/**
 * Service de monitoring des performances
 * Mesure temps de réponse, métriques d'usage, détection de problèmes
 */
class PerformanceMonitoringService extends BaseService {
    constructor() {
        super('PerformanceMonitoringService');
        this.metrics = {
            requests: new Map(),
            endpoints: new Map(),
            errors: new Map(),
            system: {
                startTime: Date.now(),
                requestCount: 0,
                errorCount: 0,
                totalResponseTime: 0
            }
        };
        
        // Configuration
        this.config = {
            maxHistorySize: parseInt(process.env.PERF_MAX_HISTORY) || 1000,
            slowRequestThreshold: parseInt(process.env.PERF_SLOW_THRESHOLD) || 1000, // 1 seconde
            alertThreshold: parseInt(process.env.PERF_ALERT_THRESHOLD) || 5000, // 5 secondes
            metricsRetentionTime: parseInt(process.env.PERF_RETENTION) || 86400000 // 24 heures
        };
        
        this.log('info', 'PerformanceMonitoringService initialisé', {
            slowRequestThreshold: this.config.slowRequestThreshold,
            alertThreshold: this.config.alertThreshold
        });
        
        // Nettoyer les métriques anciennes périodiquement
        setInterval(() => {
            this.cleanOldMetrics();
        }, 300000); // Toutes les 5 minutes
    }

    /**
     * Middleware Express pour mesurer les performances
     * 
     * @returns {Function} Middleware Express
     */
    middleware() {
        return (req, res, next) => {
            const startTime = process.hrtime.bigint();
            const requestId = this.generateRequestId();
            
            // Ajouter l'ID de requête pour traçabilité
            req.performanceId = requestId;
            
            // Hook sur la fin de réponse
            const originalEnd = res.end;
            res.end = (...args) => {
                const endTime = process.hrtime.bigint();
                const responseTimeMs = Number(endTime - startTime) / 1000000;
                
                // Enregistrer les métriques
                this.recordRequest({
                    id: requestId,
                    method: req.method,
                    path: req.path,
                    route: req.route?.path || req.path,
                    statusCode: res.statusCode,
                    responseTime: responseTimeMs,
                    timestamp: Date.now(),
                    userAgent: req.get('User-Agent'),
                    ip: req.ip,
                    userId: req.session?.userId || null
                });
                
                // Appeler la méthode originale
                originalEnd.apply(res, args);
            };
            
            next();
        };
    }

    /**
     * Enregistre une requête dans les métriques
     */
    recordRequest(requestData) {
        const { 
            id, method, path, route, statusCode, responseTime, 
            timestamp, userAgent, ip, userId 
        } = requestData;
        
        // Stocker les détails de la requête
        this.metrics.requests.set(id, requestData);
        
        // Nettoyer si trop d'entrées
        if (this.metrics.requests.size > this.config.maxHistorySize) {
            const oldestKey = this.metrics.requests.keys().next().value;
            this.metrics.requests.delete(oldestKey);
        }
        
        // Métriques par endpoint
        const endpointKey = `${method} ${route}`;
        if (!this.metrics.endpoints.has(endpointKey)) {
            this.metrics.endpoints.set(endpointKey, {
                method,
                route,
                count: 0,
                totalResponseTime: 0,
                minResponseTime: Infinity,
                maxResponseTime: 0,
                errorCount: 0,
                statusCodes: new Map()
            });
        }
        
        const endpoint = this.metrics.endpoints.get(endpointKey);
        endpoint.count++;
        endpoint.totalResponseTime += responseTime;
        endpoint.minResponseTime = Math.min(endpoint.minResponseTime, responseTime);
        endpoint.maxResponseTime = Math.max(endpoint.maxResponseTime, responseTime);
        
        // Status codes
        const statusKey = statusCode.toString();
        endpoint.statusCodes.set(statusKey, (endpoint.statusCodes.get(statusKey) || 0) + 1);
        
        if (statusCode >= 400) {
            endpoint.errorCount++;
        }
        
        // Métriques système globales
        this.metrics.system.requestCount++;
        this.metrics.system.totalResponseTime += responseTime;
        
        if (statusCode >= 400) {
            this.metrics.system.errorCount++;
        }
        
        // Logging pour requêtes lentes
        if (responseTime > this.config.slowRequestThreshold) {
            this.log('warn', 'Requête lente détectée', {
                method,
                path,
                responseTime: `${responseTime.toFixed(2)}ms`,
                statusCode,
                userId
            });
        }
        
        // Alerte pour requêtes très lentes
        if (responseTime > this.config.alertThreshold) {
            this.log('error', 'Requête critique lente', {
                method,
                path,
                responseTime: `${responseTime.toFixed(2)}ms`,
                statusCode,
                userId,
                userAgent
            });
        }
        
        // Log debug pour toutes les requêtes
        this.log('debug', 'Requête traitée', {
            id,
            method,
            path,
            responseTime: `${responseTime.toFixed(2)}ms`,
            statusCode
        });
    }

    /**
     * Mesure le temps d'exécution d'une fonction
     */
    async measureTime(operation, fn) {
        const startTime = process.hrtime.bigint();
        
        try {
            const result = await fn();
            const endTime = process.hrtime.bigint();
            const duration = Number(endTime - startTime) / 1000000;
            
            this.log('debug', 'Opération mesurée', {
                operation,
                duration: `${duration.toFixed(2)}ms`
            });
            
            return { result, duration };
            
        } catch (error) {
            const endTime = process.hrtime.bigint();
            const duration = Number(endTime - startTime) / 1000000;
            
            this.log('error', 'Erreur dans opération mesurée', {
                operation,
                duration: `${duration.toFixed(2)}ms`,
                error: error.message
            });
            
            throw error;
        }
    }

    /**
     * Enregistre une métrique personnalisée
     */
    recordCustomMetric(name, value, tags = {}) {
        const timestamp = Date.now();
        const metricKey = `custom:${name}`;
        
        if (!this.metrics.endpoints.has(metricKey)) {
            this.metrics.endpoints.set(metricKey, {
                name,
                type: 'custom',
                values: [],
                count: 0,
                sum: 0,
                min: Infinity,
                max: 0
            });
        }
        
        const metric = this.metrics.endpoints.get(metricKey);
        metric.values.push({ value, timestamp, tags });
        metric.count++;
        metric.sum += value;
        metric.min = Math.min(metric.min, value);
        metric.max = Math.max(metric.max, value);
        
        // Nettoyer les anciennes valeurs
        const cutoff = timestamp - this.config.metricsRetentionTime;
        metric.values = metric.values.filter(v => v.timestamp > cutoff);
        
        this.log('debug', 'Métrique personnalisée enregistrée', {
            name,
            value,
            tags
        });
    }

    /**
     * Obtient les métriques d'un endpoint
     */
    getEndpointMetrics(method, route) {
        const key = `${method} ${route}`;
        const endpoint = this.metrics.endpoints.get(key);
        
        if (!endpoint) {
            return null;
        }
        
        return {
            ...endpoint,
            avgResponseTime: endpoint.totalResponseTime / endpoint.count,
            errorRate: (endpoint.errorCount / endpoint.count * 100).toFixed(2) + '%',
            statusCodes: Object.fromEntries(endpoint.statusCodes)
        };
    }

    /**
     * Obtient les métriques système globales
     */
    getSystemMetrics() {
        const { system } = this.metrics;
        const uptime = Date.now() - system.startTime;
        const avgResponseTime = system.requestCount > 0 
            ? system.totalResponseTime / system.requestCount 
            : 0;
        const errorRate = system.requestCount > 0 
            ? (system.errorCount / system.requestCount * 100).toFixed(2) + '%' 
            : '0%';
        
        return {
            uptime,
            uptimeHuman: this.formatUptime(uptime),
            requestCount: system.requestCount,
            errorCount: system.errorCount,
            errorRate,
            avgResponseTime: avgResponseTime.toFixed(2),
            requestsPerMinute: this.getRequestsPerMinute(),
            memoryUsage: process.memoryUsage(),
            cpuUsage: process.cpuUsage()
        };
    }

    /**
     * Obtient le nombre de requêtes par minute
     */
    getRequestsPerMinute() {
        const oneMinuteAgo = Date.now() - 60000;
        let count = 0;
        
        for (const request of this.metrics.requests.values()) {
            if (request.timestamp > oneMinuteAgo) {
                count++;
            }
        }
        
        return count;
    }

    /**
     * Obtient les endpoints les plus lents
     */
    getSlowestEndpoints(limit = 10) {
        const endpoints = Array.from(this.metrics.endpoints.entries())
            .filter(([key, data]) => !key.startsWith('custom:'))
            .map(([key, data]) => ({
                endpoint: key,
                avgResponseTime: data.totalResponseTime / data.count,
                count: data.count,
                maxResponseTime: data.maxResponseTime,
                errorRate: (data.errorCount / data.count * 100).toFixed(2) + '%'
            }))
            .sort((a, b) => b.avgResponseTime - a.avgResponseTime)
            .slice(0, limit);
        
        return endpoints;
    }

    /**
     * Obtient les endpoints avec le plus d'erreurs
     */
    getEndpointsWithMostErrors(limit = 10) {
        const endpoints = Array.from(this.metrics.endpoints.entries())
            .filter(([key, data]) => !key.startsWith('custom:'))
            .map(([key, data]) => ({
                endpoint: key,
                errorCount: data.errorCount,
                totalCount: data.count,
                errorRate: (data.errorCount / data.count * 100).toFixed(2) + '%'
            }))
            .filter(e => e.errorCount > 0)
            .sort((a, b) => b.errorCount - a.errorCount)
            .slice(0, limit);
        
        return endpoints;
    }

    /**
     * Obtient les requêtes récentes
     */
    getRecentRequests(limit = 50) {
        return Array.from(this.metrics.requests.values())
            .sort((a, b) => b.timestamp - a.timestamp)
            .slice(0, limit)
            .map(req => ({
                id: req.id,
                method: req.method,
                path: req.path,
                statusCode: req.statusCode,
                responseTime: req.responseTime.toFixed(2),
                timestamp: req.timestamp,
                userId: req.userId
            }));
    }

    /**
     * Génère un rapport de performance complet
     */
    generatePerformanceReport() {
        return {
            system: this.getSystemMetrics(),
            slowestEndpoints: this.getSlowestEndpoints(),
            mostErrors: this.getEndpointsWithMostErrors(),
            recentRequests: this.getRecentRequests(20),
            alerts: this.getActiveAlerts()
        };
    }

    /**
     * Obtient les alertes actives
     */
    getActiveAlerts() {
        const alerts = [];
        const now = Date.now();
        const fiveMinutesAgo = now - 300000;
        
        // Vérifier les requêtes lentes récentes
        const recentSlowRequests = Array.from(this.metrics.requests.values())
            .filter(req => 
                req.timestamp > fiveMinutesAgo &amp;&amp; 
                req.responseTime > this.config.slowRequestThreshold
            );
        
        if (recentSlowRequests.length > 0) {
            alerts.push({
                type: 'slow_requests',
                severity: 'warning',
                count: recentSlowRequests.length,
                message: `${recentSlowRequests.length} requêtes lentes dans les 5 dernières minutes`
            });
        }
        
        // Vérifier le taux d'erreur élevé
        const recentRequests = Array.from(this.metrics.requests.values())
            .filter(req => req.timestamp > fiveMinutesAgo);
        
        const recentErrors = recentRequests.filter(req => req.statusCode >= 400);
        
        if (recentRequests.length > 0) {
            const errorRate = (recentErrors.length / recentRequests.length) * 100;
            if (errorRate > 10) { // Plus de 10% d'erreurs
                alerts.push({
                    type: 'high_error_rate',
                    severity: 'error',
                    errorRate: errorRate.toFixed(2) + '%',
                    message: `Taux d'erreur élevé: ${errorRate.toFixed(2)}%`
                });
            }
        }
        
        return alerts;
    }

    /**
     * Nettoie les métriques anciennes
     */
    cleanOldMetrics() {
        const cutoff = Date.now() - this.config.metricsRetentionTime;
        let cleaned = 0;
        
        for (const [id, request] of this.metrics.requests.entries()) {
            if (request.timestamp &lt; cutoff) {
                this.metrics.requests.delete(id);
                cleaned++;
            }
        }
        
        if (cleaned > 0) {
            this.log('debug', 'Métriques anciennes nettoyées', { cleaned });
        }
    }

    /**
     * Formate la durée d'uptime
     */
    formatUptime(ms) {
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        if (days > 0) {
            return `${days}j ${hours % 24}h ${minutes % 60}m`;
        } else if (hours > 0) {
            return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
        } else if (minutes > 0) {
            return `${minutes}m ${seconds % 60}s`;
        } else {
            return `${seconds}s`;
        }
    }

    /**
     * Génère un ID unique pour les requêtes
     */
    generateRequestId() {
        return `req_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`;
    }

    /**
     * Reset toutes les métriques
     */
    resetMetrics() {
        this.metrics = {
            requests: new Map(),
            endpoints: new Map(),
            errors: new Map(),
            system: {
                startTime: Date.now(),
                requestCount: 0,
                errorCount: 0,
                totalResponseTime: 0
            }
        };
        
        this.log('info', 'Métriques réinitialisées');
    }

    /**
     * Méthode statique pour créer une instance singleton
     */
    static create() {
        if (!PerformanceMonitoringService.instance) {
            PerformanceMonitoringService.instance = new PerformanceMonitoringService();
        }
        return PerformanceMonitoringService.instance;
    }
}

module.exports = PerformanceMonitoringService;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Actualite.html">Actualite</a></li><li><a href="AdminController.html">AdminController</a></li><li><a href="AdminOracleService.html">AdminOracleService</a></li><li><a href="AnonymousTokenService.html">AnonymousTokenService</a></li><li><a href="AuthentificationController.html">AuthentificationController</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="BasePdfKitService.html">BasePdfKitService</a></li><li><a href="BaseService.html">BaseService</a></li><li><a href="CacheService.html">CacheService</a></li><li><a href="CharacterSheetDocument.html">CharacterSheetDocument</a></li><li><a href="ClassPlanDocument.html">ClassPlanDocument</a></li><li><a href="DangerDocument.html">DangerDocument</a></li><li><a href="DemandeChangementEmail.html">DemandeChangementEmail</a></li><li><a href="Document.html">Document</a></li><li><a href="DocumentFactory.html">DocumentFactory</a></li><li><a href="DocumentModerationHistorique.html">DocumentModerationHistorique</a></li><li><a href="DocumentModerationService.html">DocumentModerationService</a></li><li><a href="DocumentSystemeJeu.html">DocumentSystemeJeu</a></li><li><a href="DocumentVote.html">DocumentVote</a></li><li><a href="DonationController.html">DonationController</a></li><li><a href="EmailService.html">EmailService</a></li><li><a href="EmailTemplate.html">EmailTemplate</a></li><li><a href="EngrenagesTheme.html">EngrenagesTheme</a></li><li><a href="GenericDocument.html">GenericDocument</a></li><li><a href="GroupDocument.html">GroupDocument</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="LoggingService.html">LoggingService</a></li><li><a href="MarkdownService.html">MarkdownService</a></li><li><a href="Metro2033Theme.html">Metro2033Theme</a></li><li><a href="MistEngineTheme.html">MistEngineTheme</a></li><li><a href="ModerationController.html">ModerationController</a></li><li><a href="MonsterheartsTheme.html">MonsterheartsTheme</a></li><li><a href="NavigationService.html">NavigationService</a></li><li><a href="Newsletter.html">Newsletter</a></li><li><a href="NewsletterService.html">NewsletterService</a></li><li><a href="Oracle.html">Oracle</a></li><li><a href="OracleController.html">OracleController</a></li><li><a href="OracleItem.html">OracleItem</a></li><li><a href="OracleService.html">OracleService</a></li><li><a href="OrganizationDocument.html">OrganizationDocument</a></li><li><a href="Pdf.html">Pdf</a></li><li><a href="PdfController.html">PdfController</a></li><li><a href="PdfKitService.html">PdfKitService</a></li><li><a href="PdfService.html">PdfService</a></li><li><a href="PerformanceMiddleware.html">PerformanceMiddleware</a></li><li><a href="PerformanceMonitoringService.html">PerformanceMonitoringService</a></li><li><a href="Personnage.html">Personnage</a></li><li><a href="PersonnageController.html">PersonnageController</a></li><li><a href="PersonnageService.html">PersonnageService</a></li><li><a href="ProductionApp.html">ProductionApp</a></li><li><a href="QueueService.html">QueueService</a></li><li><a href="RgpdConsentement.html">RgpdConsentement</a></li><li><a href="RgpdService.html">RgpdService</a></li><li><a href="SecurityService.html">SecurityService</a></li><li><a href="ShareService.html">ShareService</a></li><li><a href="SystemCardViewModel.html">SystemCardViewModel</a></li><li><a href="SystemMaintenanceService.html">SystemMaintenanceService</a></li><li><a href="SystemRightsService.html">SystemRightsService</a></li><li><a href="SystemService.html">SystemService</a></li><li><a href="SystemTheme.html">SystemTheme</a></li><li><a href="SystemThemeService.html">SystemThemeService</a></li><li><a href="SystemeJeu.html">SystemeJeu</a></li><li><a href="Temoignage.html">Temoignage</a></li><li><a href="TemoignageService.html">TemoignageService</a></li><li><a href="TemplateService.html">TemplateService</a></li><li><a href="ThemeService.html">ThemeService</a></li><li><a href="TownDocument.html">TownDocument</a></li><li><a href="Utilisateur.html">Utilisateur</a></li><li><a href="UtilisateurService.html">UtilisateurService</a></li><li><a href="VoteController.html">VoteController</a></li><li><a href="VoteService.html">VoteService</a></li><li><a href="ZombiologyTheme.html">ZombiologyTheme</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AuthComponent">AuthComponent</a></li><li><a href="global.html#InscriptionComponent">InscriptionComponent</a></li><li><a href="global.html#Joi">Joi</a></li><li><a href="global.html#MotDePasseOublieComponent">MotDePasseOublieComponent</a></li><li><a href="global.html#ReinitialiserMotDePasseComponent">ReinitialiserMotDePasseComponent</a></li><li><a href="global.html#actionFlottante">actionFlottante</a></li><li><a href="global.html#ajouterTemoignage">ajouterTemoignage</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#auth">auth</a></li><li><a href="global.html#chargerDonneesAccueil">chargerDonneesAccueil</a></li><li><a href="global.html#chargerInfosDons">chargerInfosDons</a></li><li><a href="global.html#choixModeCreation">choixModeCreation</a></li><li><a href="global.html#choixTypeDocument">choixTypeDocument</a></li><li><a href="global.html#compareVersions">compareVersions</a></li><li><a href="global.html#createError">createError</a></li><li><a href="global.html#createMigrationsTable">createMigrationsTable</a></li><li><a href="global.html#createTables">createTables</a></li><li><a href="global.html#creationPersonnage">creationPersonnage</a></li><li><a href="global.html#database">database</a></li><li><a href="global.html#elevationRole">elevationRole</a></li><li><a href="global.html#executeMigration">executeMigration</a></li><li><a href="global.html#fichePersonnage">fichePersonnage</a></li><li><a href="global.html#formaterDate">formaterDate</a></li><li><a href="global.html#formaterNombre">formaterNombre</a></li><li><a href="global.html#formaterTailleFichier">formaterTailleFichier</a></li><li><a href="global.html#genererEtoiles">genererEtoiles</a></li><li><a href="global.html#getCurrentVersion">getCurrentVersion</a></li><li><a href="global.html#getErrorMessage">getErrorMessage</a></li><li><a href="global.html#getExecutedMigrations">getExecutedMigrations</a></li><li><a href="global.html#getMigrationStatus">getMigrationStatus</a></li><li><a href="global.html#getVersionsToMigrate">getVersionsToMigrate</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#handleNotFound">handleNotFound</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#inscrireNewsletter">inscrireNewsletter</a></li><li><a href="global.html#isDatabaseInitialized">isDatabaseInitialized</a></li><li><a href="global.html#listePersonnages">listePersonnages</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#markMigrationExecuted">markMigrationExecuted</a></li><li><a href="global.html#menuUtilisateur">menuUtilisateur</a></li><li><a href="global.html#mesDocuments">mesDocuments</a></li><li><a href="global.html#migrateDatabase">migrateDatabase</a></li><li><a href="global.html#migrateToLatest">migrateToLatest</a></li><li><a href="global.html#migrateToVersion">migrateToVersion</a></li><li><a href="global.html#migrations">migrations</a></li><li><a href="global.html#navigationFormulaire">navigationFormulaire</a></li><li><a href="global.html#naviguerVersSysteme">naviguerVersSysteme</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#ouvrirLienDon">ouvrirLienDon</a></li><li><a href="global.html#partageDocument">partageDocument</a></li><li><a href="global.html#partagerPdf">partagerPdf</a></li><li><a href="global.html#path">path</a></li><li><a href="global.html#previewHtml">previewHtml</a></li><li><a href="global.html#requireAdmin">requireAdmin</a></li><li><a href="global.html#requireAuth">requireAuth</a></li><li><a href="global.html#requirePremium">requirePremium</a></li><li><a href="global.html#resetDatabase">resetDatabase</a></li><li><a href="global.html#rollbackMigration">rollbackMigration</a></li><li><a href="global.html#schemas">schemas</a></li><li><a href="global.html#scrollVersSection">scrollVersSection</a></li><li><a href="global.html#selectionSysteme">selectionSysteme</a></li><li><a href="global.html#updateAppVersion">updateAppVersion</a></li><li><a href="global.html#validateFiles">validateFiles</a></li><li><a href="global.html#validateRequest">validateRequest</a></li><li><a href="global.html#verifierAuth">verifierAuth</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Aug 08 2025 18:20:12 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
