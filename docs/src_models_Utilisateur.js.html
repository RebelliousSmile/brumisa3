<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/models/Utilisateur.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/models/Utilisateur.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const BaseModel = require('./BaseModel');
const crypto = require('crypto');

/**
 * Modèle Utilisateur
 */
class Utilisateur extends BaseModel {
    constructor() {
        super('utilisateurs', 'id');
        
        // Champs autorisés pour mass assignment
        this.fillable = [
            'nom', 'email', 'mot_de_passe', 'role', 'avatar', 
            'preferences', 'derniere_connexion', 'statut', 'actif',
            'token_recuperation', 'token_expiration'
        ];
        
        // Champs protégés
        this.guarded = ['id', 'date_creation', 'date_modification'];
        
        // Champs cachés lors de la sérialisation
        this.hidden = ['mot_de_passe'];
        
        // Conversions automatiques
        this.casts = {
            preferences: 'json',
            derniere_connexion: 'date'
        };
        
        // Gestion automatique des timestamps
        this.timestamps = true;
    }

    /**
     * Validation métier
     */
    async validate(data, operation = 'create') {
        const erreurs = [];

        // Pour les mises à jour, ne valider que les champs présents
        if (operation === 'create') {
            // Email requis pour création
            if (!data.email) {
                erreurs.push('Email requis');
            }
            
            // Nom requis pour création
            if (!data.nom || data.nom.trim().length &lt; 2) {
                erreurs.push('Nom requis (minimum 2 caractères)');
            }
            
            // Mot de passe requis pour création
            if (!data.mot_de_passe || data.mot_de_passe.length &lt; 6) {
                erreurs.push('Mot de passe requis (minimum 6 caractères)');
            }
        }

        // Validation format email si présent
        if (data.email &amp;&amp; !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
            erreurs.push('Format email invalide');
        }

        // Validation nom si présent
        if (data.nom !== undefined &amp;&amp; data.nom.trim().length &lt; 2) {
            erreurs.push('Nom requis (minimum 2 caractères)');
        }

        // Validation mot de passe si présent
        if (data.mot_de_passe !== undefined &amp;&amp; data.mot_de_passe.length &lt; 6) {
            erreurs.push('Mot de passe trop court (minimum 6 caractères)');
        }

        // Rôle valide si présent
        const rolesValides = ['UTILISATEUR', 'PREMIUM', 'ADMIN'];
        if (data.role &amp;&amp; !rolesValides.includes(data.role)) {
            erreurs.push('Rôle invalide');
        }

        // Email unique si présent
        if (data.email) {
            const existing = await this.findOne('email = ?', [data.email.toLowerCase().trim()]);
            if (existing &amp;&amp; (operation === 'create' || existing.id !== data.id)) {
                erreurs.push('Email déjà utilisé');
            }
        }

        if (erreurs.length > 0) {
            throw new Error(`Erreurs de validation: ${erreurs.join(', ')}`);
        }

        return true;
    }

    /**
     * Hash le mot de passe avant création
     */
    async beforeCreate(data) {
        if (data.mot_de_passe) {
            data.mot_de_passe = await this.hashMotDePasse(data.mot_de_passe);
        }
        
        // Rôle par défaut
        if (!data.role) {
            data.role = 'UTILISATEUR';
        }
        
        // Statut par défaut (utilise la colonne 'actif')
        if (data.actif === undefined) {
            data.actif = true;
        }

        return data;
    }

    /**
     * Hash le mot de passe avant mise à jour
     */
    async beforeUpdate(data) {
        if (data.mot_de_passe) {
            data.mot_de_passe = await this.hashMotDePasse(data.mot_de_passe);
        }
        return data;
    }

    /**
     * Hash un mot de passe
     */
    async hashMotDePasse(motDePasse) {
        return new Promise((resolve, reject) => {
            const salt = crypto.randomBytes(16).toString('hex');
            crypto.pbkdf2(motDePasse, salt, 100000, 64, 'sha512', (err, derivedKey) => {
                if (err) reject(err);
                resolve(salt + ':' + derivedKey.toString('hex'));
            });
        });
    }

    /**
     * Vérifie un mot de passe
     */
    async verifierMotDePasse(motDePasse, hash) {
        return new Promise((resolve, reject) => {
            const [salt, key] = hash.split(':');
            crypto.pbkdf2(motDePasse, salt, 100000, 64, 'sha512', (err, derivedKey) => {
                if (err) reject(err);
                resolve(key === derivedKey.toString('hex'));
            });
        });
    }

    /**
     * Trouve un utilisateur par email
     */
    async findByEmail(email) {
        return await this.findOne('email = ?', [email.toLowerCase().trim()]);
    }

    /**
     * Trouve un utilisateur par email (alias français)
     */
    async obtenirParEmail(email) {
        const { sql, params } = this.convertPlaceholders(
            `SELECT * FROM ${this.tableName} WHERE email = ? LIMIT 1`,
            [email.toLowerCase().trim()]
        );
        const db = require('../database/db');
        const result = await db.get(sql, params);
        // Ne pas utiliser serialize() pour garder le mot_de_passe pour l'authentification
        return result || null;
    }

    /**
     * Trouve un utilisateur par ID
     */
    async obtenirParId(id) {
        return await this.findById(id);
    }

    /**
     * Trouve un utilisateur par token de récupération
     */
    async obtenirParToken(token) {
        const { sql, params } = this.convertPlaceholders(
            `SELECT * FROM ${this.tableName} WHERE token_recuperation = ? AND token_expiration > ? LIMIT 1`,
            [token, new Date().toISOString()]
        );
        const db = require('../database/db');
        const result = await db.get(sql, params);
        return result ? this.serialize(result) : null;
    }

    /**
     * Authentifie un utilisateur
     */
    async authentifier(email, motDePasse) {
        const utilisateur = await this.findByEmail(email);
        
        if (!utilisateur) {
            return null;
        }

        if (!utilisateur.actif) {
            throw new Error('Compte désactivé');
        }

        const motDePasseValide = await this.verifierMotDePasse(motDePasse, utilisateur.mot_de_passe);
        
        if (!motDePasseValide) {
            return null;
        }

        // Mettre à jour dernière connexion
        await this.update(utilisateur.id, {
            derniere_connexion: new Date().toISOString()
        });

        return this.serialize(utilisateur);
    }

    /**
     * Compte les utilisateurs par rôle
     */
    async compterParRole() {
        const { sql, params } = this.convertPlaceholders(
            `SELECT role, COUNT(*) as count FROM ${this.tableName} WHERE actif = ? GROUP BY role`,
            [true]
        );
        const db = require('../database/db');
        return await db.all(sql, params);
    }

    /**
     * Liste des utilisateurs actifs récents
     */
    async listerRecents(limite = 10) {
        return await this.findAll(
            'statut = ?', 
            ['ACTIF'], 
            'derniere_connexion DESC', 
            limite
        );
    }

    /**
     * Recherche d'utilisateurs
     */
    async rechercher(query) {
        return await this.search(query, ['nom', 'email']);
    }

    /**
     * Bannir un utilisateur
     */
    async bannir(id, raison = null) {
        return await this.update(id, {
            statut: 'BANNI',
            raison_bannissement: raison
        });
    }

    /**
     * Débannir un utilisateur
     */
    async debannir(id) {
        return await this.update(id, {
            statut: 'ACTIF',
            raison_bannissement: null
        });
    }

    /**
     * Élever le rôle d'un utilisateur
     */
    async elevationRole(id, nouveauRole) {
        const rolesHierarchie = {
            'UTILISATEUR': 1,
            'PREMIUM': 2,
            'ADMIN': 3
        };

        const utilisateur = await this.findById(id);
        if (!utilisateur) {
            throw new Error('Utilisateur non trouvé');
        }

        const roleActuel = rolesHierarchie[utilisateur.role] || 0;
        const roleNouveau = rolesHierarchie[nouveauRole] || 0;

        if (roleNouveau &lt;= roleActuel) {
            throw new Error('Impossible de rétrograder ou maintenir le même rôle');
        }

        return await this.update(id, { role: nouveauRole });
    }

    /**
     * Met à jour les préférences utilisateur
     */
    async mettreAJourPreferences(id, preferences) {
        const utilisateur = await this.findById(id);
        if (!utilisateur) {
            throw new Error('Utilisateur non trouvé');
        }

        const nouvellesPreferences = {
            ...(utilisateur.preferences || {}),
            ...preferences
        };

        return await this.update(id, { preferences: nouvellesPreferences });
    }

    /**
     * RELATIONS - Récupérer les personnages de l'utilisateur
     * hasMany('personnages')
     */
    async getPersonnages(utilisateurId, filtres = {}) {
        const Personnage = require('./Personnage');
        const personnage = new Personnage();
        return await personnage.findByUtilisateur(utilisateurId, filtres);
    }

    /**
     * RELATIONS - Récupérer les documents de l'utilisateur
     * hasMany('documents')
     */
    async getDocuments(utilisateurId, filtres = {}) {
        const Document = require('./Document');
        const document = new Document();
        return await document.findVisibleBy(utilisateurId, filtres);
    }

    /**
     * RELATIONS - Récupérer les PDFs de l'utilisateur
     * hasMany('pdfs')
     */
    async getPdfs(utilisateurId, filtres = {}) {
        const Pdf = require('./Pdf');
        const pdf = new Pdf();
        return await pdf.findByUtilisateur(utilisateurId, filtres);
    }

    /**
     * RELATIONS - Récupérer les votes de l'utilisateur
     * hasMany('document_votes')
     */
    async getDocumentVotes(utilisateurId, documentId = null) {
        const DocumentVote = require('./DocumentVote');
        const vote = new DocumentVote();
        
        if (documentId) {
            return await vote.getVotesUtilisateur(utilisateurId, documentId);
        } else {
            return await vote.findAll('utilisateur_id = $1', [utilisateurId], 'date_creation DESC');
        }
    }

    /**
     * RELATIONS - Récupérer les consentements RGPD de l'utilisateur
     * hasMany('rgpd_consentements')
     */
    async getRgpdConsentements(utilisateurId) {
        const RgpdConsentement = require('./RgpdConsentement');
        const consentement = new RgpdConsentement();
        return await consentement.findAll('utilisateur_id = $1', [utilisateurId], 'date_consentement DESC');
    }

    /**
     * RELATIONS - Récupérer les demandes de changement email
     * hasMany('demandes_changement_email')
     */
    async getDemandesChangementEmail(utilisateurId, statut = null) {
        const DemandeChangementEmail = require('./DemandeChangementEmail');
        const demande = new DemandeChangementEmail();
        
        let whereClause = 'utilisateur_id = $1';
        const params = [utilisateurId];
        
        if (statut) {
            whereClause += ' AND statut = $2';
            params.push(statut);
        }
        
        return await demande.findAll(whereClause, params, 'date_demande DESC');
    }

    /**
     * RELATIONS - Récupérer l'historique de modération par cet utilisateur (si modérateur)
     * hasMany('document_moderation_historique') as moderator
     */
    async getActionsModeration(moderateurId) {
        const DocumentModerationHistorique = require('./DocumentModerationHistorique');
        const historique = new DocumentModerationHistorique();
        return await historique.getActionsModerateur(moderateurId);
    }
}

module.exports = Utilisateur;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Actualite.html">Actualite</a></li><li><a href="AdminController.html">AdminController</a></li><li><a href="AdminOracleService.html">AdminOracleService</a></li><li><a href="AnonymousTokenService.html">AnonymousTokenService</a></li><li><a href="AuthentificationController.html">AuthentificationController</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="BasePdfKitService.html">BasePdfKitService</a></li><li><a href="BaseService.html">BaseService</a></li><li><a href="CacheService.html">CacheService</a></li><li><a href="CharacterSheetDocument.html">CharacterSheetDocument</a></li><li><a href="ClassPlanDocument.html">ClassPlanDocument</a></li><li><a href="DangerDocument.html">DangerDocument</a></li><li><a href="DemandeChangementEmail.html">DemandeChangementEmail</a></li><li><a href="Document.html">Document</a></li><li><a href="DocumentFactory.html">DocumentFactory</a></li><li><a href="DocumentModerationHistorique.html">DocumentModerationHistorique</a></li><li><a href="DocumentModerationService.html">DocumentModerationService</a></li><li><a href="DocumentSystemeJeu.html">DocumentSystemeJeu</a></li><li><a href="DocumentVote.html">DocumentVote</a></li><li><a href="DonationController.html">DonationController</a></li><li><a href="EmailService.html">EmailService</a></li><li><a href="EmailTemplate.html">EmailTemplate</a></li><li><a href="EngrenagesTheme.html">EngrenagesTheme</a></li><li><a href="GenericDocument.html">GenericDocument</a></li><li><a href="GroupDocument.html">GroupDocument</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="LoggingService.html">LoggingService</a></li><li><a href="MarkdownService.html">MarkdownService</a></li><li><a href="Metro2033Theme.html">Metro2033Theme</a></li><li><a href="MistEngineTheme.html">MistEngineTheme</a></li><li><a href="ModerationController.html">ModerationController</a></li><li><a href="MonsterheartsTheme.html">MonsterheartsTheme</a></li><li><a href="NavigationService.html">NavigationService</a></li><li><a href="Newsletter.html">Newsletter</a></li><li><a href="NewsletterService.html">NewsletterService</a></li><li><a href="Oracle.html">Oracle</a></li><li><a href="OracleController.html">OracleController</a></li><li><a href="OracleItem.html">OracleItem</a></li><li><a href="OracleService.html">OracleService</a></li><li><a href="OrganizationDocument.html">OrganizationDocument</a></li><li><a href="Pdf.html">Pdf</a></li><li><a href="PdfController.html">PdfController</a></li><li><a href="PdfKitService.html">PdfKitService</a></li><li><a href="PdfService.html">PdfService</a></li><li><a href="PerformanceMiddleware.html">PerformanceMiddleware</a></li><li><a href="PerformanceMonitoringService.html">PerformanceMonitoringService</a></li><li><a href="Personnage.html">Personnage</a></li><li><a href="PersonnageController.html">PersonnageController</a></li><li><a href="PersonnageService.html">PersonnageService</a></li><li><a href="ProductionApp.html">ProductionApp</a></li><li><a href="QueueService.html">QueueService</a></li><li><a href="RgpdConsentement.html">RgpdConsentement</a></li><li><a href="RgpdService.html">RgpdService</a></li><li><a href="SecurityService.html">SecurityService</a></li><li><a href="ShareService.html">ShareService</a></li><li><a href="SystemCardViewModel.html">SystemCardViewModel</a></li><li><a href="SystemMaintenanceService.html">SystemMaintenanceService</a></li><li><a href="SystemRightsService.html">SystemRightsService</a></li><li><a href="SystemService.html">SystemService</a></li><li><a href="SystemTheme.html">SystemTheme</a></li><li><a href="SystemThemeService.html">SystemThemeService</a></li><li><a href="SystemeJeu.html">SystemeJeu</a></li><li><a href="Temoignage.html">Temoignage</a></li><li><a href="TemoignageService.html">TemoignageService</a></li><li><a href="TemplateService.html">TemplateService</a></li><li><a href="ThemeService.html">ThemeService</a></li><li><a href="TownDocument.html">TownDocument</a></li><li><a href="Utilisateur.html">Utilisateur</a></li><li><a href="UtilisateurService.html">UtilisateurService</a></li><li><a href="VoteController.html">VoteController</a></li><li><a href="VoteService.html">VoteService</a></li><li><a href="ZombiologyTheme.html">ZombiologyTheme</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AuthComponent">AuthComponent</a></li><li><a href="global.html#InscriptionComponent">InscriptionComponent</a></li><li><a href="global.html#Joi">Joi</a></li><li><a href="global.html#MotDePasseOublieComponent">MotDePasseOublieComponent</a></li><li><a href="global.html#ReinitialiserMotDePasseComponent">ReinitialiserMotDePasseComponent</a></li><li><a href="global.html#actionFlottante">actionFlottante</a></li><li><a href="global.html#ajouterTemoignage">ajouterTemoignage</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#auth">auth</a></li><li><a href="global.html#chargerDonneesAccueil">chargerDonneesAccueil</a></li><li><a href="global.html#chargerInfosDons">chargerInfosDons</a></li><li><a href="global.html#choixModeCreation">choixModeCreation</a></li><li><a href="global.html#choixTypeDocument">choixTypeDocument</a></li><li><a href="global.html#compareVersions">compareVersions</a></li><li><a href="global.html#createError">createError</a></li><li><a href="global.html#createMigrationsTable">createMigrationsTable</a></li><li><a href="global.html#createTables">createTables</a></li><li><a href="global.html#creationPersonnage">creationPersonnage</a></li><li><a href="global.html#database">database</a></li><li><a href="global.html#elevationRole">elevationRole</a></li><li><a href="global.html#executeMigration">executeMigration</a></li><li><a href="global.html#fichePersonnage">fichePersonnage</a></li><li><a href="global.html#formaterDate">formaterDate</a></li><li><a href="global.html#formaterNombre">formaterNombre</a></li><li><a href="global.html#formaterTailleFichier">formaterTailleFichier</a></li><li><a href="global.html#genererEtoiles">genererEtoiles</a></li><li><a href="global.html#getCurrentVersion">getCurrentVersion</a></li><li><a href="global.html#getErrorMessage">getErrorMessage</a></li><li><a href="global.html#getExecutedMigrations">getExecutedMigrations</a></li><li><a href="global.html#getMigrationStatus">getMigrationStatus</a></li><li><a href="global.html#getVersionsToMigrate">getVersionsToMigrate</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#handleNotFound">handleNotFound</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#inscrireNewsletter">inscrireNewsletter</a></li><li><a href="global.html#isDatabaseInitialized">isDatabaseInitialized</a></li><li><a href="global.html#listePersonnages">listePersonnages</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#markMigrationExecuted">markMigrationExecuted</a></li><li><a href="global.html#menuUtilisateur">menuUtilisateur</a></li><li><a href="global.html#mesDocuments">mesDocuments</a></li><li><a href="global.html#migrateDatabase">migrateDatabase</a></li><li><a href="global.html#migrateToLatest">migrateToLatest</a></li><li><a href="global.html#migrateToVersion">migrateToVersion</a></li><li><a href="global.html#migrations">migrations</a></li><li><a href="global.html#navigationFormulaire">navigationFormulaire</a></li><li><a href="global.html#naviguerVersSysteme">naviguerVersSysteme</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#ouvrirLienDon">ouvrirLienDon</a></li><li><a href="global.html#partageDocument">partageDocument</a></li><li><a href="global.html#partagerPdf">partagerPdf</a></li><li><a href="global.html#path">path</a></li><li><a href="global.html#previewHtml">previewHtml</a></li><li><a href="global.html#requireAdmin">requireAdmin</a></li><li><a href="global.html#requireAuth">requireAuth</a></li><li><a href="global.html#requirePremium">requirePremium</a></li><li><a href="global.html#resetDatabase">resetDatabase</a></li><li><a href="global.html#rollbackMigration">rollbackMigration</a></li><li><a href="global.html#schemas">schemas</a></li><li><a href="global.html#scrollVersSection">scrollVersSection</a></li><li><a href="global.html#selectionSysteme">selectionSysteme</a></li><li><a href="global.html#updateAppVersion">updateAppVersion</a></li><li><a href="global.html#validateFiles">validateFiles</a></li><li><a href="global.html#validateRequest">validateRequest</a></li><li><a href="global.html#verifierAuth">verifierAuth</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Aug 08 2025 18:20:12 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
