<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: models/DocumentSystemeJeu.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: models/DocumentSystemeJeu.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const BaseModel = require('./BaseModel');
const Joi = require('joi');

/**
 * Modèle DocumentSystemeJeu - Maintenance granulaire par type de document et système JDR
 * 
 * Cette table gère la maintenance granulaire TYPE par TYPE pour chaque système JDR.
 * Elle permet de désactiver/activer des types spécifiques sans affecter tout le système.
 * 
 * Fonctionnalités:
 * - Maintenance granulaire TYPE par TYPE (ex: désactiver uniquement TOWN pour Monsterhearts)
 * - Ordre d'affichage personnalisé par système
 * - Configuration JSONB flexible (champs requis, templates, validations par combinaison)
 * - Double validation : Système actif (systemes_jeu) ET type actif (document_systeme_jeu)
 */
class DocumentSystemeJeu extends BaseModel {
  constructor() {
    super('document_systeme_jeu', null); // Clé primaire composite
    
    this.fillable = [
      'document_type',
      'systeme_jeu',
      'actif',
      'ordre_affichage',
      'configuration'
    ];
    
    this.hidden = [];
    
    this.casts = {
      actif: 'boolean',
      ordre_affichage: 'integer',
      configuration: 'json',
      date_ajout: 'date',
      date_modification: 'date'
    };
    
    this.timestamps = true;
    
    // Modification du nom des champs de timestamp pour cette table
    this.timestampFields = {
      created: 'date_ajout',
      updated: 'date_modification'
    };
  }

  /**
   * Types de documents disponibles
   */
  static get TYPES_DOCUMENTS() {
    return [
      'CHARACTER',
      'TOWN',
      'GROUP',
      'ORGANIZATION', 
      'DANGER',
      'GENERIQUE'
    ];
  }

  /**
   * Override des méthodes CRUD pour gérer la clé composite
   */
  async findByCompositeKey(documentType, systemeJeu) {
    const { sql, params } = this.convertPlaceholders(
      `SELECT * FROM ${this.tableName} WHERE document_type = ? AND systeme_jeu = ?`,
      [documentType, systemeJeu]
    );
    const db = require('../database/db');
    const row = await db.get(sql, params);
    return row ? this.castAttributes(row) : null;
  }

  /**
   * Schema de validation Joi
   */
  getValidationSchema(operation = 'create') {
    const typesDocuments = DocumentSystemeJeu.TYPES_DOCUMENTS;
    const SystemeJeu = require('./SystemeJeu');
    const systemesValides = SystemeJeu.SYSTEMES_SUPPORTES;
    
    const baseSchema = {
      document_type: Joi.string().valid(...typesDocuments).required()
        .messages({
          'string.base': 'Le type de document doit être une chaîne de caractères',
          'any.only': `Le type de document doit être l'un des suivants: ${typesDocuments.join(', ')}`,
          'any.required': 'Le type de document est requis'
        }),
        
      systeme_jeu: Joi.string().valid(...systemesValides).required()
        .messages({
          'string.base': 'Le système JDR doit être une chaîne de caractères',
          'any.only': `Le système JDR doit être l'un des suivants: ${systemesValides.join(', ')}`,
          'any.required': 'Le système JDR est requis'
        }),
        
      actif: Joi.boolean().default(true)
        .messages({
          'boolean.base': 'Le statut actif doit être un booléen'
        }),
        
      ordre_affichage: Joi.number().integer().min(0).default(0)
        .messages({
          'number.base': 'L\'ordre d\'affichage doit être un nombre',
          'number.integer': 'L\'ordre d\'affichage doit être un entier',
          'number.min': 'L\'ordre d\'affichage ne peut pas être négatif'
        }),
        
      configuration: Joi.object({
        champs_requis: Joi.array().items(Joi.string()).default([]),
        template_pdf: Joi.string().optional(),
        validation_custom: Joi.array().items(Joi.string()).default([]),
        couleur_theme: Joi.string().pattern(/^#[0-9A-Fa-f]{6}$/).optional(),
        description: Joi.string().max(500).optional(),
        exemple_donnees: Joi.object().optional()
      }).optional().default({})
        .messages({
          'object.base': 'La configuration doit être un objet JSON'
        })
    };

    return Joi.object(baseSchema);
  }

  /**
   * Validation métier spécifique
   */
  async businessValidation(data, operation = 'create') {
    // Vérifier que le système JDR existe
    if (data.systeme_jeu) {
      const SystemeJeu = require('./SystemeJeu');
      const systemeJeu = new SystemeJeu();
      const systeme = await systemeJeu.findById(data.systeme_jeu);
      
      if (!systeme) {
        throw new Error('Le système JDR spécifié n\'existe pas');
      }
    }

    return true;
  }

  /**
   * Override create pour gérer la clé composite
   */
  async create(data) {
    // Vérifier si la combinaison existe déjà
    const existing = await this.findByCompositeKey(data.document_type, data.systeme_jeu);
    if (existing) {
      throw new Error(`La configuration pour ${data.document_type}/${data.systeme_jeu} existe déjà`);
    }

    // Validation et nettoyage des données
    let cleanData = this.fillableData(data);
    
    // Hook beforeCreate
    cleanData = await this.beforeCreate(cleanData);
    
    if (this.timestamps) {
      cleanData[this.timestampFields.created] = new Date().toISOString();
      cleanData[this.timestampFields.updated] = new Date().toISOString();
    }

    // Validation métier
    await this.validate(cleanData, 'create');

    // Construction de la requête
    const fields = Object.keys(cleanData);
    const placeholders = fields.map(() => '?').join(', ');
    const values = Object.values(cleanData);

    const { sql, params } = this.convertPlaceholders(
      `INSERT INTO ${this.tableName} (${fields.join(', ')}) VALUES (${placeholders}) RETURNING document_type, systeme_jeu`,
      values
    );

    const db = require('../database/db');
    const result = await db.get(sql, params);
    
    if (this.logManager &amp;&amp; this.logManager.logDatabaseOperation) {
      this.logManager.logDatabaseOperation('create', this.tableName, `${result.document_type}/${result.systeme_jeu}`, true);
    }
    
    // Retourne l'enregistrement créé
    const createdRecord = await this.findByCompositeKey(result.document_type, result.systeme_jeu);
    
    // Hook afterCreate
    const finalRecord = await this.afterCreate(createdRecord);
    
    return finalRecord;
  }

  /**
   * Override update pour gérer la clé composite
   */
  async updateByCompositeKey(documentType, systemeJeu, data) {
    let cleanData = this.fillableData(data);
    
    // Hook beforeUpdate
    cleanData = await this.beforeUpdate(cleanData);
    
    if (this.timestamps) {
      cleanData[this.timestampFields.updated] = new Date().toISOString();
    }

    // Validation métier
    await this.validate(cleanData, 'update');

    const fields = Object.keys(cleanData);
    const setClause = fields.map(field => `${field} = ?`).join(', ');
    const values = [...Object.values(cleanData), documentType, systemeJeu];

    const { sql, params } = this.convertPlaceholders(
      `UPDATE ${this.tableName} SET ${setClause} WHERE document_type = ? AND systeme_jeu = ?`,
      values
    );

    const db = require('../database/db');
    const result = await db.run(sql, params);
    
    if (result.rowCount === 0) {
      throw new Error(`Aucun enregistrement trouvé pour ${documentType}/${systemeJeu}`);
    }

    if (this.logManager &amp;&amp; this.logManager.logDatabaseOperation) {
      this.logManager.logDatabaseOperation('update', this.tableName, `${documentType}/${systemeJeu}`, true);
    }
    
    // Récupère l'enregistrement mis à jour
    const updatedRecord = await this.findByCompositeKey(documentType, systemeJeu);
    
    // Hook afterUpdate
    const finalRecord = await this.afterUpdate(updatedRecord);
    
    return finalRecord;
  }

  /**
   * Récupérer les types actifs et disponibles pour un système
   * 
   * @param {string} systeme - ID du système JDR
   * @returns {Array} Types de documents actifs
   */
  async getTypesActifs(systeme) {
    return await this.findAll(
      'systeme_jeu = $1 AND actif = $2',
      [systeme, true],
      'ordre_affichage ASC, document_type ASC'
    );
  }

  /**
   * Récupérer tous les types configurés pour un système (actifs + inactifs)
   * 
   * @param {string} systeme - ID du système JDR
   * @returns {Array} Tous les types configurés
   */
  async getTypesDisponibles(systeme) {
    return await this.findAll(
      'systeme_jeu = $1',
      [systeme],
      'ordre_affichage ASC, document_type ASC'
    );
  }

  /**
   * Activer ou désactiver un type spécifique pour un système
   * 
   * @param {string} type - Type de document
   * @param {string} systeme - ID du système JDR
   * @param {boolean} actif - Nouvel état
   * @returns {Object} Configuration mise à jour
   */
  async activerType(type, systeme, actif) {
    const existing = await this.findByCompositeKey(type, systeme);
    
    if (!existing) {
      // Créer la configuration si elle n'existe pas
      return await this.create({
        document_type: type,
        systeme_jeu: systeme,
        actif: actif,
        configuration: this.getConfigurationParDefaut(type)
      });
    } else {
      // Mettre à jour l'existant
      return await this.updateByCompositeKey(type, systeme, { actif });
    }
  }

  /**
   * Récupérer la configuration JSONB d'une combinaison type/système
   * 
   * @param {string} type - Type de document
   * @param {string} systeme - ID du système JDR
   * @returns {Object|null} Configuration JSONB
   */
  async getConfiguration(type, systeme) {
    const record = await this.findByCompositeKey(type, systeme);
    return record ? record.configuration : null;
  }

  /**
   * Vérifier la disponibilité d'un type pour un système (double validation)
   * 
   * @param {string} type - Type de document
   * @param {string} systeme - ID du système JDR
   * @returns {Object} Résultat de vérification avec détails
   */
  async verifierDisponibilite(type, systeme) {
    // 1. Vérifier que le système JDR est actif
    const SystemeJeu = require('./SystemeJeu');
    const systemeJeu = new SystemeJeu();
    const systemeInfo = await systemeJeu.findById(systeme);
    
    if (!systemeInfo) {
      return {
        disponible: false,
        raison: 'SYSTEME_INEXISTANT',
        message: 'Le système JDR spécifié n\'existe pas'
      };
    }
    
    if (systemeInfo.statut !== SystemeJeu.STATUTS.ACTIF) {
      return {
        disponible: false,
        raison: 'SYSTEME_INDISPONIBLE',
        message: `Le système ${systemeInfo.nom_complet} est actuellement ${systemeInfo.statut.toLowerCase()}`,
        message_maintenance: systemeInfo.message_maintenance
      };
    }

    // 2. Vérifier que le type est activé pour ce système
    const typeConfig = await this.findByCompositeKey(type, systeme);
    
    if (!typeConfig) {
      return {
        disponible: false,
        raison: 'TYPE_NON_CONFIGURE',
        message: `Le type ${type} n'est pas configuré pour le système ${systemeInfo.nom_complet}`
      };
    }
    
    if (!typeConfig.actif) {
      return {
        disponible: false,
        raison: 'TYPE_DESACTIVE',
        message: `Le type ${type} est temporairement désactivé pour le système ${systemeInfo.nom_complet}`
      };
    }

    // 3. Tout est OK
    return {
      disponible: true,
      raison: 'DISPONIBLE',
      message: 'Le type de document est disponible pour ce système',
      systeme_info: systemeInfo,
      type_config: typeConfig
    };
  }

  /**
   * Mettre à jour l'ordre d'affichage des types pour un système
   * 
   * @param {string} systeme - ID du système JDR
   * @param {Array} ordres - Tableau d'objets {type, ordre}
   * @returns {Array} Configurations mises à jour
   */
  async mettreAJourOrdre(systeme, ordres) {
    const results = [];
    
    for (const item of ordres) {
      if (!item.type || typeof item.ordre !== 'number') {
        throw new Error('Format invalide pour les ordres. Attendu: [{type: string, ordre: number}]');
      }
      
      const updated = await this.updateByCompositeKey(item.type, systeme, {
        ordre_affichage: item.ordre
      });
      results.push(updated);
    }
    
    return results;
  }

  /**
   * Configuration par défaut pour un type de document
   * 
   * @param {string} type - Type de document
   * @returns {Object} Configuration par défaut
   */
  getConfigurationParDefaut(type) {
    const configs = {
      CHARACTER: {
        champs_requis: ['nom'],
        template_pdf: 'default_character',
        validation_custom: [],
        description: 'Fiche de personnage complète'
      },
      TOWN: {
        champs_requis: ['nom', 'description'],
        template_pdf: 'default_town',
        validation_custom: [],
        description: 'Cadre de ville ou lieu important'
      },
      GROUP: {
        champs_requis: ['nom', 'type'],
        template_pdf: 'default_group',
        validation_custom: [],
        description: 'Groupe, classe, organisation'
      },
      ORGANIZATION: {
        champs_requis: ['nom', 'description'],
        template_pdf: 'default_organization',
        validation_custom: [],
        description: 'Liste de PNJ structurée'
      },
      DANGER: {
        champs_requis: ['nom', 'type_danger'],
        template_pdf: 'default_danger',
        validation_custom: [],
        description: 'Front, danger ou menace'
      },
      GENERIQUE: {
        champs_requis: ['titre'],
        template_pdf: 'default_generic',
        validation_custom: [],
        description: 'Document libre ou journal'
      }
    };

    return configs[type] || configs.GENERIQUE;
  }

  /**
   * Initialiser les configurations par défaut pour un système
   * 
   * @param {string} systeme - ID du système JDR
   * @param {Array} typesActifs - Types à activer (optionnel, tous par défaut)
   * @returns {Array} Configurations créées
   */
  async initialiserConfigurationsDefaut(systeme, typesActifs = null) {
    const types = typesActifs || DocumentSystemeJeu.TYPES_DOCUMENTS;
    const results = [];
    
    for (let i = 0; i &lt; types.length; i++) {
      const type = types[i];
      
      try {
        const existing = await this.findByCompositeKey(type, systeme);
        if (!existing) {
          const config = await this.create({
            document_type: type,
            systeme_jeu: systeme,
            actif: true,
            ordre_affichage: i + 1,
            configuration: this.getConfigurationParDefaut(type)
          });
          results.push(config);
        } else {
          results.push(existing);
        }
      } catch (error) {
        throw new Error(`Erreur lors de l'initialisation de ${type}/${systeme}: ${error.message}`);
      }
    }
    
    return results;
  }

  /**
   * Vue d'ensemble de toutes les configurations par système
   * 
   * @returns {Object} Configurations groupées par système
   */
  async getVueEnsemble() {
    const db = require('../database/db');
    
    const sql = `
      SELECT 
        dsj.*,
        sj.nom_complet as systeme_nom,
        sj.statut as systeme_statut,
        sj.couleur_theme
      FROM document_systeme_jeu dsj
      LEFT JOIN systemes_jeu sj ON dsj.systeme_jeu = sj.id
      ORDER BY sj.ordre_affichage ASC, dsj.ordre_affichage ASC
    `;
    
    const rows = await db.all(sql);
    const configurations = rows.map(row => this.castAttributes(row));
    
    // Grouper par système
    const grouped = {};
    configurations.forEach(config => {
      if (!grouped[config.systeme_jeu]) {
        grouped[config.systeme_jeu] = {
          systeme: {
            id: config.systeme_jeu,
            nom: config.systeme_nom,
            statut: config.systeme_statut,
            couleur: config.couleur_theme
          },
          types: []
        };
      }
      
      grouped[config.systeme_jeu].types.push({
        type: config.document_type,
        actif: config.actif,
        ordre: config.ordre_affichage,
        configuration: config.configuration
      });
    });
    
    return grouped;
  }

  /**
   * Override des hooks pour gérer les timestamps personnalisés
   */
  async beforeCreate(data) {
    if (this.timestamps) {
      data[this.timestampFields.created] = new Date().toISOString();
      data[this.timestampFields.updated] = new Date().toISOString();
    }
    return data;
  }

  async beforeUpdate(data) {
    if (this.timestamps) {
      data[this.timestampFields.updated] = new Date().toISOString();
    }
    return data;
  }
}

module.exports = DocumentSystemeJeu;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Actualite.html">Actualite</a></li><li><a href="AdminController.html">AdminController</a></li><li><a href="AdminOracleService.html">AdminOracleService</a></li><li><a href="AnonymousTokenService.html">AnonymousTokenService</a></li><li><a href="AuthentificationController.html">AuthentificationController</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="BasePdfKitService.html">BasePdfKitService</a></li><li><a href="BaseService.html">BaseService</a></li><li><a href="CacheService.html">CacheService</a></li><li><a href="CharacterSheetDocument.html">CharacterSheetDocument</a></li><li><a href="ClassPlanDocument.html">ClassPlanDocument</a></li><li><a href="DangerDocument.html">DangerDocument</a></li><li><a href="DemandeChangementEmail.html">DemandeChangementEmail</a></li><li><a href="Document.html">Document</a></li><li><a href="DocumentFactory.html">DocumentFactory</a></li><li><a href="DocumentModerationHistorique.html">DocumentModerationHistorique</a></li><li><a href="DocumentModerationService.html">DocumentModerationService</a></li><li><a href="DocumentSystemeJeu.html">DocumentSystemeJeu</a></li><li><a href="DocumentVote.html">DocumentVote</a></li><li><a href="DonationController.html">DonationController</a></li><li><a href="EmailService.html">EmailService</a></li><li><a href="EmailTemplate.html">EmailTemplate</a></li><li><a href="EngrenagesTheme.html">EngrenagesTheme</a></li><li><a href="GenericDocument.html">GenericDocument</a></li><li><a href="GroupDocument.html">GroupDocument</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="LoggingService.html">LoggingService</a></li><li><a href="MaintenanceWorker.html">MaintenanceWorker</a></li><li><a href="MarkdownService.html">MarkdownService</a></li><li><a href="Metro2033Theme.html">Metro2033Theme</a></li><li><a href="MistEngineTheme.html">MistEngineTheme</a></li><li><a href="ModerationController.html">ModerationController</a></li><li><a href="MonsterheartsTheme.html">MonsterheartsTheme</a></li><li><a href="Newsletter.html">Newsletter</a></li><li><a href="NewsletterService.html">NewsletterService</a></li><li><a href="Oracle.html">Oracle</a></li><li><a href="OracleController.html">OracleController</a></li><li><a href="OracleItem.html">OracleItem</a></li><li><a href="OracleService.html">OracleService</a></li><li><a href="OrganizationDocument.html">OrganizationDocument</a></li><li><a href="Pdf.html">Pdf</a></li><li><a href="PdfController.html">PdfController</a></li><li><a href="PdfKitService.html">PdfKitService</a></li><li><a href="PdfService.html">PdfService</a></li><li><a href="PerformanceMiddleware.html">PerformanceMiddleware</a></li><li><a href="PerformanceMonitoringService.html">PerformanceMonitoringService</a></li><li><a href="Personnage.html">Personnage</a></li><li><a href="PersonnageController.html">PersonnageController</a></li><li><a href="PersonnageService.html">PersonnageService</a></li><li><a href="ProductionApp.html">ProductionApp</a></li><li><a href="QueueService.html">QueueService</a></li><li><a href="QueueWorker.html">QueueWorker</a></li><li><a href="RgpdConsentement.html">RgpdConsentement</a></li><li><a href="RgpdService.html">RgpdService</a></li><li><a href="SecurityService.html">SecurityService</a></li><li><a href="ShareService.html">ShareService</a></li><li><a href="SystemCardViewModel.html">SystemCardViewModel</a></li><li><a href="SystemMaintenanceService.html">SystemMaintenanceService</a></li><li><a href="SystemRightsService.html">SystemRightsService</a></li><li><a href="SystemService.html">SystemService</a></li><li><a href="SystemTheme.html">SystemTheme</a></li><li><a href="SystemThemeService.html">SystemThemeService</a></li><li><a href="SystemeJeu.html">SystemeJeu</a></li><li><a href="Temoignage.html">Temoignage</a></li><li><a href="TemoignageService.html">TemoignageService</a></li><li><a href="TemplateService.html">TemplateService</a></li><li><a href="TownDocument.html">TownDocument</a></li><li><a href="Utilisateur.html">Utilisateur</a></li><li><a href="UtilisateurService.html">UtilisateurService</a></li><li><a href="VoteController.html">VoteController</a></li><li><a href="VoteService.html">VoteService</a></li><li><a href="ZombiologyTheme.html">ZombiologyTheme</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Joi">Joi</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#auth">auth</a></li><li><a href="global.html#compareVersions">compareVersions</a></li><li><a href="global.html#createError">createError</a></li><li><a href="global.html#createMigrationsTable">createMigrationsTable</a></li><li><a href="global.html#createTables">createTables</a></li><li><a href="global.html#database">database</a></li><li><a href="global.html#executeMigration">executeMigration</a></li><li><a href="global.html#getCurrentVersion">getCurrentVersion</a></li><li><a href="global.html#getErrorMessage">getErrorMessage</a></li><li><a href="global.html#getExecutedMigrations">getExecutedMigrations</a></li><li><a href="global.html#getMigrationStatus">getMigrationStatus</a></li><li><a href="global.html#getVersionsToMigrate">getVersionsToMigrate</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#handleNotFound">handleNotFound</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#isDatabaseInitialized">isDatabaseInitialized</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#markMigrationExecuted">markMigrationExecuted</a></li><li><a href="global.html#migrateDatabase">migrateDatabase</a></li><li><a href="global.html#migrateToLatest">migrateToLatest</a></li><li><a href="global.html#migrateToVersion">migrateToVersion</a></li><li><a href="global.html#migrations">migrations</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#path">path</a></li><li><a href="global.html#requireAdmin">requireAdmin</a></li><li><a href="global.html#requireAuth">requireAuth</a></li><li><a href="global.html#requirePremium">requirePremium</a></li><li><a href="global.html#resetDatabase">resetDatabase</a></li><li><a href="global.html#rollbackMigration">rollbackMigration</a></li><li><a href="global.html#schemas">schemas</a></li><li><a href="global.html#updateAppVersion">updateAppVersion</a></li><li><a href="global.html#validateFiles">validateFiles</a></li><li><a href="global.html#validateRequest">validateRequest</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Aug 08 2025 18:17:39 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
