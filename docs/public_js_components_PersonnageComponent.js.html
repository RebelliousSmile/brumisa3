<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: public/js/components/PersonnageComponent.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: public/js/components/PersonnageComponent.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// ========================================
// Composants Alpine personnages
// ========================================

/**
 * Composant pour la liste des personnages
 */
function listePersonnages() {
    return {
        // État local
        personnages: [],
        personnagesFiltres: [],
        filtreSysteme: '',
        chargement: true,
        
        // Initialisation
        async init() {
            await this.chargerPersonnages();
        },
        
        // Méthodes
        async chargerPersonnages() {
            try {
                this.chargement = true;
                this.personnages = await window.personnageService.lister();
                this.filtrerPersonnages();
            } catch (erreur) {
                console.error('Erreur chargement personnages:', erreur);
            } finally {
                this.chargement = false;
            }
        },
        
        filtrerPersonnages() {
            if (this.filtreSysteme === '') {
                this.personnagesFiltres = this.personnages;
            } else {
                this.personnagesFiltres = this.personnages.filter(p => p.systeme_jeu === this.filtreSysteme);
            }
        },
        
        async genererPdf(idPersonnage) {
            try {
                const pdf = await window.personnageService.genererPdf(idPersonnage);
                // Rediriger vers la page du PDF
                window.location.href = `/pdfs/${pdf.id}`;
            } catch (erreur) {
                console.error('Erreur génération PDF:', erreur);
            }
        },
        
        async dupliquer(idPersonnage) {
            const personnage = this.personnages.find(p => p.id === idPersonnage);
            const nouveauNom = prompt('Nom du personnage dupliqué :', `${personnage.nom} (Copie)`);
            
            if (!nouveauNom) return;
            
            try {
                const nouveauPersonnage = await window.personnageService.dupliquer(idPersonnage, nouveauNom);
                await this.chargerPersonnages();
                
                // Optionnel: rediriger vers le nouveau personnage
                window.location.href = `/personnages/${nouveauPersonnage.id}`;
            } catch (erreur) {
                console.error('Erreur duplication:', erreur);
            }
        },
        
        async supprimer(idPersonnage) {
            const personnage = this.personnages.find(p => p.id === idPersonnage);
            
            if (!confirm(`Êtes-vous sûr de vouloir supprimer "${personnage.nom}" ?`)) {
                return;
            }
            
            try {
                await window.personnageService.supprimer(idPersonnage);
                this.personnages = this.personnages.filter(p => p.id !== idPersonnage);
                this.filtrerPersonnages();
            } catch (erreur) {
                console.error('Erreur suppression:', erreur);
            }
        },
        
        // Getters
        get statistiques() {
            return {
                total: this.personnages.length,
                parSysteme: this.personnages.reduce((acc, p) => {
                    acc[p.systeme_jeu] = (acc[p.systeme_jeu] || 0) + 1;
                    return acc;
                }, {})
            };
        }
    };
}

/**
 * Composant pour la sélection de système (landing page)
 */
function selectionSysteme() {
    return {
        systemes: Alpine.store('app').systemes,
        
        init() {
            // Animation d'entrée des cartes
            this.$nextTick(() => {
                const cartes = this.$el.querySelectorAll('[data-carte-systeme]');
                cartes.forEach((carte, index) => {
                    carte.style.animationDelay = `${index * 100}ms`;
                    carte.classList.add('animate-fade-in-up');
                });
            });
        },
        
        naviguerVersSysteme(systemeId) {
            // Utiliser le service de navigation centralisé
            if (window.navigationService) {
                window.navigationService.naviguerVersSysteme(systemeId);
            } else {
                // Fallback si le service n'est pas chargé
                window.location.href = `/systemes/${systemeId}`;
            }
        }
    };
}

/**
 * Composant pour la sélection du type de document
 */
function choixTypeDocument(systeme) {
    return {
        systeme,
        typesDocuments: [
            {
                id: 'fiche-personnage',
                nom: 'Fiche de personnage',
                description: 'Créez une fiche complète pour votre personnage',
                icone: '👤',
                url: `/${systeme}/fiche-personnage`
            },
            {
                id: 'plan-classe',
                nom: 'Plan de classe/groupe',
                description: 'Organisez votre groupe de joueurs',
                icone: '👥',
                url: `/${systeme}/plan-classe`
            },
            {
                id: 'cadre-campagne',
                nom: 'Cadre de campagne',
                description: 'Définissez l\'univers de votre campagne',
                icone: '🗺️',
                url: `/${systeme}/cadre-campagne`
            },
            {
                id: 'aide-jeu',
                nom: 'Aide de jeu',
                description: 'Créez des aides-mémoire personnalisées',
                icone: '📖',
                url: `/${systeme}/aide-jeu`
            }
        ],
        
        naviguerVersType(typeId) {
            const type = this.typesDocuments.find(t => t.id === typeId);
            if (type) {
                window.location.href = type.url;
            }
        }
    };
}

/**
 * Composant pour le choix du mode de création
 */
function choixModeCreation(systeme, typeDocument) {
    return {
        systeme,
        typeDocument,
        modes: [
            {
                id: 'scratch',
                nom: 'Créer de zéro',
                description: 'Commencez avec un formulaire vierge',
                icone: '✨',
                populaire: false
            },
            {
                id: 'template',
                nom: 'Partir d\'un exemple',
                description: 'Utilisez un modèle pré-rempli',
                icone: '📋',
                populaire: true
            },
            {
                id: 'wizard',
                nom: 'Assistant guidé',
                description: 'Laissez-vous guider étape par étape',
                icone: '🧙‍♂️',
                populaire: false
            }
        ],
        
        demarrerCreation(modeId) {
            const url = `/${this.systeme}/${this.typeDocument}/creation?mode=${modeId}`;
            window.location.href = url;
        }
    };
}

/**
 * Composant pour la création de personnage
 */
function creationPersonnage(systeme, templateSysteme, mode = 'scratch') {
    return {
        // État
        systeme,
        templateSysteme,
        mode,
        enTraitement: false,
        erreurs: [],
        sauvegardeAuto: true,
        
        // Formulaire
        formulaire: {
            nom: '',
            systeme_jeu: systeme,
            attributs: {},
            competences: {},
            avantages: {},
            equipement: {},
            historique: {},
            notes: ''
        },
        
        // Initialisation
        init() {
            this.initialiserFormulaire();
            this.configurerSauvegardeAuto();
            this.chargerBrouillonLocal();
        },
        
        // Méthodes
        initialiserFormulaire() {
            // Initialiser les attributs avec valeurs par défaut
            if (this.templateSysteme.attributs) {
                Object.entries(this.templateSysteme.attributs).forEach(([nom, config]) => {
                    this.formulaire.attributs[nom] = config.defaut || config.min || 0;
                });
            }
            
            // Charger template si mode template
            if (this.mode === 'template') {
                this.chargerTemplate();
            }
        },
        
        async chargerTemplate() {
            try {
                const template = await window.personnageService.obtenirTemplate(this.systeme);
                if (template) {
                    this.formulaire = { ...this.formulaire, ...template };
                }
            } catch (erreur) {
                console.error('Erreur chargement template:', erreur);
            }
        },
        
        configurerSauvegardeAuto() {
            if (this.sauvegardeAuto) {
                // Watcher pour auto-sauvegarde
                this.$watch('formulaire', () => {
                    Alpine.store('navigation').markDirty();
                    this.planifierSauvegardeAuto();
                }, { deep: true });
            }
        },
        
        planifierSauvegardeAuto() {
            clearTimeout(this.autoSaveTimeout);
            this.autoSaveTimeout = setTimeout(() => {
                this.sauvegarderAuto();
            }, 3000);
        },
        
        async sauvegarderAuto() {
            if (this.formulaire.nom.trim().length > 0) {
                try {
                    await window.personnageService.sauvegarderBrouillon(this.formulaire);
                } catch (erreur) {
                    // Sauvegarde locale en cas d'erreur
                    Alpine.store('creation').sauvegarderLocalement(this.formulaire);
                }
            }
        },
        
        chargerBrouillonLocal() {
            const brouillons = Alpine.store('creation').getFormulaireSauvegardes();
            const brouillonSysteme = brouillons.find(b => b.data.systeme_jeu === this.systeme);
            
            if (brouillonSysteme &amp;&amp; confirm('Un brouillon a été trouvé. Voulez-vous le récupérer ?')) {
                this.formulaire = { ...this.formulaire, ...brouillonSysteme.data };
            }
        },
        
        modifierAttribut(nom, delta) {
            const config = this.templateSysteme.attributs[nom];
            const nouvelleValeur = this.formulaire.attributs[nom] + delta;
            
            if (nouvelleValeur >= config.min &amp;&amp; nouvelleValeur &lt;= config.max) {
                this.formulaire.attributs[nom] = nouvelleValeur;
            }
        },
        
        validerFormulaire() {
            this.erreurs = window.personnageService.validerDonnees(this.formulaire, this.systeme);
            return this.erreurs.length === 0;
        },
        
        async soumettre() {
            if (this.enTraitement) return;
            
            if (!this.validerFormulaire()) {
                this.erreurs.forEach(erreur => {
                    Alpine.store('app').ajouterMessage('erreur', erreur);
                });
                return;
            }
            
            this.enTraitement = true;
            
            try {
                const personnage = await window.personnageService.creer(this.formulaire);
                
                // Nettoyer la sauvegarde locale
                Alpine.store('creation').supprimerLocal(`formulaire_${this.systeme}`);
                Alpine.store('navigation').markClean();
                
                // Rediriger vers la fiche du personnage
                window.location.href = `/personnages/${personnage.id}`;
            } catch (erreur) {
                console.error('Erreur création personnage:', erreur);
            } finally {
                this.enTraitement = false;
            }
        }
    };
}

/**
 * Composant pour l'affichage d'un personnage
 */
function fichePersonnage(personnage) {
    return {
        // État
        personnage,
        pdfs: [],
        chargementPdfs: false,
        
        // Initialisation
        async init() {
            await this.chargerPdfs();
        },
        
        // Méthodes
        async chargerPdfs() {
            try {
                this.chargementPdfs = true;
                const todsPdfs = await window.pdfService.lister();
                this.pdfs = todsPdfs.filter(pdf => pdf.personnage_id === this.personnage.id);
            } catch (erreur) {
                console.error('Erreur chargement PDFs:', erreur);
            } finally {
                this.chargementPdfs = false;
            }
        },
        
        async genererPdf(typePdf = 'fiche_personnage') {
            try {
                const pdf = await window.personnageService.genererPdf(this.personnage.id, { type: typePdf });
                
                // Démarrer le suivi de génération
                window.pdfService.suivreGeneration(pdf.id, (statut) => {
                    if (statut.statut === 'TERMINE') {
                        Alpine.store('app').ajouterMessage('succes', 'PDF généré avec succès');
                        this.chargerPdfs(); // Recharger la liste
                    } else if (statut.statut === 'ECHEC') {
                        Alpine.store('app').ajouterMessage('erreur', 'Erreur lors de la génération PDF');
                    }
                });
                
                window.location.href = `/pdfs/${pdf.id}`;
            } catch (erreur) {
                console.error('Erreur génération PDF:', erreur);
            }
        },
        
        async dupliquer() {
            const nouveauNom = prompt('Nom du personnage dupliqué :', `${this.personnage.nom} (Copie)`);
            if (!nouveauNom) return;
            
            try {
                const nouveau = await window.personnageService.dupliquer(this.personnage.id, nouveauNom);
                window.location.href = `/personnages/${nouveau.id}`;
            } catch (erreur) {
                console.error('Erreur duplication:', erreur);
            }
        },
        
        async supprimer() {
            if (!confirm(`Êtes-vous sûr de vouloir supprimer "${this.personnage.nom}" ?`)) {
                return;
            }
            
            try {
                await window.personnageService.supprimer(this.personnage.id);
                window.location.href = '/mes-documents';
            } catch (erreur) {
                console.error('Erreur suppression:', erreur);
            }
        }
    };
}

// ========================================
// Enregistrement global des composants
// ========================================
window.AlpineComponents = window.AlpineComponents || {};
Object.assign(window.AlpineComponents, {
    listePersonnages,
    selectionSysteme,
    choixTypeDocument,
    choixModeCreation,
    creationPersonnage,
    fichePersonnage
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Actualite.html">Actualite</a></li><li><a href="AdminController.html">AdminController</a></li><li><a href="AdminOracleService.html">AdminOracleService</a></li><li><a href="AnonymousTokenService.html">AnonymousTokenService</a></li><li><a href="AuthentificationController.html">AuthentificationController</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="BasePdfKitService.html">BasePdfKitService</a></li><li><a href="BaseService.html">BaseService</a></li><li><a href="CacheService.html">CacheService</a></li><li><a href="CharacterSheetDocument.html">CharacterSheetDocument</a></li><li><a href="ClassPlanDocument.html">ClassPlanDocument</a></li><li><a href="DangerDocument.html">DangerDocument</a></li><li><a href="DemandeChangementEmail.html">DemandeChangementEmail</a></li><li><a href="Document.html">Document</a></li><li><a href="DocumentFactory.html">DocumentFactory</a></li><li><a href="DocumentModerationHistorique.html">DocumentModerationHistorique</a></li><li><a href="DocumentModerationService.html">DocumentModerationService</a></li><li><a href="DocumentSystemeJeu.html">DocumentSystemeJeu</a></li><li><a href="DocumentVote.html">DocumentVote</a></li><li><a href="DonationController.html">DonationController</a></li><li><a href="EmailService.html">EmailService</a></li><li><a href="EmailTemplate.html">EmailTemplate</a></li><li><a href="EngrenagesTheme.html">EngrenagesTheme</a></li><li><a href="GenericDocument.html">GenericDocument</a></li><li><a href="GroupDocument.html">GroupDocument</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="LoggingService.html">LoggingService</a></li><li><a href="MarkdownService.html">MarkdownService</a></li><li><a href="Metro2033Theme.html">Metro2033Theme</a></li><li><a href="MistEngineTheme.html">MistEngineTheme</a></li><li><a href="ModerationController.html">ModerationController</a></li><li><a href="MonsterheartsTheme.html">MonsterheartsTheme</a></li><li><a href="NavigationService.html">NavigationService</a></li><li><a href="Newsletter.html">Newsletter</a></li><li><a href="NewsletterService.html">NewsletterService</a></li><li><a href="Oracle.html">Oracle</a></li><li><a href="OracleController.html">OracleController</a></li><li><a href="OracleItem.html">OracleItem</a></li><li><a href="OracleService.html">OracleService</a></li><li><a href="OrganizationDocument.html">OrganizationDocument</a></li><li><a href="Pdf.html">Pdf</a></li><li><a href="PdfController.html">PdfController</a></li><li><a href="PdfKitService.html">PdfKitService</a></li><li><a href="PdfService.html">PdfService</a></li><li><a href="PerformanceMiddleware.html">PerformanceMiddleware</a></li><li><a href="PerformanceMonitoringService.html">PerformanceMonitoringService</a></li><li><a href="Personnage.html">Personnage</a></li><li><a href="PersonnageController.html">PersonnageController</a></li><li><a href="PersonnageService.html">PersonnageService</a></li><li><a href="ProductionApp.html">ProductionApp</a></li><li><a href="QueueService.html">QueueService</a></li><li><a href="RgpdConsentement.html">RgpdConsentement</a></li><li><a href="RgpdService.html">RgpdService</a></li><li><a href="SecurityService.html">SecurityService</a></li><li><a href="ShareService.html">ShareService</a></li><li><a href="SystemCardViewModel.html">SystemCardViewModel</a></li><li><a href="SystemMaintenanceService.html">SystemMaintenanceService</a></li><li><a href="SystemRightsService.html">SystemRightsService</a></li><li><a href="SystemService.html">SystemService</a></li><li><a href="SystemTheme.html">SystemTheme</a></li><li><a href="SystemThemeService.html">SystemThemeService</a></li><li><a href="SystemeJeu.html">SystemeJeu</a></li><li><a href="Temoignage.html">Temoignage</a></li><li><a href="TemoignageService.html">TemoignageService</a></li><li><a href="TemplateService.html">TemplateService</a></li><li><a href="ThemeService.html">ThemeService</a></li><li><a href="TownDocument.html">TownDocument</a></li><li><a href="Utilisateur.html">Utilisateur</a></li><li><a href="UtilisateurService.html">UtilisateurService</a></li><li><a href="VoteController.html">VoteController</a></li><li><a href="VoteService.html">VoteService</a></li><li><a href="ZombiologyTheme.html">ZombiologyTheme</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AuthComponent">AuthComponent</a></li><li><a href="global.html#InscriptionComponent">InscriptionComponent</a></li><li><a href="global.html#Joi">Joi</a></li><li><a href="global.html#MotDePasseOublieComponent">MotDePasseOublieComponent</a></li><li><a href="global.html#ReinitialiserMotDePasseComponent">ReinitialiserMotDePasseComponent</a></li><li><a href="global.html#actionFlottante">actionFlottante</a></li><li><a href="global.html#ajouterTemoignage">ajouterTemoignage</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#auth">auth</a></li><li><a href="global.html#chargerDonneesAccueil">chargerDonneesAccueil</a></li><li><a href="global.html#chargerInfosDons">chargerInfosDons</a></li><li><a href="global.html#choixModeCreation">choixModeCreation</a></li><li><a href="global.html#choixTypeDocument">choixTypeDocument</a></li><li><a href="global.html#compareVersions">compareVersions</a></li><li><a href="global.html#createError">createError</a></li><li><a href="global.html#createMigrationsTable">createMigrationsTable</a></li><li><a href="global.html#createTables">createTables</a></li><li><a href="global.html#creationPersonnage">creationPersonnage</a></li><li><a href="global.html#database">database</a></li><li><a href="global.html#elevationRole">elevationRole</a></li><li><a href="global.html#executeMigration">executeMigration</a></li><li><a href="global.html#fichePersonnage">fichePersonnage</a></li><li><a href="global.html#formaterDate">formaterDate</a></li><li><a href="global.html#formaterNombre">formaterNombre</a></li><li><a href="global.html#formaterTailleFichier">formaterTailleFichier</a></li><li><a href="global.html#genererEtoiles">genererEtoiles</a></li><li><a href="global.html#getCurrentVersion">getCurrentVersion</a></li><li><a href="global.html#getErrorMessage">getErrorMessage</a></li><li><a href="global.html#getExecutedMigrations">getExecutedMigrations</a></li><li><a href="global.html#getMigrationStatus">getMigrationStatus</a></li><li><a href="global.html#getVersionsToMigrate">getVersionsToMigrate</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#handleNotFound">handleNotFound</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#inscrireNewsletter">inscrireNewsletter</a></li><li><a href="global.html#isDatabaseInitialized">isDatabaseInitialized</a></li><li><a href="global.html#listePersonnages">listePersonnages</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#markMigrationExecuted">markMigrationExecuted</a></li><li><a href="global.html#menuUtilisateur">menuUtilisateur</a></li><li><a href="global.html#mesDocuments">mesDocuments</a></li><li><a href="global.html#migrateDatabase">migrateDatabase</a></li><li><a href="global.html#migrateToLatest">migrateToLatest</a></li><li><a href="global.html#migrateToVersion">migrateToVersion</a></li><li><a href="global.html#migrations">migrations</a></li><li><a href="global.html#navigationFormulaire">navigationFormulaire</a></li><li><a href="global.html#naviguerVersSysteme">naviguerVersSysteme</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#ouvrirLienDon">ouvrirLienDon</a></li><li><a href="global.html#partageDocument">partageDocument</a></li><li><a href="global.html#partagerPdf">partagerPdf</a></li><li><a href="global.html#path">path</a></li><li><a href="global.html#previewHtml">previewHtml</a></li><li><a href="global.html#requireAdmin">requireAdmin</a></li><li><a href="global.html#requireAuth">requireAuth</a></li><li><a href="global.html#requirePremium">requirePremium</a></li><li><a href="global.html#resetDatabase">resetDatabase</a></li><li><a href="global.html#rollbackMigration">rollbackMigration</a></li><li><a href="global.html#schemas">schemas</a></li><li><a href="global.html#scrollVersSection">scrollVersSection</a></li><li><a href="global.html#selectionSysteme">selectionSysteme</a></li><li><a href="global.html#updateAppVersion">updateAppVersion</a></li><li><a href="global.html#validateFiles">validateFiles</a></li><li><a href="global.html#validateRequest">validateRequest</a></li><li><a href="global.html#verifierAuth">verifierAuth</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Aug 08 2025 18:20:12 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
