<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: models/DocumentModerationHistorique.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: models/DocumentModerationHistorique.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const BaseModel = require('./BaseModel');
const Joi = require('joi');

/**
 * Modèle DocumentModerationHistorique - Traçabilité complète des actions de modération
 * 
 * Fonctionnalités:
 * - Historique immuable des actions de modération
 * - Traçabilité complète des changements de statut
 * - Justifications obligatoires pour actions importantes
 * - Suivi des interventions par modérateur
 * - Métriques pour dashboard administratif
 */
class DocumentModerationHistorique extends BaseModel {
  constructor() {
    super('document_moderation_historique', 'id');
    
    this.fillable = [
      'document_id',
      'moderateur_id',
      'action',
      'ancien_statut',
      'nouveau_statut',
      'motif'
    ];
    
    this.hidden = [];
    
    this.casts = {
      document_id: 'integer',
      moderateur_id: 'integer',
      date_action: 'date'
    };
    
    this.timestamps = false; // Gestion manuelle de date_action
  }

  /**
   * Actions de modération disponibles
   */
  static get ACTIONS() {
    return {
      MISE_EN_AVANT: 'MISE_EN_AVANT',
      RETRAIT_MISE_EN_AVANT: 'RETRAIT_MISE_EN_AVANT',
      APPROBATION: 'APPROBATION',
      REJET: 'REJET',
      SIGNALEMENT: 'SIGNALEMENT',
      ARCHIVAGE: 'ARCHIVAGE',
      RESTAURATION: 'RESTAURATION',
      CHANGEMENT_VISIBILITE: 'CHANGEMENT_VISIBILITE'
    };
  }

  /**
   * Statuts de document disponibles
   */
  static get STATUTS() {
    return {
      BROUILLON: 'BROUILLON',
      ACTIF: 'ACTIF',
      ARCHIVE: 'ARCHIVE',
      SUPPRIME: 'SUPPRIME',
      EN_ATTENTE: 'EN_ATTENTE',
      APPROUVE: 'APPROUVE',
      REJETE: 'REJETE',
      SIGNALE: 'SIGNALE'
    };
  }

  /**
   * Schema de validation Joi
   */
  getValidationSchema(operation = 'create') {
    const actions = Object.values(DocumentModerationHistorique.ACTIONS);
    const statuts = Object.values(DocumentModerationHistorique.STATUTS);
    
    const baseSchema = {
      document_id: Joi.number().integer().positive().required()
        .messages({
          'number.base': 'L\'ID du document doit être un nombre',
          'number.integer': 'L\'ID du document doit être un entier',
          'number.positive': 'L\'ID du document doit être positif',
          'any.required': 'L\'ID du document est requis'
        }),
        
      moderateur_id: Joi.number().integer().positive().required()
        .messages({
          'number.base': 'L\'ID du modérateur doit être un nombre',
          'number.integer': 'L\'ID du modérateur doit être un entier',
          'number.positive': 'L\'ID du modérateur doit être positif',
          'any.required': 'L\'ID du modérateur est requis'
        }),
        
      action: Joi.string().valid(...actions).required()
        .messages({
          'string.base': 'L\'action doit être une chaîne de caractères',
          'any.only': `L'action doit être l'une des valeurs suivantes: ${actions.join(', ')}`,
          'any.required': 'L\'action est requise'
        }),
        
      ancien_statut: Joi.string().valid(...statuts, '').optional().allow('')
        .messages({
          'string.base': 'L\'ancien statut doit être une chaîne de caractères',
          'any.only': `L'ancien statut doit être l'une des valeurs suivantes: ${statuts.join(', ')}`
        }),
        
      nouveau_statut: Joi.string().valid(...statuts, '').optional().allow('')
        .messages({
          'string.base': 'Le nouveau statut doit être une chaîne de caractères',
          'any.only': `Le nouveau statut doit être l'une des valeurs suivantes: ${statuts.join(', ')}`
        }),
        
      motif: Joi.string().max(2000).required()
        .messages({
          'string.base': 'Le motif doit être une chaîne de caractères',
          'string.max': 'Le motif ne peut pas dépasser 2000 caractères',
          'any.required': 'Le motif est requis pour toute action de modération'
        })
    };

    return Joi.object(baseSchema);
  }

  /**
   * Validation métier spécifique
   */
  async businessValidation(data, operation = 'create') {
    // Vérifier que le document existe
    if (data.document_id) {
      const Document = require('./Document');
      const document = new Document();
      const doc = await document.findById(data.document_id);
      
      if (!doc) {
        throw new Error('Le document spécifié n\'existe pas');
      }
    }

    // Vérifier que le modérateur existe et a les bonnes permissions
    if (data.moderateur_id) {
      const Utilisateur = require('./Utilisateur');
      const utilisateur = new Utilisateur();
      const user = await utilisateur.findById(data.moderateur_id);
      
      if (!user) {
        throw new Error('Le modérateur spécifié n\'existe pas');
      }
      
      if (user.role !== 'ADMIN' &amp;&amp; user.role !== 'MODERATEUR') {
        throw new Error('Seuls les administrateurs et modérateurs peuvent effectuer des actions de modération');
      }
    }

    // Validation spécifique selon l'action
    if (data.action) {
      switch (data.action) {
        case DocumentModerationHistorique.ACTIONS.MISE_EN_AVANT:
        case DocumentModerationHistorique.ACTIONS.RETRAIT_MISE_EN_AVANT:
          if (!data.motif || data.motif.trim().length &lt; 10) {
            throw new Error('Les actions de mise en avant nécessitent un motif d\'au moins 10 caractères');
          }
          break;
          
        case DocumentModerationHistorique.ACTIONS.REJET:
        case DocumentModerationHistorique.ACTIONS.SIGNALEMENT:
          if (!data.motif || data.motif.trim().length &lt; 20) {
            throw new Error('Les rejets et signalements nécessitent un motif détaillé d\'au moins 20 caractères');
          }
          break;
      }
    }

    return true;
  }

  /**
   * Hook beforeCreate - Ajouter la date d'action et validation finale
   */
  async beforeCreate(data) {
    // Ajouter la date d'action
    data.date_action = new Date().toISOString();
    
    // Log de l'action de modération
    this.logChange('moderation_action', null, null, {
      action: data.action,
      document_id: data.document_id,
      moderateur_id: data.moderateur_id,
      motif: data.motif
    });
    
    return data;
  }

  /**
   * Empêcher la modification des entrées d'historique (immuable)
   */
  async update(id, data) {
    throw new Error('L\'historique de modération est immuable et ne peut pas être modifié');
  }

  /**
   * Empêcher la suppression des entrées d'historique (immuable)
   */
  async delete(id) {
    throw new Error('L\'historique de modération est immuable et ne peut pas être supprimé');
  }

  /**
   * Enregistrer une action de modération
   * 
   * @param {number} documentId - ID du document
   * @param {number} moderateurId - ID du modérateur
   * @param {string} action - Action effectuée
   * @param {string} motif - Justification de l'action
   * @param {string} ancienStatut - Statut avant l'action (optionnel)
   * @param {string} nouveauStatut - Statut après l'action (optionnel)
   * @returns {Object} Entrée d'historique créée
   */
  async enregistrerAction(documentId, moderateurId, action, motif, ancienStatut = '', nouveauStatut = '') {
    const actionData = {
      document_id: documentId,
      moderateur_id: moderateurId,
      action: action,
      ancien_statut: ancienStatut,
      nouveau_statut: nouveauStatut,
      motif: motif
    };

    return await this.create(actionData);
  }

  /**
   * Récupérer l'historique complet d'un document
   * 
   * @param {number} documentId - ID du document
   * @param {number} limite - Nombre d'entrées à récupérer
   * @returns {Array} Historique ordonné par date décroissante
   */
  async getHistoriqueDocument(documentId, limite = 50) {
    const db = require('../database/db');
    
    const sql = `
      SELECT 
        dmh.*,
        u.nom as moderateur_nom,
        u.email as moderateur_email
      FROM document_moderation_historique dmh
      LEFT JOIN utilisateurs u ON dmh.moderateur_id = u.id
      WHERE dmh.document_id = $1
      ORDER BY dmh.date_action DESC
      LIMIT $2
    `;
    
    const rows = await db.all(sql, [documentId, limite]);
    return rows.map(row => this.castAttributes(row));
  }

  /**
   * Récupérer les actions effectuées par un modérateur
   * 
   * @param {number} moderateurId - ID du modérateur
   * @param {number} limite - Nombre d'entrées à récupérer
   * @param {Date} dateDebut - Date de début (optionnel)
   * @param {Date} dateFin - Date de fin (optionnel)
   * @returns {Array} Actions du modérateur
   */
  async getActionsModerateur(moderateurId, limite = 100, dateDebut = null, dateFin = null) {
    let whereClause = 'moderateur_id = $1';
    const params = [moderateurId];
    let paramIndex = 2;

    if (dateDebut) {
      whereClause += ` AND date_action >= $${paramIndex}`;
      params.push(dateDebut.toISOString());
      paramIndex++;
    }

    if (dateFin) {
      whereClause += ` AND date_action &lt;= $${paramIndex}`;
      params.push(dateFin.toISOString());
      paramIndex++;
    }

    const db = require('../database/db');
    
    const sql = `
      SELECT 
        dmh.*,
        d.titre as document_titre,
        d.systeme_jeu as document_systeme
      FROM document_moderation_historique dmh
      LEFT JOIN documents d ON dmh.document_id = d.id
      WHERE ${whereClause}
      ORDER BY dmh.date_action DESC
      LIMIT $${paramIndex}
    `;
    
    params.push(limite);
    
    const rows = await db.all(sql, params);
    return rows.map(row => this.castAttributes(row));
  }

  /**
   * Statistiques de modération pour le dashboard admin
   * 
   * @param {Date} dateDebut - Période de début (optionnel)
   * @param {Date} dateFin - Période de fin (optionnel)
   * @returns {Object} Statistiques détaillées
   */
  async statistiquesModeration(dateDebut = null, dateFin = null) {
    let whereClause = '1 = 1';
    const params = [];
    let paramIndex = 1;

    if (dateDebut) {
      whereClause += ` AND date_action >= $${paramIndex}`;
      params.push(dateDebut.toISOString());
      paramIndex++;
    }

    if (dateFin) {
      whereClause += ` AND date_action &lt;= $${paramIndex}`;
      params.push(dateFin.toISOString());
      paramIndex++;
    }

    const db = require('../database/db');
    
    // Statistiques par action
    const sqlActions = `
      SELECT 
        action,
        COUNT(*) as nombre_actions
      FROM document_moderation_historique
      WHERE ${whereClause}
      GROUP BY action
      ORDER BY nombre_actions DESC
    `;
    
    // Statistiques par modérateur
    const sqlModerateurs = `
      SELECT 
        u.nom as moderateur_nom,
        u.email as moderateur_email,
        COUNT(*) as nombre_actions,
        COUNT(DISTINCT dmh.document_id) as documents_traites
      FROM document_moderation_historique dmh
      LEFT JOIN utilisateurs u ON dmh.moderateur_id = u.id
      WHERE ${whereClause}
      GROUP BY dmh.moderateur_id, u.nom, u.email
      ORDER BY nombre_actions DESC
    `;
    
    // Statistiques par jour (derniers 30 jours)
    const sqlJours = `
      SELECT 
        DATE(date_action) as date,
        COUNT(*) as nombre_actions
      FROM document_moderation_historique
      WHERE ${whereClause}
        AND date_action >= NOW() - INTERVAL '30 days'
      GROUP BY DATE(date_action)
      ORDER BY date DESC
    `;

    const [actionsStats, moderateursStats, joursStats] = await Promise.all([
      db.all(sqlActions, params),
      db.all(sqlModerateurs, params),
      db.all(sqlJours, params)
    ]);

    // Total des actions
    const total = actionsStats.reduce((sum, stat) => sum + stat.nombre_actions, 0);

    return {
      total_actions: total,
      actions_par_type: actionsStats,
      actions_par_moderateur: moderateursStats,
      actions_par_jour: joursStats,
      periode: {
        debut: dateDebut ? dateDebut.toISOString() : 'Toutes',
        fin: dateFin ? dateFin.toISOString() : 'Aujourd\'hui'
      }
    };
  }

  /**
   * Récupérer les documents les plus modérés
   * 
   * @param {number} limite - Nombre de documents à récupérer
   * @param {Date} dateDebut - Période de début (optionnel)
   * @returns {Array} Documents avec nombre d'actions
   */
  async getDocumentsLesPlusModeres(limite = 20, dateDebut = null) {
    let whereClause = '1 = 1';
    const params = [];
    let paramIndex = 1;

    if (dateDebut) {
      whereClause += ` AND dmh.date_action >= $${paramIndex}`;
      params.push(dateDebut.toISOString());
      paramIndex++;
    }

    const db = require('../database/db');
    
    const sql = `
      SELECT 
        d.id,
        d.titre,
        d.systeme_jeu,
        d.type,
        d.visibilite,
        COUNT(dmh.id) as nombre_actions_moderation,
        STRING_AGG(DISTINCT dmh.action, ', ') as types_actions,
        MAX(dmh.date_action) as derniere_action
      FROM documents d
      INNER JOIN document_moderation_historique dmh ON d.id = dmh.document_id
      WHERE ${whereClause}
      GROUP BY d.id, d.titre, d.systeme_jeu, d.type, d.visibilite
      ORDER BY nombre_actions_moderation DESC, derniere_action DESC
      LIMIT $${paramIndex}
    `;
    
    params.push(limite);
    
    const rows = await db.all(sql, params);
    return rows.map(row => ({
      ...this.castAttributes(row),
      types_actions: row.types_actions ? row.types_actions.split(', ') : []
    }));
  }

  /**
   * Rechercher dans l'historique par motif
   * 
   * @param {string} recherche - Terme de recherche
   * @param {number} limite - Nombre de résultats
   * @returns {Array} Résultats de recherche
   */
  async rechercherParMotif(recherche, limite = 50) {
    const db = require('../database/db');
    
    const sql = `
      SELECT 
        dmh.*,
        d.titre as document_titre,
        u.nom as moderateur_nom
      FROM document_moderation_historique dmh
      LEFT JOIN documents d ON dmh.document_id = d.id
      LEFT JOIN utilisateurs u ON dmh.moderateur_id = u.id
      WHERE dmh.motif ILIKE $1
      ORDER BY dmh.date_action DESC
      LIMIT $2
    `;
    
    const rows = await db.all(sql, [`%${recherche}%`, limite]);
    return rows.map(row => this.castAttributes(row));
  }

  /**
   * RELATIONS - Récupérer le document concerné par cette action
   * belongsTo('document')
   */
  async getDocument(historiqueId) {
    const historique = await this.findById(historiqueId);
    if (!historique || !historique.document_id) {
      return null;
    }
    
    const Document = require('./Document');
    const document = new Document();
    return await document.findById(historique.document_id);
  }

  /**
   * RELATIONS - Récupérer le modérateur ayant effectué l'action
   * belongsTo('moderateur')
   */
  async getModerateur(historiqueId) {
    const historique = await this.findById(historiqueId);
    if (!historique || !historique.moderateur_id) {
      return null;
    }
    
    const Utilisateur = require('./Utilisateur');
    const utilisateur = new Utilisateur();
    return await utilisateur.findById(historique.moderateur_id);
  }

  /**
   * Statistiques des actions de modération par type
   * 
   * @param {Date} dateDebut - Date de début (optionnel)
   * @param {Date} dateFin - Date de fin (optionnel)
   * @returns {Array} Statistiques par action
   */
  static async getStatistiquesActions(dateDebut = null, dateFin = null) {
    const db = require('../database/db');
    
    let whereClause = '1 = 1';
    const params = [];
    let paramIndex = 1;

    if (dateDebut) {
      whereClause += ` AND created_at >= $${paramIndex}`;
      params.push(dateDebut.toISOString());
      paramIndex++;
    }

    if (dateFin) {
      whereClause += ` AND created_at &lt;= $${paramIndex}`;
      params.push(dateFin.toISOString());
      paramIndex++;
    }

    const sql = `
      SELECT 
        action,
        COUNT(*) as nombre
      FROM document_moderation_historique
      WHERE ${whereClause}
      GROUP BY action
      ORDER BY nombre DESC
    `;
    
    const rows = await db.all(sql, params);
    
    // Convertir en objet pour faciliter l'accès
    const statistiques = {};
    rows.forEach(row => {
      statistiques[row.action] = parseInt(row.nombre);
    });
    
    return statistiques;
  }
}

module.exports = DocumentModerationHistorique;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Actualite.html">Actualite</a></li><li><a href="AdminController.html">AdminController</a></li><li><a href="AdminOracleService.html">AdminOracleService</a></li><li><a href="AnonymousTokenService.html">AnonymousTokenService</a></li><li><a href="AuthentificationController.html">AuthentificationController</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="BasePdfKitService.html">BasePdfKitService</a></li><li><a href="BaseService.html">BaseService</a></li><li><a href="CacheService.html">CacheService</a></li><li><a href="CharacterSheetDocument.html">CharacterSheetDocument</a></li><li><a href="ClassPlanDocument.html">ClassPlanDocument</a></li><li><a href="DangerDocument.html">DangerDocument</a></li><li><a href="DemandeChangementEmail.html">DemandeChangementEmail</a></li><li><a href="Document.html">Document</a></li><li><a href="DocumentFactory.html">DocumentFactory</a></li><li><a href="DocumentModerationHistorique.html">DocumentModerationHistorique</a></li><li><a href="DocumentModerationService.html">DocumentModerationService</a></li><li><a href="DocumentSystemeJeu.html">DocumentSystemeJeu</a></li><li><a href="DocumentVote.html">DocumentVote</a></li><li><a href="DonationController.html">DonationController</a></li><li><a href="EmailService.html">EmailService</a></li><li><a href="EmailTemplate.html">EmailTemplate</a></li><li><a href="EngrenagesTheme.html">EngrenagesTheme</a></li><li><a href="GenericDocument.html">GenericDocument</a></li><li><a href="GroupDocument.html">GroupDocument</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="LoggingService.html">LoggingService</a></li><li><a href="MaintenanceWorker.html">MaintenanceWorker</a></li><li><a href="MarkdownService.html">MarkdownService</a></li><li><a href="Metro2033Theme.html">Metro2033Theme</a></li><li><a href="MistEngineTheme.html">MistEngineTheme</a></li><li><a href="ModerationController.html">ModerationController</a></li><li><a href="MonsterheartsTheme.html">MonsterheartsTheme</a></li><li><a href="Newsletter.html">Newsletter</a></li><li><a href="NewsletterService.html">NewsletterService</a></li><li><a href="Oracle.html">Oracle</a></li><li><a href="OracleController.html">OracleController</a></li><li><a href="OracleItem.html">OracleItem</a></li><li><a href="OracleService.html">OracleService</a></li><li><a href="OrganizationDocument.html">OrganizationDocument</a></li><li><a href="Pdf.html">Pdf</a></li><li><a href="PdfController.html">PdfController</a></li><li><a href="PdfKitService.html">PdfKitService</a></li><li><a href="PdfService.html">PdfService</a></li><li><a href="PerformanceMiddleware.html">PerformanceMiddleware</a></li><li><a href="PerformanceMonitoringService.html">PerformanceMonitoringService</a></li><li><a href="Personnage.html">Personnage</a></li><li><a href="PersonnageController.html">PersonnageController</a></li><li><a href="PersonnageService.html">PersonnageService</a></li><li><a href="ProductionApp.html">ProductionApp</a></li><li><a href="QueueService.html">QueueService</a></li><li><a href="QueueWorker.html">QueueWorker</a></li><li><a href="RgpdConsentement.html">RgpdConsentement</a></li><li><a href="RgpdService.html">RgpdService</a></li><li><a href="SecurityService.html">SecurityService</a></li><li><a href="ShareService.html">ShareService</a></li><li><a href="SystemCardViewModel.html">SystemCardViewModel</a></li><li><a href="SystemMaintenanceService.html">SystemMaintenanceService</a></li><li><a href="SystemRightsService.html">SystemRightsService</a></li><li><a href="SystemService.html">SystemService</a></li><li><a href="SystemTheme.html">SystemTheme</a></li><li><a href="SystemThemeService.html">SystemThemeService</a></li><li><a href="SystemeJeu.html">SystemeJeu</a></li><li><a href="Temoignage.html">Temoignage</a></li><li><a href="TemoignageService.html">TemoignageService</a></li><li><a href="TemplateService.html">TemplateService</a></li><li><a href="TownDocument.html">TownDocument</a></li><li><a href="Utilisateur.html">Utilisateur</a></li><li><a href="UtilisateurService.html">UtilisateurService</a></li><li><a href="VoteController.html">VoteController</a></li><li><a href="VoteService.html">VoteService</a></li><li><a href="ZombiologyTheme.html">ZombiologyTheme</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Joi">Joi</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#auth">auth</a></li><li><a href="global.html#compareVersions">compareVersions</a></li><li><a href="global.html#createError">createError</a></li><li><a href="global.html#createMigrationsTable">createMigrationsTable</a></li><li><a href="global.html#createTables">createTables</a></li><li><a href="global.html#database">database</a></li><li><a href="global.html#executeMigration">executeMigration</a></li><li><a href="global.html#getCurrentVersion">getCurrentVersion</a></li><li><a href="global.html#getErrorMessage">getErrorMessage</a></li><li><a href="global.html#getExecutedMigrations">getExecutedMigrations</a></li><li><a href="global.html#getMigrationStatus">getMigrationStatus</a></li><li><a href="global.html#getVersionsToMigrate">getVersionsToMigrate</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#handleNotFound">handleNotFound</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#isDatabaseInitialized">isDatabaseInitialized</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#markMigrationExecuted">markMigrationExecuted</a></li><li><a href="global.html#migrateDatabase">migrateDatabase</a></li><li><a href="global.html#migrateToLatest">migrateToLatest</a></li><li><a href="global.html#migrateToVersion">migrateToVersion</a></li><li><a href="global.html#migrations">migrations</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#path">path</a></li><li><a href="global.html#requireAdmin">requireAdmin</a></li><li><a href="global.html#requireAuth">requireAuth</a></li><li><a href="global.html#requirePremium">requirePremium</a></li><li><a href="global.html#resetDatabase">resetDatabase</a></li><li><a href="global.html#rollbackMigration">rollbackMigration</a></li><li><a href="global.html#schemas">schemas</a></li><li><a href="global.html#updateAppVersion">updateAppVersion</a></li><li><a href="global.html#validateFiles">validateFiles</a></li><li><a href="global.html#validateRequest">validateRequest</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Aug 08 2025 18:17:39 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
