<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/EmailService-old.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/EmailService-old.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const BaseService = require('./BaseService');
const { Resend } = require('resend');
const EmailTemplate = require('./EmailTemplate');

/**
 * Service d'envoi d'emails avec Resend
 */
class EmailService extends BaseService {
    constructor() {
        super('EmailService');
        
        // Configuration Resend
        this.apiKey = process.env.RESEND_API_KEY;
        this.fromEmail = process.env.RESEND_FROM_EMAIL || 'noreply@localhost';
        this.fromName = process.env.RESEND_FROM_NAME || 'GÃ©nÃ©rateur PDF JDR';
        this.isDevelopment = process.env.NODE_ENV === 'development';
        this.forceRealEmails = process.env.FORCE_REAL_EMAILS === 'true';
        
        // Initialiser le service de templates
        this.emailTemplate = new EmailTemplate();
        
        // Initialiser Resend seulement si on a une vraie clÃ© API
        if (this.apiKey &amp;&amp; this.apiKey !== 're_test_key_for_development') {
            try {
                this.resend = new Resend(this.apiKey);
                this.log('info', 'Service Resend initialisÃ©');
            } catch (error) {
                this.logError(error, { context: 'resend_init' });
                this.resend = null;
            }
        } else {
            this.resend = null;
            this.log('warn', 'Mode dÃ©veloppement : emails simulÃ©s (pas d\'API Resend configurÃ©e)');
        }
    }

    /**
     * Envoie un email de rÃ©cupÃ©ration de mot de passe
     * @param {string} email - Email du destinataire
     * @param {string} nom - Nom de l'utilisateur
     * @param {string} token - Token de rÃ©cupÃ©ration
     * @returns {Promise&lt;Object>} RÃ©sultat de l'envoi
     */
    async envoyerMotDePasseOublie(email, nom, token) {
        const lienRecuperation = `${process.env.BASE_URL || 'http://localhost:3074'}/reinitialiser-mot-de-passe/${token}`;
        
        const variables = {
            nom: nom,
            lien_recuperation: lienRecuperation,
            duree_validite: '24 heures',
            site_name: this.fromName
        };

        return await this.envoyer({
            to: email,
            subject: 'RÃ©cupÃ©ration de votre mot de passe',
            template: 'mot-de-passe-oublie',
            variables: variables
        });
    }

    /**
     * Envoie un email de bienvenue
     * @param {string} email - Email du destinataire
     * @param {string} nom - Nom de l'utilisateur
     * @returns {Promise&lt;Object>} RÃ©sultat de l'envoi
     */
    async envoyerBienvenue(email, nom) {
        const variables = {
            nom: nom,
            lien_connexion: `${process.env.BASE_URL || 'http://localhost:3074'}/connexion`,
            site_name: this.fromName
        };

        return await this.envoyer({
            to: email,
            subject: `Bienvenue sur ${this.fromName} !`,
            template: 'bienvenue',
            variables: variables
        });
    }

    /**
     * Envoie un email de confirmation d'inscription Ã  la newsletter
     * @param {string} email - Email du destinataire
     * @param {string} token - Token de dÃ©sinscription
     * @returns {Promise&lt;Object>} RÃ©sultat de l'envoi
     */
    async envoyerNewsletterConfirmation(email, token) {
        const variables = {
            email: email,
            lien_desinscription: `${process.env.BASE_URL || 'http://localhost:3074'}/newsletter/desinscription/${token}`,
            site_name: this.fromName
        };

        return await this.envoyer({
            to: email,
            subject: 'Confirmation d\'inscription Ã  la newsletter',
            template: 'newsletter-confirmation',
            variables: variables
        });
    }

    /**
     * Envoie une notification Ã  l'administrateur
     * @param {string} sujet - Sujet de l'email
     * @param {string} contenu - Contenu de l'email
     * @param {Object} metadata - MÃ©tadonnÃ©es additionnelles
     * @returns {Promise&lt;Object>} RÃ©sultat de l'envoi
     */
    async envoyerNotificationAdmin(sujet, contenu, metadata = {}) {
        // Email admin depuis les variables d'environnement ou fallback
        const emailAdmin = process.env.ADMIN_EMAIL || process.env.RESEND_FROM_EMAIL;
        
        if (!emailAdmin) {
            this.log('warn', 'Aucun email admin configurÃ© pour les notifications');
            return { success: false, error: 'Pas d\'email admin configurÃ©' };
        }

        const variables = {
            sujet: sujet,
            contenu: contenu,
            metadata: metadata,
            timestamp: new Date().toISOString(),
            site_name: this.fromName
        };

        return await this.envoyer({
            to: emailAdmin,
            subject: `[ADMIN] ${sujet}`,
            template: 'admin-notification',
            variables: variables
        });
    }

    /**
     * MÃ©thode gÃ©nÃ©rique d'envoi d'email
     * @param {Object} options - Options d'envoi
     * @param {string} options.to - Email destinataire
     * @param {string} options.subject - Sujet
     * @param {string} options.template - Nom du template
     * @param {Object} options.variables - Variables pour le template
     * @returns {Promise&lt;Object>} RÃ©sultat de l'envoi
     */
    async envoyer({ to, subject, template, variables = {} }) {
        try {
            // GÃ©nÃ©rer le contenu HTML depuis le template
            const htmlContent = await this.emailTemplate.render(template, variables);
            
            // En mode dÃ©veloppement, simuler l'envoi
            if ((this.isDevelopment &amp;&amp; !this.forceRealEmails) || !this.resend) {
                return await this.simulerEnvoi(to, subject, htmlContent, template, variables);
            }

            // Envoi rÃ©el avec Resend
            const result = await this.resend.emails.send({
                from: `${this.fromName} &lt;${this.fromEmail}>`,
                to: to,
                subject: subject,
                html: htmlContent
            });

            this.log('info', 'Email envoyÃ© avec succÃ¨s', {
                recipient: to,
                subject: subject,
                template: template,
                resend_id: result.data?.id
            });

            return {
                success: true,
                id: result.data?.id,
                message: 'Email envoyÃ©'
            };

        } catch (error) {
            this.logError(error, {
                recipient: to,
                subject: subject,
                template: template,
                context: 'email_send'
            });

            return {
                success: false,
                error: error.message
            };
        }
    }

    /**
     * Simule l'envoi d'un email en dÃ©veloppement
     * @private
     */
    async simulerEnvoi(to, subject, htmlContent, template, variables) {
        this.log('info', 'ðŸ“§ EMAIL SIMULÃ‰ (mode dÃ©veloppement)', {
            destinataire: to,
            sujet: subject,
            template: template,
            contenu_html_length: htmlContent.length
        });

        // En dÃ©veloppement, afficher le contenu dans la console
        if (template === 'mot-de-passe-oublie' &amp;&amp; variables.lien_recuperation) {
            console.log('');
            console.log('ðŸ”— LIEN DE RÃ‰CUPÃ‰RATION (copier dans votre navigateur) :');
            console.log(variables.lien_recuperation);
            console.log('');
        }

        return {
            success: true,
            id: `dev_${Date.now()}`,
            message: 'Email simulÃ© en mode dÃ©veloppement'
        };
    }

    /**
     * Render un template EJS
     * @param {string} templateName - Nom du template
     * @param {Object} variables - Variables pour le template
     * @returns {Promise&lt;string>} Contenu HTML
     * @private
     */
    async renderTemplate(templateName, variables) {
        const templatePath = path.join(this.templatesPath, `${templateName}.ejs`);
        
        try {
            // VÃ©rifier que le template existe
            await fs.access(templatePath);
            
            // Variables communes Ã  tous les templates
            const commonVariables = {
                site_name: this.fromName,
                site_url: process.env.BASE_URL || 'http://localhost:3074',
                year: new Date().getFullYear(),
                ...variables
            };

            // Render le template
            const html = await ejs.renderFile(templatePath, commonVariables);
            return html;

        } catch (error) {
            if (error.code === 'ENOENT') {
                // Template non trouvÃ©, crÃ©er un template basique
                this.log('warn', `Template ${templateName}.ejs non trouvÃ©, utilisation du template basique`);
                return this.createBasicTemplate(templateName, variables);
            }
            throw error;
        }
    }

    /**
     * CrÃ©e un template HTML basique si le fichier template n'existe pas
     * @param {string} templateName - Nom du template
     * @param {Object} variables - Variables
     * @returns {string} HTML basique
     * @private
     */
    createBasicTemplate(templateName, variables) {
        const baseHtml = `
        &lt;!DOCTYPE html>
        &lt;html lang="fr">
        &lt;head>
            &lt;meta charset="UTF-8">
            &lt;meta name="viewport" content="width=device-width, initial-scale=1.0">
            &lt;title>${this.fromName}&lt;/title>
            &lt;style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: #dc2626; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
                .content { background: #f9f9f9; padding: 20px; border-radius: 0 0 8px 8px; }
                .button { display: inline-block; padding: 12px 24px; background: #dc2626; color: white; text-decoration: none; border-radius: 4px; margin: 10px 0; }
                .footer { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; text-align: center; }
            &lt;/style>
        &lt;/head>
        &lt;body>
            &lt;div class="header">
                &lt;h1>${this.fromName}&lt;/h1>
            &lt;/div>
            &lt;div class="content">
                ${this.getTemplateContent(templateName, variables)}
            &lt;/div>
            &lt;div class="footer">
                &lt;p>&amp;copy; ${new Date().getFullYear()} ${this.fromName}. Tous droits rÃ©servÃ©s.&lt;/p>
                &lt;p>Cet email a Ã©tÃ© envoyÃ© automatiquement, merci de ne pas y rÃ©pondre.&lt;/p>
            &lt;/div>
        &lt;/body>
        &lt;/html>`;
        
        return baseHtml;
    }

    /**
     * GÃ©nÃ¨re le contenu spÃ©cifique selon le type de template
     * @param {string} templateName - Nom du template
     * @param {Object} variables - Variables
     * @returns {string} Contenu HTML
     * @private
     */
    getTemplateContent(templateName, variables) {
        switch (templateName) {
            case 'mot-de-passe-oublie':
                return `
                    &lt;h2>RÃ©cupÃ©ration de votre mot de passe&lt;/h2>
                    &lt;p>Bonjour ${variables.nom || 'Utilisateur'},&lt;/p>
                    &lt;p>Vous avez demandÃ© la rÃ©cupÃ©ration de votre mot de passe sur ${this.fromName}.&lt;/p>
                    &lt;p>Cliquez sur le lien ci-dessous pour rÃ©initialiser votre mot de passe :&lt;/p>
                    &lt;p>&lt;a href="${variables.lien_recuperation}" class="button">RÃ©initialiser mon mot de passe&lt;/a>&lt;/p>
                    &lt;p>&lt;small>Ce lien expire dans ${variables.duree_validite || '24 heures'}. Si vous n'avez pas demandÃ© cette rÃ©cupÃ©ration, vous pouvez ignorer cet email.&lt;/small>&lt;/p>
                `;

            case 'bienvenue':
                return `
                    &lt;h2>Bienvenue sur ${this.fromName} !&lt;/h2>
                    &lt;p>Bonjour ${variables.nom || 'Nouvel utilisateur'},&lt;/p>
                    &lt;p>Nous sommes ravis de vous accueillir sur notre plateforme de gÃ©nÃ©ration de PDF pour jeux de rÃ´le !&lt;/p>
                    &lt;p>Vous pouvez maintenant vous connecter et crÃ©er vos premiÃ¨res fiches de personnages.&lt;/p>
                    &lt;p>&lt;a href="${variables.lien_connexion}" class="button">Se connecter&lt;/a>&lt;/p>
                `;

            case 'newsletter-confirmation':
                return `
                    &lt;h2>Inscription confirmÃ©e !&lt;/h2>
                    &lt;p>Votre adresse email ${variables.email} a Ã©tÃ© ajoutÃ©e Ã  notre newsletter.&lt;/p>
                    &lt;p>Vous recevrez nos actualitÃ©s et nouveautÃ©s directement dans votre boÃ®te mail.&lt;/p>
                    &lt;p>&lt;small>&lt;a href="${variables.lien_desinscription}">Se dÃ©sinscrire de la newsletter&lt;/a>&lt;/small>&lt;/p>
                `;

            case 'admin-notification':
                return `
                    &lt;h2>Notification Admin&lt;/h2>
                    &lt;p>&lt;strong>Sujet:&lt;/strong> ${variables.sujet}&lt;/p>
                    &lt;p>&lt;strong>Contenu:&lt;/strong>&lt;/p>
                    &lt;div style="background: #f0f0f0; padding: 10px; border-radius: 4px;">
                        ${variables.contenu}
                    &lt;/div>
                    ${variables.metadata &amp;&amp; Object.keys(variables.metadata).length > 0 ? `
                        &lt;p>&lt;strong>MÃ©tadonnÃ©es:&lt;/strong>&lt;/p>
                        &lt;pre style="background: #f0f0f0; padding: 10px; border-radius: 4px; font-size: 11px;">
${JSON.stringify(variables.metadata, null, 2)}
                        &lt;/pre>
                    ` : ''}
                    &lt;p>&lt;small>Timestamp: ${variables.timestamp}&lt;/small>&lt;/p>
                `;

            default:
                return `
                    &lt;p>Email automatique depuis ${this.fromName}&lt;/p>
                    &lt;pre>${JSON.stringify(variables, null, 2)}&lt;/pre>
                `;
        }
    }

    /**
     * Test la configuration du service email
     * @param {string} testEmail - Email de test (optionnel)
     * @returns {Promise&lt;Object>} RÃ©sultat du test
     */
    async testerConfiguration(testEmail = null) {
        const emailTest = testEmail || process.env.ADMIN_EMAIL || 'test@example.com';
        
        this.log('info', 'Test de configuration email', { email_test: emailTest });

        try {
            const result = await this.envoyer({
                to: emailTest,
                subject: 'Test de configuration EmailService',
                template: 'test-configuration',
                variables: {
                    message: 'Si vous recevez cet email, la configuration fonctionne correctement !',
                    timestamp: new Date().toISOString()
                }
            });

            return {
                success: result.success,
                message: result.success ? 'Test rÃ©ussi' : 'Test Ã©chouÃ©',
                details: result
            };

        } catch (error) {
            this.logError(error, { context: 'test_configuration' });
            return {
                success: false,
                message: 'Erreur lors du test',
                error: error.message
            };
        }
    }
}

module.exports = EmailService;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Actualite.html">Actualite</a></li><li><a href="AdminController.html">AdminController</a></li><li><a href="AdminOracleService.html">AdminOracleService</a></li><li><a href="AnonymousTokenService.html">AnonymousTokenService</a></li><li><a href="AuthentificationController.html">AuthentificationController</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="BasePdfKitService.html">BasePdfKitService</a></li><li><a href="BaseService.html">BaseService</a></li><li><a href="CharacterSheetDocument.html">CharacterSheetDocument</a></li><li><a href="ClassPlanDocument.html">ClassPlanDocument</a></li><li><a href="DocumentFactory.html">DocumentFactory</a></li><li><a href="DonationController.html">DonationController</a></li><li><a href="EmailService.html">EmailService</a></li><li><a href="EmailTemplate.html">EmailTemplate</a></li><li><a href="GenericDocument.html">GenericDocument</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="MarkdownService.html">MarkdownService</a></li><li><a href="MonsterheartsTheme.html">MonsterheartsTheme</a></li><li><a href="Newsletter.html">Newsletter</a></li><li><a href="NewsletterService.html">NewsletterService</a></li><li><a href="Oracle.html">Oracle</a></li><li><a href="OracleController.html">OracleController</a></li><li><a href="OracleItem.html">OracleItem</a></li><li><a href="OracleService.html">OracleService</a></li><li><a href="Pdf.html">Pdf</a></li><li><a href="PdfController.html">PdfController</a></li><li><a href="PdfKitService.html">PdfKitService</a></li><li><a href="PdfService.html">PdfService</a></li><li><a href="Personnage.html">Personnage</a></li><li><a href="PersonnageController.html">PersonnageController</a></li><li><a href="PersonnageService.html">PersonnageService</a></li><li><a href="SystemRightsService.html">SystemRightsService</a></li><li><a href="SystemTheme.html">SystemTheme</a></li><li><a href="Temoignage.html">Temoignage</a></li><li><a href="TemoignageService.html">TemoignageService</a></li><li><a href="TemplateService.html">TemplateService</a></li><li><a href="Utilisateur.html">Utilisateur</a></li><li><a href="UtilisateurService.html">UtilisateurService</a></li></ul><h3>Global</h3><ul><li><a href="global.html#compareVersions">compareVersions</a></li><li><a href="global.html#createMigrationsTable">createMigrationsTable</a></li><li><a href="global.html#createTables">createTables</a></li><li><a href="global.html#executeMigration">executeMigration</a></li><li><a href="global.html#getCurrentVersion">getCurrentVersion</a></li><li><a href="global.html#getExecutedMigrations">getExecutedMigrations</a></li><li><a href="global.html#getMigrationStatus">getMigrationStatus</a></li><li><a href="global.html#getVersionsToMigrate">getVersionsToMigrate</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#isDatabaseInitialized">isDatabaseInitialized</a></li><li><a href="global.html#markMigrationExecuted">markMigrationExecuted</a></li><li><a href="global.html#migrateDatabase">migrateDatabase</a></li><li><a href="global.html#migrateToLatest">migrateToLatest</a></li><li><a href="global.html#migrateToVersion">migrateToVersion</a></li><li><a href="global.html#migrations">migrations</a></li><li><a href="global.html#resetDatabase">resetDatabase</a></li><li><a href="global.html#rollbackMigration">rollbackMigration</a></li><li><a href="global.html#updateAppVersion">updateAppVersion</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue Jul 22 2025 11:17:14 GMT+0200 (heure dâ€™Ã©tÃ© dâ€™Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
