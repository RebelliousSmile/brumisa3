<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/controllers/VoteController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/controllers/VoteController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const BaseController = require('./BaseController');
const DocumentVote = require('../models/DocumentVote');
const Document = require('../models/Document');

/**
 * Contrôleur pour la gestion des votes sur documents
 * Implémente les fonctionnalités de vote communautaire selon FONCTIONNALITES/05-partage-communaute.md
 */
class VoteController extends BaseController {
    constructor() {
        super('VoteController');
    }

    /**
     * Voter pour un document public
     * POST /api/documents/:id/vote
     */
    voterDocument = this.wrapAsync(async (req, res) => {
        this.validerParametres(req, ['id']);
        const utilisateur = this.verifierPermissions(req, 'UTILISATEUR');
        
        const documentId = parseInt(req.params.id);
        const { qualite_generale, utilite_pratique, respect_gamme } = req.body;
        
        // Validation des scores de vote (1-5 étoiles)
        if (!qualite_generale || !utilite_pratique || !respect_gamme) {
            const erreur = new Error('Les 3 critères de vote sont requis : qualite_generale, utilite_pratique, respect_gamme');
            erreur.name = 'ValidationError';
            throw erreur;
        }
        
        [qualite_generale, utilite_pratique, respect_gamme].forEach(score => {
            const note = parseInt(score);
            if (note &lt; 1 || note > 5) {
                const erreur = new Error('Chaque critère doit être noté entre 1 et 5 étoiles');
                erreur.name = 'ValidationError';
                throw erreur;
            }
        });

        // Vérifier que le document existe et est public
        const document = await Document.findById(documentId);
        if (!document) {
            return this.repondreErreur(res, 404, 'Document non trouvé', 'not_found');
        }
        
        if (!document.est_public) {
            return this.repondreErreur(res, 403, 'Ce document n\'est pas public et ne peut être voté', 'forbidden');
        }
        
        // Empêcher l'auto-vote
        if (document.utilisateur_id === utilisateur.id) {
            return this.repondreErreur(res, 403, 'Vous ne pouvez pas voter pour vos propres documents', 'forbidden');
        }

        try {
            // Créer ou mettre à jour le vote
            const voteData = {
                document_id: documentId,
                utilisateur_id: utilisateur.id,
                qualite_generale: parseInt(qualite_generale),
                utilite_pratique: parseInt(utilite_pratique),
                respect_gamme: parseInt(respect_gamme)
            };

            const vote = await DocumentVote.upsert(voteData, ['document_id', 'utilisateur_id']);
            
            // Calculer les nouvelles statistiques du document
            const statistiques = await DocumentVote.getStatistiquesDocument(documentId);
            
            this.logger.info('Vote enregistré', {
                document_id: documentId,
                utilisateur_id: utilisateur.id,
                scores: voteData
            });

            return this.repondreSucces(res, {
                vote,
                statistiques
            }, 'Vote enregistré avec succès');
            
        } catch (erreur) {
            // Gestion spécifique pour contrainte unique (upsert failed)
            if (erreur.code === '23505') {
                return this.repondreErreur(res, 409, 'Vous avez déjà voté pour ce document', 'conflit');
            }
            throw erreur;
        }
    });

    /**
     * Supprimer son vote sur un document
     * DELETE /api/documents/:id/vote
     */
    supprimerVote = this.wrapAsync(async (req, res) => {
        this.validerParametres(req, ['id']);
        const utilisateur = this.verifierPermissions(req, 'UTILISATEUR');
        
        const documentId = parseInt(req.params.id);
        
        const vote = await DocumentVote.findOne({
            document_id: documentId,
            utilisateur_id: utilisateur.id
        });
        
        if (!vote) {
            return this.repondreErreur(res, 404, 'Aucun vote trouvé pour ce document', 'not_found');
        }
        
        await DocumentVote.delete(vote.id);
        
        // Recalculer les statistiques
        const statistiques = await DocumentVote.getStatistiquesDocument(documentId);
        
        this.logger.info('Vote supprimé', {
            document_id: documentId,
            utilisateur_id: utilisateur.id
        });
        
        return this.repondreSucces(res, { statistiques }, 'Vote supprimé avec succès');
    });

    /**
     * Obtenir les statistiques de votes d'un document
     * GET /api/documents/:id/statistiques-votes
     */
    obtenirStatistiquesDocument = this.wrapAsync(async (req, res) => {
        this.validerParametres(req, ['id']);
        const documentId = parseInt(req.params.id);
        
        // Vérifier que le document existe
        const document = await Document.findById(documentId);
        if (!document) {
            return this.repondreErreur(res, 404, 'Document non trouvé', 'not_found');
        }
        
        const statistiques = await DocumentVote.getStatistiquesDocument(documentId);
        
        return this.repondreSucces(res, statistiques, 'Statistiques récupérées');
    });

    /**
     * Obtenir le vote d'un utilisateur pour un document
     * GET /api/documents/:id/mon-vote
     */
    obtenirMonVote = this.wrapAsync(async (req, res) => {
        this.validerParametres(req, ['id']);
        const utilisateur = this.verifierPermissions(req, 'UTILISATEUR');
        
        const documentId = parseInt(req.params.id);
        
        const vote = await DocumentVote.findOne({
            document_id: documentId,
            utilisateur_id: utilisateur.id
        });
        
        if (!vote) {
            return this.repondreSucces(res, null, 'Aucun vote trouvé');
        }
        
        return this.repondreSucces(res, vote, 'Vote récupéré');
    });

    /**
     * Lister les documents les plus plébiscités par système
     * GET /api/communaute/:systeme/documents-populaires
     */
    documentsPopulaires = this.wrapAsync(async (req, res) => {
        this.validerParametres(req, ['systeme']);
        const { systeme } = req.params;
        const pagination = this.extrairePagination(req);
        const { type } = req.query; // Filtrer par type de document optionnel
        
        const conditions = {
            systeme,
            est_public: true,
            ...(type &amp;&amp; { type })
        };
        
        // Récupérer les documents avec leurs statistiques de votes
        const documentsAvecVotes = await DocumentVote.getDocumentsPopulaires(
            conditions,
            pagination.limite,
            pagination.offset
        );
        
        const total = await Document.count(conditions);
        
        return this.repondrePagine(res, documentsAvecVotes, {
            ...pagination,
            total
        }, 'Documents populaires récupérés');
    });

    /**
     * Lister les documents récemment partagés par système
     * GET /api/communaute/:systeme/documents-recents
     */
    documentsRecents = this.wrapAsync(async (req, res) => {
        this.validerParametres(req, ['systeme']);
        const { systeme } = req.params;
        const pagination = this.extrairePagination(req);
        const { type } = req.query;
        
        const conditions = {
            systeme,
            est_public: true,
            ...(type &amp;&amp; { type })
        };
        
        const documents = await Document.findAll(conditions, {
            orderBy: [['created_at', 'DESC']],
            limit: pagination.limite,
            offset: pagination.offset
        });
        
        const total = await Document.count(conditions);
        
        return this.repondrePagine(res, documents, {
            ...pagination,
            total
        }, 'Documents récents récupérés');
    });
}

module.exports = VoteController;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Actualite.html">Actualite</a></li><li><a href="AdminController.html">AdminController</a></li><li><a href="AdminOracleService.html">AdminOracleService</a></li><li><a href="AnonymousTokenService.html">AnonymousTokenService</a></li><li><a href="AuthentificationController.html">AuthentificationController</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="BasePdfKitService.html">BasePdfKitService</a></li><li><a href="BaseService.html">BaseService</a></li><li><a href="CacheService.html">CacheService</a></li><li><a href="CharacterSheetDocument.html">CharacterSheetDocument</a></li><li><a href="ClassPlanDocument.html">ClassPlanDocument</a></li><li><a href="DangerDocument.html">DangerDocument</a></li><li><a href="DemandeChangementEmail.html">DemandeChangementEmail</a></li><li><a href="Document.html">Document</a></li><li><a href="DocumentFactory.html">DocumentFactory</a></li><li><a href="DocumentModerationHistorique.html">DocumentModerationHistorique</a></li><li><a href="DocumentModerationService.html">DocumentModerationService</a></li><li><a href="DocumentSystemeJeu.html">DocumentSystemeJeu</a></li><li><a href="DocumentVote.html">DocumentVote</a></li><li><a href="DonationController.html">DonationController</a></li><li><a href="EmailService.html">EmailService</a></li><li><a href="EmailTemplate.html">EmailTemplate</a></li><li><a href="EngrenagesTheme.html">EngrenagesTheme</a></li><li><a href="GenericDocument.html">GenericDocument</a></li><li><a href="GroupDocument.html">GroupDocument</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="LoggingService.html">LoggingService</a></li><li><a href="MarkdownService.html">MarkdownService</a></li><li><a href="Metro2033Theme.html">Metro2033Theme</a></li><li><a href="MistEngineTheme.html">MistEngineTheme</a></li><li><a href="ModerationController.html">ModerationController</a></li><li><a href="MonsterheartsTheme.html">MonsterheartsTheme</a></li><li><a href="NavigationService.html">NavigationService</a></li><li><a href="Newsletter.html">Newsletter</a></li><li><a href="NewsletterService.html">NewsletterService</a></li><li><a href="Oracle.html">Oracle</a></li><li><a href="OracleController.html">OracleController</a></li><li><a href="OracleItem.html">OracleItem</a></li><li><a href="OracleService.html">OracleService</a></li><li><a href="OrganizationDocument.html">OrganizationDocument</a></li><li><a href="Pdf.html">Pdf</a></li><li><a href="PdfController.html">PdfController</a></li><li><a href="PdfKitService.html">PdfKitService</a></li><li><a href="PdfService.html">PdfService</a></li><li><a href="PerformanceMiddleware.html">PerformanceMiddleware</a></li><li><a href="PerformanceMonitoringService.html">PerformanceMonitoringService</a></li><li><a href="Personnage.html">Personnage</a></li><li><a href="PersonnageController.html">PersonnageController</a></li><li><a href="PersonnageService.html">PersonnageService</a></li><li><a href="ProductionApp.html">ProductionApp</a></li><li><a href="QueueService.html">QueueService</a></li><li><a href="RgpdConsentement.html">RgpdConsentement</a></li><li><a href="RgpdService.html">RgpdService</a></li><li><a href="SecurityService.html">SecurityService</a></li><li><a href="ShareService.html">ShareService</a></li><li><a href="SystemCardViewModel.html">SystemCardViewModel</a></li><li><a href="SystemMaintenanceService.html">SystemMaintenanceService</a></li><li><a href="SystemRightsService.html">SystemRightsService</a></li><li><a href="SystemService.html">SystemService</a></li><li><a href="SystemTheme.html">SystemTheme</a></li><li><a href="SystemThemeService.html">SystemThemeService</a></li><li><a href="SystemeJeu.html">SystemeJeu</a></li><li><a href="Temoignage.html">Temoignage</a></li><li><a href="TemoignageService.html">TemoignageService</a></li><li><a href="TemplateService.html">TemplateService</a></li><li><a href="ThemeService.html">ThemeService</a></li><li><a href="TownDocument.html">TownDocument</a></li><li><a href="Utilisateur.html">Utilisateur</a></li><li><a href="UtilisateurService.html">UtilisateurService</a></li><li><a href="VoteController.html">VoteController</a></li><li><a href="VoteService.html">VoteService</a></li><li><a href="ZombiologyTheme.html">ZombiologyTheme</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AuthComponent">AuthComponent</a></li><li><a href="global.html#InscriptionComponent">InscriptionComponent</a></li><li><a href="global.html#Joi">Joi</a></li><li><a href="global.html#MotDePasseOublieComponent">MotDePasseOublieComponent</a></li><li><a href="global.html#ReinitialiserMotDePasseComponent">ReinitialiserMotDePasseComponent</a></li><li><a href="global.html#actionFlottante">actionFlottante</a></li><li><a href="global.html#ajouterTemoignage">ajouterTemoignage</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#auth">auth</a></li><li><a href="global.html#chargerDonneesAccueil">chargerDonneesAccueil</a></li><li><a href="global.html#chargerInfosDons">chargerInfosDons</a></li><li><a href="global.html#choixModeCreation">choixModeCreation</a></li><li><a href="global.html#choixTypeDocument">choixTypeDocument</a></li><li><a href="global.html#compareVersions">compareVersions</a></li><li><a href="global.html#createError">createError</a></li><li><a href="global.html#createMigrationsTable">createMigrationsTable</a></li><li><a href="global.html#createTables">createTables</a></li><li><a href="global.html#creationPersonnage">creationPersonnage</a></li><li><a href="global.html#database">database</a></li><li><a href="global.html#elevationRole">elevationRole</a></li><li><a href="global.html#executeMigration">executeMigration</a></li><li><a href="global.html#fichePersonnage">fichePersonnage</a></li><li><a href="global.html#formaterDate">formaterDate</a></li><li><a href="global.html#formaterNombre">formaterNombre</a></li><li><a href="global.html#formaterTailleFichier">formaterTailleFichier</a></li><li><a href="global.html#genererEtoiles">genererEtoiles</a></li><li><a href="global.html#getCurrentVersion">getCurrentVersion</a></li><li><a href="global.html#getErrorMessage">getErrorMessage</a></li><li><a href="global.html#getExecutedMigrations">getExecutedMigrations</a></li><li><a href="global.html#getMigrationStatus">getMigrationStatus</a></li><li><a href="global.html#getVersionsToMigrate">getVersionsToMigrate</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#handleNotFound">handleNotFound</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#inscrireNewsletter">inscrireNewsletter</a></li><li><a href="global.html#isDatabaseInitialized">isDatabaseInitialized</a></li><li><a href="global.html#listePersonnages">listePersonnages</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#markMigrationExecuted">markMigrationExecuted</a></li><li><a href="global.html#menuUtilisateur">menuUtilisateur</a></li><li><a href="global.html#mesDocuments">mesDocuments</a></li><li><a href="global.html#migrateDatabase">migrateDatabase</a></li><li><a href="global.html#migrateToLatest">migrateToLatest</a></li><li><a href="global.html#migrateToVersion">migrateToVersion</a></li><li><a href="global.html#migrations">migrations</a></li><li><a href="global.html#navigationFormulaire">navigationFormulaire</a></li><li><a href="global.html#naviguerVersSysteme">naviguerVersSysteme</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#ouvrirLienDon">ouvrirLienDon</a></li><li><a href="global.html#partageDocument">partageDocument</a></li><li><a href="global.html#partagerPdf">partagerPdf</a></li><li><a href="global.html#path">path</a></li><li><a href="global.html#previewHtml">previewHtml</a></li><li><a href="global.html#requireAdmin">requireAdmin</a></li><li><a href="global.html#requireAuth">requireAuth</a></li><li><a href="global.html#requirePremium">requirePremium</a></li><li><a href="global.html#resetDatabase">resetDatabase</a></li><li><a href="global.html#rollbackMigration">rollbackMigration</a></li><li><a href="global.html#schemas">schemas</a></li><li><a href="global.html#scrollVersSection">scrollVersSection</a></li><li><a href="global.html#selectionSysteme">selectionSysteme</a></li><li><a href="global.html#updateAppVersion">updateAppVersion</a></li><li><a href="global.html#validateFiles">validateFiles</a></li><li><a href="global.html#validateRequest">validateRequest</a></li><li><a href="global.html#verifierAuth">verifierAuth</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Aug 08 2025 18:20:12 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
