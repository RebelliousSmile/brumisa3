<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/AnonymousTokenService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/AnonymousTokenService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const crypto = require('crypto');

/**
 * Service de gestion des tokens pour utilisateurs anonymes
 * Permet la g√©n√©ration PDF s√©curis√©e sans compte utilisateur
 */
class AnonymousTokenService {
    constructor() {
        // Cache en m√©moire des tokens (en production, utiliser Redis)
        this.tokens = new Map();
        this.cleanupInterval = null;
        
        // Ne pas d√©marrer le cleanup automatiquement dans les tests
        if (process.env.NODE_ENV !== 'test') {
            this.startCleanup();
        }
    }

    /**
     * G√©n√®re un token temporaire pour utilisateur anonyme
     * @param {string} sessionId - ID de session ou fingerprint
     * @param {Object} limitations - Limitations sp√©cifiques
     * @returns {Object} Token et informations
     */
    generateToken(sessionId = null, limitations = {}) {
        const token = crypto.randomBytes(32).toString('hex');
        const now = Date.now();
        
        const tokenData = {
            token,
            sessionId: sessionId || this.generateSessionId(),
            createdAt: now,
            expiresAt: now + (30 * 60 * 1000), // 30 minutes
            usageCount: 0,
            maxUsage: limitations.maxUsage || 5, // Max 5 PDFs par token
            maxSizeKB: limitations.maxSizeKB || 500, // Max 500KB par PDF
            allowedSystems: limitations.allowedSystems || ['monsterhearts'],
            lastUsed: null,
            rateLimitWindow: now,
            rateLimitCount: 0
        };

        this.tokens.set(token, tokenData);
        
        return {
            token,
            sessionId: tokenData.sessionId,
            expiresIn: 30 * 60, // 30 minutes en secondes
            limitations: {
                maxUsage: tokenData.maxUsage,
                maxSizeKB: tokenData.maxSizeKB,
                allowedSystems: tokenData.allowedSystems
            }
        };
    }

    /**
     * Valide un token et v√©rifie les limitations
     * @param {string} token - Token √† valider
     * @param {string} system - Syst√®me de jeu demand√©
     * @returns {Object} R√©sultat de validation
     */
    validateToken(token, system = 'monsterhearts') {
        const tokenData = this.tokens.get(token);
        
        if (!tokenData) {
            return { valid: false, reason: 'TOKEN_NOT_FOUND' };
        }

        const now = Date.now();

        // V√©rifier expiration
        if (now > tokenData.expiresAt) {
            this.tokens.delete(token);
            return { valid: false, reason: 'TOKEN_EXPIRED' };
        }

        // V√©rifier nombre d'utilisations
        if (tokenData.usageCount >= tokenData.maxUsage) {
            return { valid: false, reason: 'USAGE_LIMIT_EXCEEDED' };
        }

        // V√©rifier syst√®me autoris√©
        if (!tokenData.allowedSystems.includes(system)) {
            return { valid: false, reason: 'SYSTEM_NOT_ALLOWED' };
        }

        // Rate limiting (max 2 requ√™tes par minute)
        const rateLimitWindow = 60 * 1000; // 1 minute
        if (now - tokenData.rateLimitWindow > rateLimitWindow) {
            tokenData.rateLimitWindow = now;
            tokenData.rateLimitCount = 0;
        }

        if (tokenData.rateLimitCount >= 2) {
            return { valid: false, reason: 'RATE_LIMIT_EXCEEDED' };
        }

        return {
            valid: true,
            tokenData,
            remainingUsage: tokenData.maxUsage - tokenData.usageCount,
            sessionId: tokenData.sessionId
        };
    }

    /**
     * Marque un token comme utilis√©
     * @param {string} token - Token utilis√©
     * @param {number} pdfSizeKB - Taille du PDF g√©n√©r√©
     * @returns {boolean} Succ√®s de l'op√©ration
     */
    markTokenUsed(token, pdfSizeKB = 0) {
        const tokenData = this.tokens.get(token);
        
        if (!tokenData) {
            return false;
        }

        // V√©rifier la taille limite
        if (pdfSizeKB > tokenData.maxSizeKB) {
            return false;
        }

        tokenData.usageCount++;
        tokenData.lastUsed = Date.now();
        tokenData.rateLimitCount++;

        // Si usage √©puis√©, supprimer le token
        if (tokenData.usageCount >= tokenData.maxUsage) {
            this.tokens.delete(token);
        }

        return true;
    }

    /**
     * R√©voque un token sp√©cifique
     * @param {string} token - Token √† r√©voquer
     * @returns {boolean} Succ√®s de l'op√©ration
     */
    revokeToken(token) {
        return this.tokens.delete(token);
    }

    /**
     * R√©voque tous les tokens d'une session
     * @param {string} sessionId - ID de session
     * @returns {number} Nombre de tokens r√©voqu√©s
     */
    revokeSessionTokens(sessionId) {
        let revokedCount = 0;
        
        for (const [token, tokenData] of this.tokens.entries()) {
            if (tokenData.sessionId === sessionId) {
                this.tokens.delete(token);
                revokedCount++;
            }
        }
        
        return revokedCount;
    }

    /**
     * Obtient les statistiques d'usage d'un token
     * @param {string} token - Token √† analyser
     * @returns {Object|null} Statistiques ou null si non trouv√©
     */
    getTokenStats(token) {
        const tokenData = this.tokens.get(token);
        
        if (!tokenData) {
            return null;
        }

        return {
            usageCount: tokenData.usageCount,
            maxUsage: tokenData.maxUsage,
            remainingUsage: tokenData.maxUsage - tokenData.usageCount,
            createdAt: tokenData.createdAt,
            expiresAt: tokenData.expiresAt,
            lastUsed: tokenData.lastUsed,
            allowedSystems: tokenData.allowedSystems
        };
    }

    /**
     * G√©n√®re un ID de session unique
     * @returns {string} ID de session
     */
    generateSessionId() {
        return crypto.randomBytes(16).toString('hex');
    }

    /**
     * Nettoie automatiquement les tokens expir√©s
     */
    startCleanup() {
        // Ne pas d√©marrer plusieurs timers
        if (this.cleanupInterval) {
            return;
        }
        
        // Nettoyer toutes les 5 minutes
        this.cleanupInterval = setInterval(() => {
            this.cleanupExpiredTokens();
        }, 5 * 60 * 1000);
    }

    /**
     * Arr√™te le nettoyage automatique (pour les tests)
     */
    stopCleanup() {
        if (this.cleanupInterval) {
            clearInterval(this.cleanupInterval);
            this.cleanupInterval = null;
        }
    }

    /**
     * Nettoie les tokens expir√©s
     * @returns {number} Nombre de tokens supprim√©s
     */
    cleanupExpiredTokens() {
        const now = Date.now();
        let cleanedCount = 0;

        for (const [token, tokenData] of this.tokens.entries()) {
            if (now > tokenData.expiresAt) {
                this.tokens.delete(token);
                cleanedCount++;
            }
        }

        if (cleanedCount > 0) {
            console.log(`üßπ Nettoyage: ${cleanedCount} tokens anonymes expir√©s supprim√©s`);
        }

        return cleanedCount;
    }

    /**
     * Obtient les statistiques globales
     * @returns {Object} Statistiques globales
     */
    getGlobalStats() {
        const now = Date.now();
        let activeTokens = 0;
        let totalUsage = 0;

        for (const tokenData of this.tokens.values()) {
            if (now &lt;= tokenData.expiresAt) {
                activeTokens++;
            }
            totalUsage += tokenData.usageCount;
        }

        return {
            activeTokens,
            totalTokens: this.tokens.size,
            totalUsage,
            averageUsage: totalUsage / Math.max(this.tokens.size, 1)
        };
    }

    /**
     * Arr√™te le service de nettoyage
     */
    stop() {
        if (this.cleanupInterval) {
            clearInterval(this.cleanupInterval);
            this.cleanupInterval = null;
        }
    }

    /**
     * Obtient les erreurs en fran√ßais
     * @param {string} reason - Raison de l'erreur
     * @returns {string} Message d'erreur
     */
    static getErrorMessage(reason) {
        const messages = {
            TOKEN_NOT_FOUND: 'Token non valide ou expir√©',
            TOKEN_EXPIRED: 'Token expir√©, veuillez recharger la page',
            USAGE_LIMIT_EXCEEDED: 'Limite d\'utilisation atteinte pour ce token',
            SYSTEM_NOT_ALLOWED: 'Syst√®me de jeu non autoris√© pour ce token',
            RATE_LIMIT_EXCEEDED: 'Trop de requ√™tes, veuillez patienter',
            PDF_TOO_LARGE: 'Document trop volumineux pour un utilisateur anonyme'
        };

        return messages[reason] || 'Erreur de validation du token';
    }
}

module.exports = AnonymousTokenService;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Actualite.html">Actualite</a></li><li><a href="AdminController.html">AdminController</a></li><li><a href="AdminOracleService.html">AdminOracleService</a></li><li><a href="AnonymousTokenService.html">AnonymousTokenService</a></li><li><a href="AuthentificationController.html">AuthentificationController</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="BasePdfKitService.html">BasePdfKitService</a></li><li><a href="BaseService.html">BaseService</a></li><li><a href="CacheService.html">CacheService</a></li><li><a href="CharacterSheetDocument.html">CharacterSheetDocument</a></li><li><a href="ClassPlanDocument.html">ClassPlanDocument</a></li><li><a href="DangerDocument.html">DangerDocument</a></li><li><a href="DemandeChangementEmail.html">DemandeChangementEmail</a></li><li><a href="Document.html">Document</a></li><li><a href="DocumentFactory.html">DocumentFactory</a></li><li><a href="DocumentModerationHistorique.html">DocumentModerationHistorique</a></li><li><a href="DocumentModerationService.html">DocumentModerationService</a></li><li><a href="DocumentSystemeJeu.html">DocumentSystemeJeu</a></li><li><a href="DocumentVote.html">DocumentVote</a></li><li><a href="DonationController.html">DonationController</a></li><li><a href="EmailService.html">EmailService</a></li><li><a href="EmailTemplate.html">EmailTemplate</a></li><li><a href="EngrenagesTheme.html">EngrenagesTheme</a></li><li><a href="GenericDocument.html">GenericDocument</a></li><li><a href="GroupDocument.html">GroupDocument</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="LoggingService.html">LoggingService</a></li><li><a href="MaintenanceWorker.html">MaintenanceWorker</a></li><li><a href="MarkdownService.html">MarkdownService</a></li><li><a href="Metro2033Theme.html">Metro2033Theme</a></li><li><a href="MistEngineTheme.html">MistEngineTheme</a></li><li><a href="ModerationController.html">ModerationController</a></li><li><a href="MonsterheartsTheme.html">MonsterheartsTheme</a></li><li><a href="Newsletter.html">Newsletter</a></li><li><a href="NewsletterService.html">NewsletterService</a></li><li><a href="Oracle.html">Oracle</a></li><li><a href="OracleController.html">OracleController</a></li><li><a href="OracleItem.html">OracleItem</a></li><li><a href="OracleService.html">OracleService</a></li><li><a href="OrganizationDocument.html">OrganizationDocument</a></li><li><a href="Pdf.html">Pdf</a></li><li><a href="PdfController.html">PdfController</a></li><li><a href="PdfKitService.html">PdfKitService</a></li><li><a href="PdfService.html">PdfService</a></li><li><a href="PerformanceMiddleware.html">PerformanceMiddleware</a></li><li><a href="PerformanceMonitoringService.html">PerformanceMonitoringService</a></li><li><a href="Personnage.html">Personnage</a></li><li><a href="PersonnageController.html">PersonnageController</a></li><li><a href="PersonnageService.html">PersonnageService</a></li><li><a href="ProductionApp.html">ProductionApp</a></li><li><a href="QueueService.html">QueueService</a></li><li><a href="QueueWorker.html">QueueWorker</a></li><li><a href="RgpdConsentement.html">RgpdConsentement</a></li><li><a href="RgpdService.html">RgpdService</a></li><li><a href="SecurityService.html">SecurityService</a></li><li><a href="ShareService.html">ShareService</a></li><li><a href="SystemCardViewModel.html">SystemCardViewModel</a></li><li><a href="SystemMaintenanceService.html">SystemMaintenanceService</a></li><li><a href="SystemRightsService.html">SystemRightsService</a></li><li><a href="SystemService.html">SystemService</a></li><li><a href="SystemTheme.html">SystemTheme</a></li><li><a href="SystemThemeService.html">SystemThemeService</a></li><li><a href="SystemeJeu.html">SystemeJeu</a></li><li><a href="Temoignage.html">Temoignage</a></li><li><a href="TemoignageService.html">TemoignageService</a></li><li><a href="TemplateService.html">TemplateService</a></li><li><a href="TownDocument.html">TownDocument</a></li><li><a href="Utilisateur.html">Utilisateur</a></li><li><a href="UtilisateurService.html">UtilisateurService</a></li><li><a href="VoteController.html">VoteController</a></li><li><a href="VoteService.html">VoteService</a></li><li><a href="ZombiologyTheme.html">ZombiologyTheme</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Joi">Joi</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#auth">auth</a></li><li><a href="global.html#compareVersions">compareVersions</a></li><li><a href="global.html#createError">createError</a></li><li><a href="global.html#createMigrationsTable">createMigrationsTable</a></li><li><a href="global.html#createTables">createTables</a></li><li><a href="global.html#database">database</a></li><li><a href="global.html#executeMigration">executeMigration</a></li><li><a href="global.html#getCurrentVersion">getCurrentVersion</a></li><li><a href="global.html#getErrorMessage">getErrorMessage</a></li><li><a href="global.html#getExecutedMigrations">getExecutedMigrations</a></li><li><a href="global.html#getMigrationStatus">getMigrationStatus</a></li><li><a href="global.html#getVersionsToMigrate">getVersionsToMigrate</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#handleNotFound">handleNotFound</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#isDatabaseInitialized">isDatabaseInitialized</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#markMigrationExecuted">markMigrationExecuted</a></li><li><a href="global.html#migrateDatabase">migrateDatabase</a></li><li><a href="global.html#migrateToLatest">migrateToLatest</a></li><li><a href="global.html#migrateToVersion">migrateToVersion</a></li><li><a href="global.html#migrations">migrations</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#path">path</a></li><li><a href="global.html#requireAdmin">requireAdmin</a></li><li><a href="global.html#requireAuth">requireAuth</a></li><li><a href="global.html#requirePremium">requirePremium</a></li><li><a href="global.html#resetDatabase">resetDatabase</a></li><li><a href="global.html#rollbackMigration">rollbackMigration</a></li><li><a href="global.html#schemas">schemas</a></li><li><a href="global.html#updateAppVersion">updateAppVersion</a></li><li><a href="global.html#validateFiles">validateFiles</a></li><li><a href="global.html#validateRequest">validateRequest</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Aug 08 2025 18:17:39 GMT+0200 (heure d‚Äô√©t√© d‚ÄôEurope centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
