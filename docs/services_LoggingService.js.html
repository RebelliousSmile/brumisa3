<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/LoggingService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/LoggingService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const winston = require('winston');
const path = require('path');
const fs = require('fs');

/**
 * Service de logging production avec Winston
 * Configuration avancée pour production avec rotation et niveaux
 */
class LoggingService {
    constructor() {
        this.logDir = process.env.LOG_DIR || path.join(process.cwd(), 'logs');
        this.ensureLogDirectory();
        
        this.logger = this.createLogger();
        this.setupEventHandlers();
    }

    /**
     * Assure que le répertoire de logs existe
     */
    ensureLogDirectory() {
        if (!fs.existsSync(this.logDir)) {
            fs.mkdirSync(this.logDir, { recursive: true });
        }
    }

    /**
     * Crée le logger Winston configuré
     */
    createLogger() {
        const isProduction = process.env.NODE_ENV === 'production';
        const logLevel = process.env.LOG_LEVEL || (isProduction ? 'info' : 'debug');
        
        // Format personnalisé pour la production
        const productionFormat = winston.format.combine(
            winston.format.timestamp({
                format: process.env.LOG_DATE_PATTERN || 'YYYY-MM-DD HH:mm:ss'
            }),
            winston.format.errors({ stack: true }),
            winston.format.json(),
            winston.format.printf(({ timestamp, level, message, service, ...meta }) => {
                const logEntry = {
                    timestamp,
                    level: level.toUpperCase(),
                    service: service || 'brumisater',
                    message,
                    pid: process.pid,
                    environment: process.env.NODE_ENV,
                    ...meta
                };
                
                return JSON.stringify(logEntry);
            })
        );
        
        // Format pour le développement (plus lisible)
        const developmentFormat = winston.format.combine(
            winston.format.timestamp({ format: 'HH:mm:ss' }),
            winston.format.errors({ stack: true }),
            winston.format.colorize(),
            winston.format.printf(({ timestamp, level, message, service, ...meta }) => {
                const metaStr = Object.keys(meta).length ? '\n' + JSON.stringify(meta, null, 2) : '';
                return `[${timestamp}] ${level} [${service || 'brumisater'}]: ${message}${metaStr}`;
            })
        );
        
        const transports = [];
        
        // Console transport (toujours présent)
        transports.push(new winston.transports.Console({
            level: logLevel,
            format: isProduction ? productionFormat : developmentFormat,
            handleExceptions: true,
            handleRejections: true
        }));
        
        if (isProduction) {
            // Transport pour les erreurs (fichier séparé)
            transports.push(new winston.transports.File({
                filename: path.join(this.logDir, 'error.log'),
                level: 'error',
                format: productionFormat,
                maxsize: parseInt(process.env.LOG_MAX_SIZE) || 10485760, // 10MB par défaut
                maxFiles: parseInt(process.env.LOG_MAX_FILES) || 10,
                tailable: true
            }));
            
            // Transport pour tous les logs
            transports.push(new winston.transports.File({
                filename: path.join(this.logDir, 'combined.log'),
                format: productionFormat,
                maxsize: parseInt(process.env.LOG_MAX_SIZE) || 10485760, // 10MB par défaut
                maxFiles: parseInt(process.env.LOG_MAX_FILES) || 14,
                tailable: true
            }));
            
            // Transport pour les logs d'accès (performance)
            transports.push(new winston.transports.File({
                filename: path.join(this.logDir, 'access.log'),
                level: 'http',
                format: productionFormat,
                maxsize: 5242880, // 5MB
                maxFiles: 7,
                tailable: true
            }));
        }
        
        return winston.createLogger({
            level: logLevel,
            format: productionFormat,
            transports,
            exitOnError: false,
            
            // Rejections et exceptions
            exceptionHandlers: [
                new winston.transports.File({
                    filename: path.join(this.logDir, 'exceptions.log'),
                    maxsize: 5242880, // 5MB
                    maxFiles: 5
                })
            ],
            
            rejectionHandlers: [
                new winston.transports.File({
                    filename: path.join(this.logDir, 'rejections.log'),
                    maxsize: 5242880, // 5MB
                    maxFiles: 5
                })
            ]
        });
    }

    /**
     * Configure les gestionnaires d'événements
     */
    setupEventHandlers() {
        // Événements du logger
        this.logger.on('error', (error) => {
            console.error('Erreur du logger Winston:', error);
        });
        
        // Gestionnaire pour les erreurs non attrapées
        process.on('uncaughtException', (error) => {
            this.logger.error('Exception non attrapée', {
                error: error.message,
                stack: error.stack,
                fatal: true
            });
        });
        
        process.on('unhandledRejection', (reason, promise) => {
            this.logger.error('Promise rejetée non gérée', {
                reason: reason?.message || reason,
                promise: promise.toString(),
                fatal: false
            });
        });
    }

    /**
     * Méthodes de logging simplifiées
     */
    debug(message, meta = {}) {
        this.logger.debug(message, meta);
    }

    info(message, meta = {}) {
        this.logger.info(message, meta);
    }

    warn(message, meta = {}) {
        this.logger.warn(message, meta);
    }

    error(message, meta = {}) {
        this.logger.error(message, meta);
    }

    http(message, meta = {}) {
        this.logger.http(message, meta);
    }

    /**
     * Log structuré pour les requêtes HTTP
     */
    logRequest(req, res, responseTime) {
        this.http('HTTP Request', {
            method: req.method,
            url: req.url,
            path: req.path,
            statusCode: res.statusCode,
            responseTime: responseTime + 'ms',
            userAgent: req.get('User-Agent'),
            ip: req.ip,
            userId: req.session?.userId || null,
            referer: req.get('Referer')
        });
    }

    /**
     * Log structuré pour les erreurs d'application
     */
    logError(error, context = {}) {
        this.error(error.message || 'Erreur inconnue', {
            error: error.message,
            stack: error.stack,
            code: error.code,
            ...context
        });
    }

    /**
     * Log structuré pour les métriques de performance
     */
    logPerformance(operation, duration, meta = {}) {
        const level = duration > 2000 ? 'warn' : 'info';
        
        this.logger.log(level, `Performance: ${operation}`, {
            operation,
            duration: duration + 'ms',
            isSlowOperation: duration > 1000,
            ...meta
        });
    }

    /**
     * Log structuré pour les événements business
     */
    logBusinessEvent(event, data = {}) {
        this.info(`Business Event: ${event}`, {
            event,
            timestamp: new Date().toISOString(),
            ...data
        });
    }

    /**
     * Log structuré pour la sécurité
     */
    logSecurity(event, details = {}) {
        this.warn(`Security Event: ${event}`, {
            event,
            security: true,
            timestamp: new Date().toISOString(),
            ...details
        });
    }

    /**
     * Crée un logger enfant avec contexte
     */
    child(context = {}) {
        return {
            debug: (message, meta = {}) => this.debug(message, { ...context, ...meta }),
            info: (message, meta = {}) => this.info(message, { ...context, ...meta }),
            warn: (message, meta = {}) => this.warn(message, { ...context, ...meta }),
            error: (message, meta = {}) => this.error(message, { ...context, ...meta }),
            http: (message, meta = {}) => this.http(message, { ...context, ...meta })
        };
    }

    /**
     * Obtient le logger Winston brut
     */
    getLogger() {
        return this.logger;
    }

    /**
     * Middleware Express pour logging automatique
     */
    middleware() {
        return (req, res, next) => {
            const startTime = Date.now();
            
            // Log de début de requête
            this.debug('Request started', {
                method: req.method,
                url: req.url,
                ip: req.ip,
                userAgent: req.get('User-Agent')
            });
            
            // Hook sur la fin de réponse
            const originalEnd = res.end;
            res.end = (...args) => {
                const responseTime = Date.now() - startTime;
                
                // Log de fin de requête
                this.logRequest(req, res, responseTime);
                
                // Log des erreurs 4xx/5xx
                if (res.statusCode >= 400) {
                    const level = res.statusCode >= 500 ? 'error' : 'warn';
                    this.logger.log(level, `HTTP ${res.statusCode}`, {
                        method: req.method,
                        url: req.url,
                        statusCode: res.statusCode,
                        responseTime: responseTime + 'ms',
                        ip: req.ip
                    });
                }
                
                originalEnd.apply(res, args);
            };
            
            next();
        };
    }

    /**
     * Ferme proprement le logger
     */
    async close() {
        return new Promise((resolve) => {
            this.logger.end(() => {
                resolve();
            });
        });
    }

    /**
     * Méthode statique pour créer une instance singleton
     */
    static create() {
        if (!LoggingService.instance) {
            LoggingService.instance = new LoggingService();
        }
        return LoggingService.instance;
    }

    /**
     * Niveaux de log disponibles
     */
    static get Levels() {
        return {
            ERROR: 'error',
            WARN: 'warn',
            INFO: 'info',
            HTTP: 'http',
            DEBUG: 'debug'
        };
    }
}

// Créer et exporter l'instance singleton
const loggingService = LoggingService.create();

module.exports = {
    LoggingService,
    logger: loggingService
};

// Exporter aussi le logger pour compatibilité
module.exports.default = loggingService;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Actualite.html">Actualite</a></li><li><a href="AdminController.html">AdminController</a></li><li><a href="AdminOracleService.html">AdminOracleService</a></li><li><a href="AnonymousTokenService.html">AnonymousTokenService</a></li><li><a href="AuthentificationController.html">AuthentificationController</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="BasePdfKitService.html">BasePdfKitService</a></li><li><a href="BaseService.html">BaseService</a></li><li><a href="CacheService.html">CacheService</a></li><li><a href="CharacterSheetDocument.html">CharacterSheetDocument</a></li><li><a href="ClassPlanDocument.html">ClassPlanDocument</a></li><li><a href="DangerDocument.html">DangerDocument</a></li><li><a href="DemandeChangementEmail.html">DemandeChangementEmail</a></li><li><a href="Document.html">Document</a></li><li><a href="DocumentFactory.html">DocumentFactory</a></li><li><a href="DocumentModerationHistorique.html">DocumentModerationHistorique</a></li><li><a href="DocumentModerationService.html">DocumentModerationService</a></li><li><a href="DocumentSystemeJeu.html">DocumentSystemeJeu</a></li><li><a href="DocumentVote.html">DocumentVote</a></li><li><a href="DonationController.html">DonationController</a></li><li><a href="EmailService.html">EmailService</a></li><li><a href="EmailTemplate.html">EmailTemplate</a></li><li><a href="EngrenagesTheme.html">EngrenagesTheme</a></li><li><a href="GenericDocument.html">GenericDocument</a></li><li><a href="GroupDocument.html">GroupDocument</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="LoggingService.html">LoggingService</a></li><li><a href="MaintenanceWorker.html">MaintenanceWorker</a></li><li><a href="MarkdownService.html">MarkdownService</a></li><li><a href="Metro2033Theme.html">Metro2033Theme</a></li><li><a href="MistEngineTheme.html">MistEngineTheme</a></li><li><a href="ModerationController.html">ModerationController</a></li><li><a href="MonsterheartsTheme.html">MonsterheartsTheme</a></li><li><a href="Newsletter.html">Newsletter</a></li><li><a href="NewsletterService.html">NewsletterService</a></li><li><a href="Oracle.html">Oracle</a></li><li><a href="OracleController.html">OracleController</a></li><li><a href="OracleItem.html">OracleItem</a></li><li><a href="OracleService.html">OracleService</a></li><li><a href="OrganizationDocument.html">OrganizationDocument</a></li><li><a href="Pdf.html">Pdf</a></li><li><a href="PdfController.html">PdfController</a></li><li><a href="PdfKitService.html">PdfKitService</a></li><li><a href="PdfService.html">PdfService</a></li><li><a href="PerformanceMiddleware.html">PerformanceMiddleware</a></li><li><a href="PerformanceMonitoringService.html">PerformanceMonitoringService</a></li><li><a href="Personnage.html">Personnage</a></li><li><a href="PersonnageController.html">PersonnageController</a></li><li><a href="PersonnageService.html">PersonnageService</a></li><li><a href="ProductionApp.html">ProductionApp</a></li><li><a href="QueueService.html">QueueService</a></li><li><a href="QueueWorker.html">QueueWorker</a></li><li><a href="RgpdConsentement.html">RgpdConsentement</a></li><li><a href="RgpdService.html">RgpdService</a></li><li><a href="SecurityService.html">SecurityService</a></li><li><a href="ShareService.html">ShareService</a></li><li><a href="SystemCardViewModel.html">SystemCardViewModel</a></li><li><a href="SystemMaintenanceService.html">SystemMaintenanceService</a></li><li><a href="SystemRightsService.html">SystemRightsService</a></li><li><a href="SystemService.html">SystemService</a></li><li><a href="SystemTheme.html">SystemTheme</a></li><li><a href="SystemThemeService.html">SystemThemeService</a></li><li><a href="SystemeJeu.html">SystemeJeu</a></li><li><a href="Temoignage.html">Temoignage</a></li><li><a href="TemoignageService.html">TemoignageService</a></li><li><a href="TemplateService.html">TemplateService</a></li><li><a href="TownDocument.html">TownDocument</a></li><li><a href="Utilisateur.html">Utilisateur</a></li><li><a href="UtilisateurService.html">UtilisateurService</a></li><li><a href="VoteController.html">VoteController</a></li><li><a href="VoteService.html">VoteService</a></li><li><a href="ZombiologyTheme.html">ZombiologyTheme</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Joi">Joi</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#auth">auth</a></li><li><a href="global.html#compareVersions">compareVersions</a></li><li><a href="global.html#createError">createError</a></li><li><a href="global.html#createMigrationsTable">createMigrationsTable</a></li><li><a href="global.html#createTables">createTables</a></li><li><a href="global.html#database">database</a></li><li><a href="global.html#executeMigration">executeMigration</a></li><li><a href="global.html#getCurrentVersion">getCurrentVersion</a></li><li><a href="global.html#getErrorMessage">getErrorMessage</a></li><li><a href="global.html#getExecutedMigrations">getExecutedMigrations</a></li><li><a href="global.html#getMigrationStatus">getMigrationStatus</a></li><li><a href="global.html#getVersionsToMigrate">getVersionsToMigrate</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#handleNotFound">handleNotFound</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#isDatabaseInitialized">isDatabaseInitialized</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#markMigrationExecuted">markMigrationExecuted</a></li><li><a href="global.html#migrateDatabase">migrateDatabase</a></li><li><a href="global.html#migrateToLatest">migrateToLatest</a></li><li><a href="global.html#migrateToVersion">migrateToVersion</a></li><li><a href="global.html#migrations">migrations</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#path">path</a></li><li><a href="global.html#requireAdmin">requireAdmin</a></li><li><a href="global.html#requireAuth">requireAuth</a></li><li><a href="global.html#requirePremium">requirePremium</a></li><li><a href="global.html#resetDatabase">resetDatabase</a></li><li><a href="global.html#rollbackMigration">rollbackMigration</a></li><li><a href="global.html#schemas">schemas</a></li><li><a href="global.html#updateAppVersion">updateAppVersion</a></li><li><a href="global.html#validateFiles">validateFiles</a></li><li><a href="global.html#validateRequest">validateRequest</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Aug 08 2025 18:17:39 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
