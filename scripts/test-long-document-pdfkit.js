#!/usr/bin/env node

const BasePdfKitService = require('../src/services/BasePdfKitService');
const MarkdownService = require('../src/services/MarkdownService');
const SystemRightsService = require('../src/services/SystemRightsService');
const fs = require('fs');
const fsPromises = require('fs').promises;
const path = require('path');

/**
 * Test sp√©cifique pour un document long (> 5 pages) avec garde et TOC
 */
class LongDocumentGenerator extends BasePdfKitService {
    constructor() {
        super();
        this.markdownService = new MarkdownService();
    }

    async generateDocument(data, filePath) {
        // D√©finir le watermark/chapterTitle AVANT de cr√©er le document
        this.chapterTitle = data.watermark || data.titre || 'DOCUMENT LONG';
        
        // Pour les tests, forcer un document long AVANT de cr√©er le document
        console.log('üìã Pr√©paration d\'un document long avec garde et TOC');
        this.hasLongContentPages = true; // D√©finir AVANT createDocument
        
        const doc = this.createDocument({
            chapterTitle: this.chapterTitle
        });
        const stream = doc.pipe(fs.createWriteStream(filePath));
        
        // Initialiser les pages sp√©ciales
        this.initializeLongDocument(doc, data);
        
        // Ajouter une nouvelle page pour le contenu principal
        doc.addPage();
        
        // Utiliser la police par d√©faut
        doc.font('Times-Roman');
        
        // Titre principal
        if (data.titre) {
            this.addTitle(doc, data.titre, { fontSize: 18, addToToc: true, tocLevel: 1 });
        }
        
        // Introduction
        if (data.introduction) {
            doc.font('Times-Italic');
            this.addParagraph(doc, data.introduction);
            doc.font('Times-Roman');
        }
        
        // Sections
        for (const section of data.sections) {
            this.checkNewPage(doc, 100);
            
            // Titre de section
            this.addTitle(doc, section.titre, { fontSize: 14, marginTop: 15, addToToc: true, tocLevel: 1 });
            
            // Description de section
            if (section.description) {
                this.addParagraph(doc, section.description);
            }
            
            // Contenu de la section
            if (section.contenu) {
                for (const element of section.contenu) {
                    this.renderElement(doc, element);
                }
            }
        }
        
        console.log(`üìÑ Document final g√©n√©r√© avec ${this.currentPageNumber} pages totales`);
        
        // Finaliser le document
        doc.end();
        
        return new Promise((resolve, reject) => {
            stream.on('finish', resolve);
            stream.on('error', reject);
        });
    }
    
    renderElement(doc, element) {
        switch (element.type) {
            case 'paragraphe':
                this.checkNewPage(doc, 50);
                this.addParagraph(doc, element.texte);
                break;
                
            case 'liste':
                this.checkNewPage(doc, 100);
                this.addStarList(doc, element.items);
                break;
                
            case 'sous_section':
                this.checkNewPage(doc, 80);
                this.addTitle(doc, element.titre, { fontSize: 12, marginTop: 20, addToToc: true, tocLevel: 2 });
                if (element.description) {
                    this.addParagraph(doc, element.description);
                }
                if (element.elements) {
                    for (const subElement of element.elements) {
                        this.renderElement(doc, subElement);
                    }
                }
                break;
                
            case 'conseil':
            case 'attention':
            case 'exemple':
                this.checkNewPage(doc, 80);
                this.addBox(doc, element.type, element.texte);
                break;
                
            case 'separateur':
                this.checkNewPage(doc, 30);
                this.addSeparator(doc);
                break;
                
            default:
                console.warn(`Type d'√©l√©ment non g√©r√©: ${element.type}`);
        }
    }
}

async function testLongDocument() {
    console.log('üìö Test d\'un document long (> 5 pages) avec page de garde et TOC...\n');
    
    try {
        // Donn√©es pour un document volontairement long
        const data = {
            titre: "GUIDE COMPLET DE CR√âATION DE PERSONNAGE",
            sous_titre: "Manuel d√©taill√© pour ma√Ætres de jeu",
            auteur: "L'√©quipe de d√©veloppement",
            watermark: "GUIDE CR√âATION",
            introduction: "Ce guide complet vous accompagne dans toutes les √©tapes de cr√©ation de personnages pour vos parties de jeu de r√¥le. Il contient des conseils, des exemples et des techniques avanc√©es pour cr√©er des personnages m√©morables et √©quilibr√©s.",
            sections: [
                {
                    titre: "PREMI√àRE PARTIE : LES BASES",
                    description: "Cette section couvre les fondamentaux de la cr√©ation de personnage.",
                    contenu: [
                        {
                            type: "sous_section",
                            titre: "Comprendre le concept",
                            description: "Le concept est l'√¢me de votre personnage.",
                            elements: [
                                {
                                    type: "paragraphe",
                                    texte: "Un bon concept de personnage doit √™tre √† la fois original et cr√©dible dans l'univers de jeu. Il faut √©viter les st√©r√©otypes tout en restant coh√©rent avec le genre et le ton de la campagne."
                                },
                                {
                                    type: "liste",
                                    items: [
                                        "D√©finir une motivation principale claire et forte",
                                        "Cr√©er un background coh√©rent avec l'univers",
                                        "√âtablir des liens avec le monde et les autres personnages",
                                        "Pr√©voir des axes de d√©veloppement pour l'√©volution"
                                    ]
                                },
                                {
                                    type: "conseil",
                                    texte: "Commencez toujours par une phrase simple qui r√©sume votre personnage. Par exemple : 'Un ancien soldat hant√© par ses d√©mons qui cherche la r√©demption'."
                                }
                            ]
                        },
                        {
                            type: "sous_section",
                            titre: "Les attributs de base",
                            description: "Comment r√©partir efficacement les caract√©ristiques.",
                            elements: [
                                {
                                    type: "paragraphe",
                                    texte: "La r√©partition des attributs doit refl√©ter le concept de votre personnage tout en restant viable m√©caniquement. √âvitez de cr√©er un personnage parfait - les faiblesses cr√©ent des opportunit√©s de roleplay."
                                },
                                {
                                    type: "attention",
                                    texte: "Ne n√©gligez jamais les attributs secondaires ! Ils peuvent souvent faire la diff√©rence dans des situations inattendues."
                                }
                            ]
                        }
                    ]
                },
                {
                    titre: "DEUXI√àME PARTIE : TECHNIQUES AVANC√âES",
                    description: "Pour les cr√©ateurs exp√©riment√©s qui veulent aller plus loin.",
                    contenu: [
                        {
                            type: "paragraphe",
                            texte: "Cette section s'adresse aux joueurs exp√©riment√©s qui ma√Ætrisent d√©j√† les bases et souhaitent explorer des techniques plus sophistiqu√©es de cr√©ation de personnage."
                        },
                        {
                            type: "sous_section",
                            titre: "Psychologie du personnage",
                            description: "Cr√©er une personnalit√© complexe et nuanc√©e.",
                            elements: [
                                {
                                    type: "paragraphe",
                                    texte: "Un personnage m√©morable poss√®de une psychologie coh√©rente mais complexe. Il doit avoir des contradictions internes, des peurs, des d√©sirs cach√©s et des traits qui √©voluent au fil de l'histoire."
                                },
                                {
                                    type: "liste",
                                    items: [
                                        "D√©finir au moins trois traits de personnalit√© majeurs",
                                        "Cr√©er des contradictions internes r√©alistes",
                                        "√âtablir des peurs et des phobies cr√©dibles",
                                        "Pr√©voir des d√©clencheurs √©motionnels sp√©cifiques"
                                    ]
                                }
                            ]
                        },
                        {
                            type: "separateur"
                        },
                        {
                            type: "sous_section",
                            titre: "Relations interpersonnelles",
                            description: "Tisser des liens significatifs avec l'univers.",
                            elements: [
                                {
                                    type: "paragraphe",
                                    texte: "Les relations de votre personnage avec le monde qui l'entoure sont essentielles pour son int√©gration dans l'histoire. Ces liens cr√©ent des opportunit√©s narratives et des leviers dramatiques pour le ma√Ætre de jeu."
                                },
                                {
                                    type: "exemple",
                                    texte: "Marcus entretient une relation compliqu√©e avec son ancien mentor qui l'a trahi. Cette relation peut √™tre utilis√©e pour cr√©er des dilemmes moraux et des moments de tension durant la campagne."
                                }
                            ]
                        }
                    ]
                },
                {
                    titre: "TROISI√àME PARTIE : EXEMPLES PRATIQUES",
                    description: "Des cas concrets d'application des techniques pr√©sent√©es.",
                    contenu: [
                        {
                            type: "paragraphe",
                            texte: "Cette section pr√©sente plusieurs exemples de personnages cr√©√©s en suivant les m√©thodes d√©crites dans ce guide. Chaque exemple illustre diff√©rentes approches et techniques."
                        },
                        {
                            type: "sous_section",
                            titre: "Le guerrier atypique",
                            description: "Subvertir les clich√©s du combattant classique.",
                            elements: [
                                {
                                    type: "paragraphe",
                                    texte: "Elara Ventacier n'est pas votre guerri√®re typique. Ancienne biblioth√©caire reconvertie en aventuri√®re apr√®s la destruction de sa ville natale, elle combine intelligence tactique et d√©termination farouche."
                                },
                                {
                                    type: "liste",
                                    items: [
                                        "Background : Biblioth√©caire devenue guerri√®re par n√©cessit√©",
                                        "Motivation : Prot√©ger les connaissances et les innocents",
                                        "Particularit√© : Combat en analysant les faiblesses",
                                        "Faiblesse : Perfectionnisme qui peut la paralyser"
                                    ]
                                }
                            ]
                        },
                        {
                            type: "sous_section",
                            titre: "Le mage pragmatique",
                            description: "Une approche terre-√†-terre de la magie.",
                            elements: [
                                {
                                    type: "paragraphe",
                                    texte: "Contrairement aux arch√©types de magiciens mystiques et d√©tach√©s, Tobias Ferrum voit la magie comme un outil pratique. Ancien ing√©nieur, il applique une m√©thode scientifique √† l'art mystique."
                                },
                                {
                                    type: "conseil",
                                    texte: "Un personnage qui aborde son domaine d'expertise de mani√®re inattendue peut cr√©er des situations de jeu tr√®s int√©ressantes et originales."
                                }
                            ]
                        }
                    ]
                },
                {
                    titre: "QUATRI√àME PARTIE : √âVOLUTION ET D√âVELOPPEMENT",
                    description: "Faire √©voluer votre personnage au fil des aventures.",
                    contenu: [
                        {
                            type: "paragraphe",
                            texte: "Un personnage n'est jamais fig√©. L'√©volution fait partie int√©grante de l'exp√©rience de jeu de r√¥le. Cette section explore comment planifier et g√©rer cette √©volution de mani√®re satisfaisante."
                        },
                        {
                            type: "sous_section",
                            titre: "Arcs narratifs personnels",
                            description: "Structurer l'√©volution de votre personnage.",
                            elements: [
                                {
                                    type: "paragraphe",
                                    texte: "Chaque personnage devrait avoir son propre arc narratif, une progression personnelle qui s'entrem√™le avec l'intrigue principale. Cet arc doit avoir un d√©but, un d√©veloppement et une r√©solution satisfaisante."
                                },
                                {
                                    type: "attention",
                                    texte: "Communiquez vos id√©es d'√©volution avec votre ma√Ætre de jeu. La collaboration est essentielle pour cr√©er des moments narratifs marquants."
                                }
                            ]
                        }
                    ]
                },
                {
                    titre: "CINQUI√àME PARTIE : CONSEILS POUR MJ",
                    description: "Accompagner vos joueurs dans leurs cr√©ations.",
                    contenu: [
                        {
                            type: "paragraphe",
                            texte: "En tant que ma√Ætre de jeu, votre r√¥le est d'accompagner les joueurs dans la cr√©ation de personnages qui s'int√®grent harmonieusement dans votre univers et votre campagne."
                        },
                        {
                            type: "liste",
                            items: [
                                "√âtablir des guidelines claires pour la cr√©ation",
                                "Encourager la cr√©ativit√© tout en maintenant la coh√©rence",
                                "Aider √† r√©soudre les conflits de concept entre joueurs",
                                "Pr√©voir des hooks narratifs pour chaque personnage"
                            ]
                        }
                    ]
                },
                {
                    titre: "SIXI√àME PARTIE : RESSOURCES ET OUTILS",
                    description: "Une bo√Æte √† outils pour la cr√©ation de personnages.",
                    contenu: [
                        {
                            type: "paragraphe",
                            texte: "Cette derni√®re section rassemble des outils pratiques, des tables de g√©n√©ration al√©atoire et des ressources pour enrichir vos cr√©ations de personnages."
                        },
                        {
                            type: "exemple",
                            texte: "Utilisez les g√©n√©rateurs de noms, les tables de traits de personnalit√© et les listes de motivations pour stimuler votre cr√©ativit√© quand l'inspiration fait d√©faut."
                        },
                        {
                            type: "sous_section",
                            titre: "Tables de g√©n√©ration al√©atoire",
                            description: "Des outils pour g√©n√©rer rapidement des √©l√©ments de personnage.",
                            elements: [
                                {
                                    type: "paragraphe",
                                    texte: "Les tables de g√©n√©ration al√©atoire sont d'excellents outils pour sortir de sa zone de confort cr√©ative. Elles permettent de d√©couvrir des combinaisons inattendues qui peuvent mener √† des personnages tr√®s originaux."
                                },
                                {
                                    type: "liste",
                                    items: [
                                        "Tables de traits physiques distinctifs",
                                        "G√©n√©rateurs de motivations et d'objectifs",
                                        "Listes de secrets et de traumatismes",
                                        "Tables de relations familiales complexes",
                                        "G√©n√©rateurs de manies et d'habitudes"
                                    ]
                                },
                                {
                                    type: "conseil",
                                    texte: "N'h√©sitez pas √† relancer plusieurs fois ou √† combiner diff√©rents r√©sultats jusqu'√† obtenir quelque chose qui vous inspire vraiment."
                                }
                            ]
                        },
                        {
                            type: "sous_section",
                            titre: "Outils d'analyse psychologique",
                            description: "Approfondir la psychologie de vos personnages.",
                            elements: [
                                {
                                    type: "paragraphe",
                                    texte: "Pour cr√©er des personnages psychologiquement coh√©rents, il est utile de s'appuyer sur des mod√®les √©tablis de psychologie. Ces outils vous aideront √† structurer la personnalit√© de vos cr√©ations."
                                },
                                {
                                    type: "attention",
                                    texte: "Ces outils sont des guides, pas des r√®gles absolues. La coh√©rence narrative prime toujours sur la fid√©lit√© aux mod√®les psychologiques."
                                }
                            ]
                        }
                    ]
                },
                {
                    titre: "SEPTI√àME PARTIE : √âTUDES DE CAS AVANC√âES",
                    description: "Analyses d√©taill√©es de personnages complexes.",
                    contenu: [
                        {
                            type: "paragraphe",
                            texte: "Cette section pr√©sente des analyses approfondies de personnages particuli√®rement r√©ussis, expliquant les techniques utilis√©es et les principes appliqu√©s dans leur cr√©ation."
                        },
                        {
                            type: "sous_section",
                            titre: "Le personnage √† double identit√©",
                            description: "G√©rer la complexit√© des identit√©s multiples.",
                            elements: [
                                {
                                    type: "paragraphe",
                                    texte: "Cassandra Nuit-et-Jour m√®ne une double vie : biblioth√©caire respect√©e le jour, voleuse d'√©lite la nuit. Cette dualit√© cr√©e des tensions internes fascinantes et offre de nombreuses opportunit√©s narratives."
                                },
                                {
                                    type: "liste",
                                    items: [
                                        "Motivations contradictoires entre les deux identit√©s",
                                        "Risques constants de d√©couverte et d'exposition",
                                        "D√©veloppement de comp√©tences compl√©mentaires",
                                        "Relations diff√©rentes selon l'identit√© active"
                                    ]
                                },
                                {
                                    type: "exemple",
                                    texte: "Quand Cassandra d√©couvre que la biblioth√®que poss√®de un grimoire vol√©, elle doit choisir entre ses deux identit√©s : le d√©noncer en tant que biblioth√©caire ou le voler en tant que cambrioleuse."
                                }
                            ]
                        },
                        {
                            type: "sous_section",
                            titre: "L'anti-h√©ros sympathique",
                            description: "Cr√©er un personnage moralement ambigu mais attachant.",
                            elements: [
                                {
                                    type: "paragraphe",
                                    texte: "Viktor Cendrerepr√©sente l'arch√©type de l'anti-h√©ros sympathique. Ancien assassin reconverti en protecteur d'orphelins, il incarne la r√©demption tout en conservant ses m√©thodes discutables."
                                },
                                {
                                    type: "conseil",
                                    texte: "L'astuce avec un anti-h√©ros est de montrer ses bonnes intentions malgr√© ses mauvaises m√©thodes. Le public pardonne beaucoup quand les motivations sont nobles."
                                }
                            ]
                        }
                    ]
                },
                {
                    titre: "HUITI√àME PARTIE : R√âF√âRENCES ET BIBLIOGRAPHIE",
                    description: "Sources d'inspiration et lectures recommand√©es.",
                    contenu: [
                        {
                            type: "paragraphe",
                            texte: "Cette section finale rassemble des r√©f√©rences utiles pour approfondir vos connaissances en cr√©ation de personnages et en psychologie narrative."
                        },
                        {
                            type: "liste",
                            items: [
                                "Ouvrages sur l'√©criture de fiction et la caract√©risation",
                                "Manuels de psychologie appliqu√©e √† la narration",
                                "Analyses de personnages dans la litt√©rature classique",
                                "Ressources en ligne pour cr√©ateurs de jeux de r√¥le"
                            ]
                        },
                        {
                            type: "separateur"
                        },
                        {
                            type: "paragraphe",
                            texte: "La cr√©ation de personnages est un art qui s'am√©liore avec la pratique et l'exp√©rience. Continuez √† exp√©rimenter, √† analyser vos cr√©ations et celles des autres, et surtout, amusez-vous ! Un personnage cr√©√© avec passion et r√©flexion marquera toujours plus les esprits qu'un concept techniquement parfait mais sans √¢me."
                        }
                    ]
                }
            ]
        };
        
        // G√©n√©rer le fichier PDF
        const systemRightsService = new SystemRightsService();
        const pdfPath = systemRightsService.generatePdfPath('test-long', null, 0, 'document-long-test', 'public');
        const filePath = path.join(__dirname, '..', pdfPath.fullPath);
        
        console.log(`üîß Test d'un document long (${data.sections.length} sections principales)`);
        console.log(`üìÇ Chemin : ${filePath}`);
        
        // S'assurer que le dossier existe
        await fsPromises.mkdir(path.dirname(filePath), { recursive: true });
        
        // G√©n√©rer le PDF
        const generator = new LongDocumentGenerator();
        await generator.generateDocument(data, filePath);
        
        console.log('‚úÖ PDF long g√©n√©r√© avec succ√®s !');
        console.log(`üìÅ Fichier : ${pdfPath.fileName}`);
        
        // V√©rifier la taille
        const stats = await fsPromises.stat(filePath);
        console.log(`üìè Taille : ${(stats.size / 1024).toFixed(2)} KB`);
        
        console.log('\nüîç Points √† v√©rifier dans le PDF :');
        console.log('- üìã Page de garde si > 5 pages');
        console.log('- üìë Table des mati√®res avec sections');
        console.log('- ‚úì Num√©rotation des pages correcte');
        console.log('- ‚úì Alternance des barres lat√©rales');
        
        console.log('\n‚ú® Test termin√© ! V√©rifiez le PDF g√©n√©r√©.');

    } catch (error) {
        console.error('‚ùå Erreur lors de la g√©n√©ration :', error);
        process.exit(1);
    }
}

// Lancer le test
testLongDocument().catch(console.error);